<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Solicitud de Comidas - Inter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Librerías para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Aplicar la fuente 'Inter' a todo el cuerpo del documento */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Definir colores personalizados basados en la marca Inter */
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .text-inter-primary { color: #005BAA; }
        .text-inter-accent-light { color: #5CE1E6; }
        .border-inter-primary { border-color: #005BAA; }
        .border-inter-accent-light { border-color: #5CE1E6; }
        .focus\:ring-inter-primary:focus { --tw-ring-color: #005BAA; }

        /* Ocultar el input de cantidad por defecto */
        .hidden-quantity {
            display: none;
        }
        
        /* Estilos para filtros avanzados */
        .filter-tag {
            background-color: #E3F2FD;
            color: #005BAA;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-flex;
            align-items: center;
        }
        
        .filter-tag-remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .filter-tag-remove:hover {
            color: #FF5252;
        }

        /* Estilos para el reporte en PDF */
        .report-pdf {
            background-color: white;
            padding: 10px;
            font-family: 'Inter', sans-serif;
        }
        
        .pdf-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #005BAA;
            padding-bottom: 8px;
        }
        
        .pdf-title {
            color: #005BAA;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .pdf-subtitle {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .pdf-section {
            margin-bottom: 12px;
            page-break-inside: avoid;
        }
        
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 6px;
            font-size: 7px;
        }
        
        .pdf-table th {
            background-color: #f0f7ff;
            color: #005BAA;
            font-weight: bold;
            padding: 4px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .pdf-table td {
            padding: 4px;
            border: 1px solid #ddd;
            font-size: 7px;
        }
        
        .pdf-table .total-row {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        
        .pdf-summary-box {
            border: 1px solid #ddd;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .pdf-footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 7px;
        }

        /* Estilos para pestañas de navegación */
        .tab-navigation {
            display: flex;
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            background: transparent;
            border: none;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .tab-button:hover {
            background-color: #e2e8f0;
            color: #005BAA;
        }
        
        .tab-button.active {
            background-color: #005BAA;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 91, 170, 0.2);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos para el selector de perfil */
        .profile-selector {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8fafc;
            border-radius: 8px;
        }
        
        .profile-selector label {
            font-weight: 600;
            color: #005BAA;
        }
        
        .profile-selector select {
            padding: 8px 12px;
            border: 1px solid #005BAA;
            border-radius: 6px;
            background-color: white;
            color: #333;
            font-weight: 500;
            cursor: pointer;
        }
        
        .profile-selector select:focus {
            outline: none;
            ring: 2px solid #005BAA;
        }

        /* Estilos para el login */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-box {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
        }
        
        .login-title {
            color: #005BAA;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #005BAA;
            ring: 2px solid #005BAA;
        }
        
        .login-button {
            width: 100%;
            padding: 12px;
            background-color: #005BAA;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .login-button:hover {
            background-color: #004080;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .remember-me input {
            margin-right: 8px;
        }
        
        .error-message {
            color: #dc2626;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        /* Ocultar elementos según perfil */
        .admin-only, .presidencia-only {
            display: none;
        }
        
        body[data-profile="admin"] .admin-only {
            display: block;
        }
        
        body[data-profile="admin"] .admin-only-inline {
            display: inline-block;
        }
        
        body[data-profile="presidencia"] .presidencia-only {
            display: block;
        }
        
        body[data-profile="presidencia"] .presidencia-only-inline {
            display: inline-block;
        }
        
        /* Ambos perfiles pueden ver y usar acciones de tabla */
        .action-cell {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center" data-profile="admin">
    <!-- Login Modal -->
    <div id="loginModal" class="login-container">
        <div class="login-box">
            <div class="login-title">Control de Solicitud de Comidas</div>
            <div class="mb-4 text-center text-gray-600">Seleccione su perfil y ingrese su contraseña</div>
            
            <select id="loginProfile" class="login-input">
                <option value="admin">Administrador</option>
                <option value="presidencia">Presidencia</option>
            </select>
            
            <input type="password" id="loginPassword" class="login-input" placeholder="Contraseña" autocomplete="current-password">
            
            <div class="remember-me">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Recordar mi sesión</label>
            </div>
            
            <div id="loginError" class="error-message hidden"></div>
            
            <button id="loginButton" class="login-button">Ingresar</button>
        </div>
    </div>

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-4 md:p-8 mb-8 container-responsive">
        <!-- Selector de Perfil (solo visible después del login) -->
        <div class="profile-selector" id="profileSelector" style="display: none;">
            <label for="profileSelect">Perfil de Usuario:</label>
            <select id="profileSelect" class="border border-inter-primary rounded-md px-3 py-2">
                <option value="admin">Administrador</option>
                <option value="presidencia">Presidencia</option>
            </select>
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Cerrar Sesión
            </button>
        </div>

        <header class="text-center mb-4 md:mb-6 bg-inter-primary rounded-t-xl py-4 md:py-6 relative overflow-hidden">
            <h1 class="text-2xl md:text-4xl font-extrabold text-white mb-1 md:mb-2 relative z-10 px-2">
                Control de Solicitud de Comidas
            </h1>
            <p class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-lg md:text-2xl font-extrabold text-white opacity-10 whitespace-nowrap select-none pointer-events-none z-0 hidden md:block">
                Inter Tu mundo, nuestro compromiso.
            </p>
            <p class="text-sm md:text-md text-white mt-1 md:mt-2 relative z-10 px-2">Registro y gestión de solicitudes de comidas para el personal</p>
        </header>

        <!-- Pestañas de navegación -->
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button admin-only" data-tab="financial-reports">Reportes Financieros</button>
        </nav>

        <!-- Contenido de Dashboard -->
        <div id="dashboard-tab" class="tab-content active">
            <section class="mb-6 md:mb-8 p-4 md:p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-3 md:mb-4">Registrar Nueva Solicitud de Comida</h2>
                <form id="foodRequestForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                    
                    <div id="departmentField">
                        <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                            Departamento/Área
                        </label>
                        <select id="department" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                            <option value="" disabled selected>Selecciona un Departamento</option>
                            <option value="Administracion">Administración</option>
                            <option value="Area Comercial">Área Comercial</option>
                            <option value="C.O El Rosal">C.O El Rosal</option>
                            <option value="C.O La Naya">C.O La Naya</option>
                            <option value="C.O Los Ruices">C.O Los Ruices</option>
                            <option value="C.O Paraiso-Catia">C.O Paraiso-Catia</option>
                            <option value="Gerencia Senior">Gerencia Senior</option>
                            <option value="Head End">Head End</option>
                            <option value="MSO">MSO</option>
                            <option value="Ocad">Ocad</option>
                            <option value="Obras">Obras</option>
                        </select>
                    </div>
                    
                    <!-- Campo de observaciones para MSO -->
                    <div id="msoObservationsContainer" class="hidden">
                        <label for="msoObservations" class="block text-sm font-medium text-gray-700 mb-1">
                            Departamento MSO específico
                        </label>
                        <select id="msoObservations"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                            <option value="" selected>Selecciona departamento MSO</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Presidencia">Presidencia</option>
                            <option value="Interconexiones">Interconexiones</option>
                            <option value="Importaciones">Importaciones</option>
                            <option value="RRHH MSO">RRHH MSO</option>
                            <option value="Documentacion de obras">Documentación de obras</option>
                            <option value="Logistica">Logística</option>
                            <option value="Personal Visitante">Personal Visitante</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="mealType" class="block text-sm font-medium text-gray-700 mb-1">
                            Tipo de Comida
                        </label>
                        <select id="mealType" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                            <option value="" disabled selected>Selecciona el Tipo</option>
                            <option value="Desayuno">Desayuno</option>
                            <option value="Almuerzo">Almuerzo</option>
                            <option value="Cena">Cena</option>
                            <option value="Refrigerios">Refrigerios</option>
                        </select>
                    </div>
                    <div>
                        <label for="event" class="block text-sm font-medium text-gray-700 mb-1">
                            Evento
                        </label>
                        <select id="event"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                            <option value="" disabled selected>Selecciona un Evento</option>
                            <option value="Evento extraordinario">Evento extraordinario</option>
                            <option value="Corte de fibra">Corte de fibra</option>
                            <option value="Mantenimiento de red">Mantenimiento de red</option>
                            <option value="Feeder y obras">Feeder y obras</option>
                            <option value="Ventas en calle">Ventas en calle</option>
                            <option value="Ventana de mantenimiento">Ventana de mantenimiento</option>
                            <option value="Transporte y flota">Transporte y flota</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>

                    <!-- Personal Externo - Solo visible para admin -->
                    <div class="col-span-1 admin-only">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Personal Externo</label>
                        <div class="space-y-1 md:space-y-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="checkCANTV" name="externalStaff" value="CANTV" class="form-checkbox h-5 w-5 md:h-4 md:w-4 text-inter-primary rounded">
                                    <label for="checkCANTV" class="text-gray-700 text-sm md:text-base">CANTV</label>
                                </div>
                                <input type="number" id="quantityCANTV" min="0" value="0"
                                       class="w-16 md:w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                       placeholder="Cant">
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="checkEDC" name="externalStaff" value="EDC" class="form-checkbox h-5 w-5 md:h-4 md:w-4 text-inter-primary rounded">
                                    <label for="checkEDC" class="text-gray-700 text-sm md:text-base">EDC</label>
                                </div>
                                <input type="number" id="quantityEDC" min="0" value="0"
                                       class="w-16 md:w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                       placeholder="Cant">
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="checkExternalOthers" name="externalStaff" value="ExternalOthers" class="form-checkbox h-5 w-5 md:h-4 md:w-4 text-inter-primary rounded">
                                    <label for="checkExternalOthers" class="text-gray-700 text-sm md:text-base">Otros</label>
                                </div>
                                <input type="number" id="quantityExternalOthers" min="0" value="0"
                                       class="w-16 md:w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                       placeholder="Cant">
                            </div>
                        </div>
                    </div>

                    <!-- Personal Inter - Solo visible para admin -->
                    <div class="col-span-1 admin-only">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Personal Inter</label>
                        <div class="relative">
                            <input type="text" id="interStaffSearch" placeholder="Buscar personal de Inter..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                            <ul id="interStaffSearchResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                        </div>
                        <ul id="interStaffSelected" class="mt-2 space-y-1 md:space-y-2 max-h-32 overflow-y-auto">
                            </ul>
                    </div>

                    <!-- Contador de comidas - Visible para todos los perfiles -->
                    <div class="col-span-1">
                        <label for="totalQuantity" class="block text-sm font-medium text-gray-700 mb-1">
                            Total de Comidas
                        </label>
                        <input type="number" id="totalQuantity" min="0" value="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                    </div>
                    
                    <div class="col-span-1 md:col-span-2">
                        <label for="deliveryPlace" class="block text-sm font-medium text-gray-700 mb-1">
                            Lugar de Entrega
                        </label>
                        <input type="text" id="deliveryPlace" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                               placeholder="Ej. Administración, Sede Principal, Campo (con dirección)">
                    </div>
                    <div>
                        <label for="deliveryDateTime" class="block text-sm font-medium text-gray-700 mb-1">
                            Fecha de Entrega
                        </label>
                        <input type="date" id="deliveryDateTime" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                    </div>
                    <div>
                        <label for="unitCost" class="block text-sm font-medium text-gray-700 mb-1">
                            Costo Unitario Comida (USD $)
                        </label>
                        <input type="number" id="unitCost" step="0.01" min="0" value="0.00" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Costo de Delivery
                        </label>
                        <div class="flex items-center space-x-3 md:space-x-4 mb-2">
                            <label class="inline-flex items-center">
                                <input type="radio" name="deliveryOption" value="free" checked
                                       class="form-radio text-inter-primary h-4 w-4 md:h-4 md:w-4" id="deliveryFree">
                                <span class="ml-2 text-gray-700 text-sm md:text-base">Gratuito</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="deliveryOption" value="cost"
                                       class="form-radio text-inter-primary h-4 w-4 md:h-4 md:w-4" id="deliveryCostOption">
                                <span class="ml-2 text-gray-700 text-sm md:text-base">Con costo</span>
                            </label>
                        </div>
                        <input type="number" id="deliveryCost" step="0.01" min="0" value="0.00"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary hidden text-sm md:text-base"
                               placeholder="Costo de Delivery ($)">
                    </div>
                    <div>
                        <label for="cost" class="block text-sm font-medium text-gray-700 mb-1">
                            Costo Total (USD $)
                        </label>
                        <input type="number" id="cost" step="0.01" min="0" value="0.00" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary bg-gray-100 cursor-not-allowed text-sm md:text-base">
                    </div>
                    <div>
                        <label for="providerName" class="block text-sm font-medium text-gray-700 mb-1">
                            Nombre del Proveedor
                        </label>
                        <select id="providerName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                            <option value="" disabled selected>Selecciona un Proveedor</option>
                            <option value="Monteluso">Monteluso</option>
                            <option value="Susi fresh">Susi fresh</option>
                            <option value="Cumbes Barlovento">Cumbes Barlovento</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-3">
                        <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">
                            Motivo de la Solicitud (Obligatorio para justificar)
                        </label>
                        <textarea id="reason" rows="3" required
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                                     placeholder="Ej. Personal de Área Técnica trabajando en proyecto X fuera de horario, Área Comercial en visita a cliente en Y."></textarea>
                    </div>
                    <div class="col-span-1 md:col-span-3 flex flex-col sm:flex-row justify-end items-center gap-3 md:gap-4" id="formActions">
                        <button type="submit"
                                class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-4 md:py-2 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                            Registrar Solicitud
                        </button>
                        </div>
                </form>
                <div id="messageBox" class="mt-4 p-3 rounded-md text-sm hidden"></div>
            </section>

            <section class="mb-6 md:mb-8 p-4 md:p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-3 md:mb-4">Resumen de Gastos de Comidas</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 text-center">
                    <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                        <h3 class="text-base md:text-lg font-semibold text-gray-700">Gastos Diarios</h3>
                        <p id="dailyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary mt-1 md:mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                        <h3 class="text-base md:text-lg font-semibold text-gray-700">Gastos Semanales</h3>
                        <p id="weeklyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary mt-1 md:mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                        <h3 class="text-base md:text-lg font-semibold text-gray-700">Gastos Mensuales</h3>
                        <p id="monthlyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary mt-1 md:mt-2">$0.00</p>
                    </div>
                </div>
            </section>

            <section class="p-4 md:p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
                <div class="flex justify-between items-center mb-3 md:mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-inter-primary">Historial de Solicitudes de Comida</h2>
                </div>

                <div class="mb-4 p-4 bg-blue-50 rounded-lg flex flex-col md:flex-row items-center gap-3 md:gap-4">
                    <div class="w-full">
                        <label for="filterInput" class="block text-sm font-medium text-gray-700 mb-2">
                            Filtros de Búsqueda Avanzada
                        </label>
                        <div class="flex flex-col sm:flex-row items-center gap-2 mb-2">
                            <input type="text" id="filterInput"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                                   placeholder="Buscar por nombre, departamento, tipo...">
                            <button id="addFilterBtn"
                                    class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto mt-2 sm:mt-0">
                                Añadir Filtro
                            </button>
                        </div>
                        
                        <div id="activeFilters" class="flex flex-wrap gap-2 mb-2">
                            <!-- Aquí se mostrarán los filtros activos -->
                        </div>
                        
                        <div class="flex flex-col sm:flex-row flex-wrap gap-2">
                            <button id="clearAllFiltersBtn"
                                    class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto">
                                Limpiar Todos los Filtros
                            </button>
                            <button id="exportCsvBtn"
                                    class="bg-inter-accent-light hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto">
                                Exportar a Excel (CSV)
                            </button>
                            <!-- Botón Eliminar Seleccionados - AHORA VISIBLE PARA AMBOS PERFILES -->
                            <button id="deleteSelectedBtn"
                                    class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto">
                                Eliminar Seleccionados
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vista normal de tabla para desktop -->
                <div id="tableView" class="overflow-x-auto rounded-lg shadow-md hidden md:block">
                    <table id="foodTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <!-- Checkbox de selección - AHORA VISIBLE PARA AMBOS PERFILES -->
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllCheckboxes" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Depto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Tipo</th>
                                <!-- Columnas de personal - Solo visibles para admin -->
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider admin-only">Ext.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider admin-only">Inter</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Total</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-inter-primary uppercase tracking-wider">Acciones</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-inter-primary uppercase tracking-wider">Aprobado por</th>
                            </tr>
                        </thead>
                        <tbody id="foodTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Los datos se llenarán dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <p id="noRequestsMessage" class="text-center text-gray-500 mt-4 hidden">No hay solicitudes de comida registradas aún.</p>
            </section>
        </div>

        <!-- Contenido de Reportes Financieros (solo visible para admin) -->
        <div id="financial-reports-tab" class="tab-content admin-only">
            <!-- NUEVA SECCIÓN: REPORTE MENSUAL DE GASTOS -->
            <section class="mb-6 md:mb-8 p-4 md:p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-3 md:mb-4">Reporte de Gastos</h2>
                
                <div class="mb-4 md:mb-6">
                    <label for="reportPeriodType" class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Periodo
                    </label>
                    <div class="flex flex-col sm:flex-row flex-wrap items-center gap-3 md:gap-4 mb-4">
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="periodType" value="monthly" checked
                                       class="form-radio text-inter-primary h-4 w-4 md:h-4 md:w-4" id="periodMonthly">
                                <span class="ml-2 text-gray-700 text-sm md:text-base">Mensual</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="periodType" value="biweekly"
                                       class="form-radio text-inter-primary h-4 w-4 md:h-4 md:w-4" id="periodBiweekly">
                                <span class="ml-2 text-gray-700 text-sm md:text-base">Quincenal</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="monthlyFilter" class="filter-section">
                        <label for="reportMonth" class="block text-sm font-medium text-gray-700 mb-2">
                            Seleccionar Mes y Año
                        </label>
                        <div class="flex flex-col sm:flex-row flex-wrap items-center gap-3 md:gap-4">
                            <input type="month" id="reportMonth" 
                                   class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary w-full sm:w-auto text-sm md:text-base"
                                   value="">
                        </div>
                    </div>
                    
                    <div id="biweeklyFilter" class="filter-section hidden">
                        <label for="biweekStartDate" class="block text-sm font-medium text-gray-700 mb-2">
                            Seleccionar Periodo Quincenal
                        </label>
                        <div class="flex flex-col sm:flex-row flex-wrap items-center gap-3 md:gap-4">
                            <input type="date" id="biweekStartDate" 
                                   class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary w-full sm:w-auto text-sm md:text-base"
                                   value="">
                            <span class="text-gray-700">a</span>
                            <input type="date" id="biweekEndDate" 
                                   class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary w-full sm:w-auto text-sm md:text-base"
                                   value="">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Nota: Seleccione una fecha de inicio y otra de fin para el periodo quincenal (15 días aproximadamente).</p>
                    </div>
                    
                    <div class="mt-4 flex flex-col sm:flex-row flex-wrap items-center gap-3 md:gap-4">
                        <button id="generateReportBtn" 
                                class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto">
                            Generar Reporte
                        </button>
                        <button id="exportReportBtn" 
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out hidden whitespace-nowrap w-full sm:w-auto">
                            Exportar a Excel
                        </button>
                        <button id="exportPdfBtn" 
                                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out hidden whitespace-nowrap w-full sm:w-auto">
                            Exportar a PDF
                        </button>
                    </div>
                </div>

                <!-- Contenedor oculto para el PDF -->
                <div id="pdfContent" class="hidden">
                    <!-- Este contenido se generará dinámicamente para el PDF -->
                </div>

                <div id="reportContent" class="space-y-6 md:space-y-8">
                    <!-- Sección 1: Solicitud de Comidas por Unidad de Operación -->
                    <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4">SOLICITUD DE COMIDAS POR UNIDAD DE OPERACIONES</h3>
                        <div class="responsive-table-container">
                            <table class="min-w-full divide-y divide-gray-200 border border-gray-300 text-sm">
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            UNIDAD DE OPERACION
                                        </th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            CANTIDAD
                                        </th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            IMPORTE
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="departmentReportBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Los datos se llenarán dinámicamente -->
                                </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-gray-900 border border-gray-300">
                                            TOTAL
                                        </td>
                                        <td id="totalDepartmentMeals" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                            0
                                        </td>
                                        <td id="totalDepartmentAmount" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                            $0.00
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Sección 2: Solicitud de Comidas por Proveedor -->
                    <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4">SOLICITUD DE COMIDAS POR PROVEEDOR</h3>
                        <div class="responsive-table-container">
                            <table class="min-w-full divide-y divide-gray-200 border border-gray-300 text-sm">
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            PROVEEDOR
                                        </th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            CANTIDAD
                                        </th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            IMPORTE
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="providerReportBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Los datos se llenarán dinámicamente -->
                                </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-gray-900 border border-gray-300">
                                            TOTAL
                                        </td>
                                        <td id="totalProviderMeals" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                            0
                                        </td>
                                        <td id="totalProviderAmount" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                            $0.00
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Sección 3: Resumen por Tipo de Unidad -->
                    <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4">RESUMEN POR TIPO DE UNIDAD</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                            <div class="bg-white p-3 md:p-4 rounded-lg border border-gray-300">
                                <h4 class="text-base md:text-lg font-semibold text-gray-700 mb-1 md:mb-2">UNIDAD CCS</h4>
                                <div class="space-y-1 md:space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 text-sm md:text-base">Total Comidas:</span>
                                        <span id="ccsTotalMeals" class="font-bold text-inter-primary text-sm md:text-base">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 text-sm md:text-base">Importe Total:</span>
                                        <span id="ccsTotalAmount" class="font-bold text-inter-primary text-sm md:text-base">$0.00</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-3 md:p-4 rounded-lg border border-gray-300">
                                <h4 class="text-base md:text-lg font-semibold text-gray-700 mb-1 md:mb-2">UNIDAD MSO</h4>
                                <div class="space-y-1 md:space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 text-sm md:text-base">Total Comidas:</span>
                                        <span id="msoTotalMeals" class="font-bold text-inter-primary text-sm md:text-base">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 text-sm md:text-base">Importe Total:</span>
                                        <span id="msoTotalAmount" class="font-bold text-inter-primary text-sm md:text-base">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 md:mt-4 pt-3 md:pt-4 border-t border-gray-300">
                            <div class="flex justify-between items-center">
                                <span class="text-base md:text-lg font-bold text-gray-700">Total:</span>
                                <span id="grandTotalAmount" class="text-xl md:text-2xl font-extrabold text-inter-primary">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 4: Servicios por Unidad y Proveedor -->
                    <div class="bg-gray-50 p-3 md:p-4 rounded-lg mt-4 md:mt-6">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4">
                            SERVICIOS POR UNIDAD Y PROVEEDOR
                        </h3>
                        <div class="responsive-table-container">
                            <table class="min-w-full divide-y divide-gray-200 border border-gray-300 text-sm">
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            UNIDAD
                                        </th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            PROVEEDOR
                                        </th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            CANTIDAD
                                        </th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                            IMPORTE
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="unitProviderReportBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Los datos se llenarán dinámicamente -->
                                </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td colspan="2" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-gray-900 border border-gray-300">
                                            TOTAL GENERAL
                                        </td>
                                        <td id="totalUnitProviderMeals" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                            0
                                        </td>
                                        <td id="totalUnitProviderAmount" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                            $0.00
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="mt-6 md:mt-8 p-4 md:p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-3 md:mb-4">Análisis de Gastos</h2>

                <div class="mb-4 md:mb-6">
                    <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Gastos Mensuales (Mes Actual)</h3>
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                        <div class="w-full h-48 md:h-64">
                            <canvas id="monthlyProvidersChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="mb-4 md:mb-6">
                    <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Gastos Anuales por Proveedor</h3>
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                        <div class="w-full h-48 md:h-64">
                            <canvas id="annualProvidersChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4 md:mb-6">
                    <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Comportamiento de Gastos Mensual por Departamento</h3>
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                        <div class="w-full h-64 md:h-96">
                            <canvas id="departmentExpensesChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4 md:mb-6">
                    <h3 id="staffRequestsChartTitle" class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Cantidad de Solicitudes por Empleado de Inter</h3>
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                        <div class="w-full max-w-xl h-64 md:h-96 mx-auto">
                            <canvas id="staffRequestsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="mb-4 md:mb-6">
                    <h3 id="departmentRequestsChartTitle" class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Cantidad de Solicitudes por Departamento</h3>
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                        <div class="w-full max-w-xl h-48 md:h-64 mx-auto">
                            <canvas id="departmentRequestsChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-3 md:mb-4">Confirmar Eliminación</h3>
            <p class="mb-3 md:mb-4 text-sm md:text-base" id="modalText">¿Estás seguro de que quieres eliminar la(s) solicitud(es) seleccionada(s)? Esta acción no se puede deshacer.</p>
            <div class="flex flex-col sm:flex-row justify-end gap-3 md:gap-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Cancelar</button>
                <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            deleteDoc, 
            doc, 
            query, 
            orderBy,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDwGgTGRkaEO4SzVR-5KqM3K66Istba0a4",
            authDomain: "control-solicitudes-de-comida.firebaseapp.com",
            projectId: "control-solicitudes-de-comida",
            storageBucket: "control-solicitudes-de-comida.firebasestorage.app",
            messagingSenderId: "255909685257",
            appId: "1:255909685257:web:98e9d0697b374fdf32b0d8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Hacer las funciones de Firebase disponibles globalmente
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseFunctions = {
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            query,
            orderBy,
            where
        };

        console.log("Firebase inicializado correctamente");
    </script>

    <script>
        // Variables globales para Firebase
        let db;
        let firebaseFunctions;

        // Referencias a jsPDF (disponible globalmente)
        const { jsPDF } = window.jspdf;

        // Variable para controlar el perfil actual
        let currentProfile = 'admin';
        let isLoggedIn = false;

        // Contraseñas por perfil
        const PASSWORDS = {
            admin: 'Admin1234',
            presidencia: 'Inter1234'
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si hay sesión guardada
            const savedProfile = localStorage.getItem('savedProfile');
            if (savedProfile) {
                // Auto-login
                currentProfile = savedProfile;
                document.body.setAttribute('data-profile', currentProfile);
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('profileSelector').style.display = 'flex';
                document.getElementById('profileSelect').value = currentProfile;
                
                // Inicializar la aplicación después del login
                setTimeout(async () => {
                    await initializeApplication();
                }, 100);
            } else {
                // Mostrar modal de login
                document.getElementById('loginModal').style.display = 'flex';
            }

            // Configurar evento de login
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            
            // Configurar evento de Enter en el campo de contraseña
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // Configurar evento de logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Configurar selector de perfil - AHORA SOLICITA CONTRASEÑA
            document.getElementById('profileSelect').addEventListener('change', function() {
                if (isLoggedIn) {
                    const newProfile = this.value;
                    const currentProfileValue = currentProfile;
                    
                    // Si selecciona un perfil diferente al actual, cerrar sesión
                    if (newProfile !== currentProfileValue) {
                        if (confirm('¿Desea cambiar de perfil? Se cerrará su sesión actual y deberá iniciar sesión nuevamente.')) {
                            handleLogout();
                        } else {
                            // Revertir la selección al perfil actual
                            this.value = currentProfileValue;
                        }
                    }
                }
            });
        });

        function handleLogin() {
            const profile = document.getElementById('loginProfile').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const errorElement = document.getElementById('loginError');

            // Validar contraseña
            if (password === PASSWORDS[profile]) {
                // Login exitoso
                isLoggedIn = true;
                currentProfile = profile;
                document.body.setAttribute('data-profile', profile);
                
                // Guardar sesión si se seleccionó "Recordar"
                if (rememberMe) {
                    localStorage.setItem('savedProfile', profile);
                } else {
                    localStorage.removeItem('savedProfile');
                }

                // Ocultar modal de login
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('profileSelector').style.display = 'flex';
                
                // Establecer valor del selector de perfil
                document.getElementById('profileSelect').value = profile;

                // Inicializar la aplicación
                setTimeout(async () => {
                    await initializeApplication();
                }, 100);

                errorElement.classList.add('hidden');
            } else {
                // Login fallido
                errorElement.textContent = 'Contraseña incorrecta';
                errorElement.classList.remove('hidden');
            }
        }

        function handleLogout() {
            isLoggedIn = false;
            currentProfile = 'admin';
            localStorage.removeItem('savedProfile');
            
            // Mostrar modal de login
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('profileSelector').style.display = 'none';
            
            // Limpiar campos
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
            
            // Establecer el perfil por defecto en el login
            document.getElementById('loginProfile').value = 'admin';
            
            // Recargar la página para limpiar todos los datos
            location.reload();
        }

        async function initializeApplication() {
            // Esperar a que Firebase esté listo
            if (!window.firebaseDb || !window.firebaseFunctions) {
                console.error("Firebase no se inicializó correctamente");
                displayMessage('Error: Firebase no se pudo inicializar', 'error');
                return;
            }

            // Asignar las referencias de Firebase
            db = window.firebaseDb;
            firebaseFunctions = window.firebaseFunctions;

            console.log("Firebase configurado correctamente en la aplicación");

            // Configurar navegación por pestañas
            setupTabNavigation();
            
            // Inicializar el resto de la aplicación
            await initializeAppContent();
        }

        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remover clase activa de todos los botones
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // Remover clase activa de todos los contenidos
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Agregar clase activa al botón clickeado
                    button.classList.add('active');
                    
                    // Mostrar el contenido correspondiente
                    const tabId = button.getAttribute('data-tab');
                    const tabContent = document.getElementById(`${tabId}-tab`);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                    
                    // Si es la pestaña de reportes y es admin, generar los gráficos
                    if (tabId === 'financial-reports' && currentProfile === 'admin') {
                        setTimeout(() => {
                            if (typeof updateCharts === 'function') {
                                updateCharts();
                            }
                        }, 100);
                    }
                });
            });
        }

        async function initializeAppContent() {
            const form = document.getElementById('foodRequestForm');
            const departmentSelect = document.getElementById('department');
            const msoObservationsContainer = document.getElementById('msoObservationsContainer');
            const msoObservationsSelect = document.getElementById('msoObservations');
            const mealTypeSelect = document.getElementById('mealType');
            const eventSelect = document.getElementById('event');

            // Referencias a los campos de personal externo
            const checkCANTV = document.getElementById('checkCANTV');
            const quantityCANTV = document.getElementById('quantityCANTV');
            const checkEDC = document.getElementById('checkEDC');
            const quantityEDC = document.getElementById('quantityEDC');
            const checkExternalOthers = document.getElementById('checkExternalOthers');
            const quantityExternalOthers = document.getElementById('quantityExternalOthers');
            const totalQuantityInput = document.getElementById('totalQuantity');

            // Nuevas referencias para el buscador de personal Inter
            const interStaffSearchInput = document.getElementById('interStaffSearch');
            const interStaffSearchResults = document.getElementById('interStaffSearchResults');
            const interStaffSelectedList = document.getElementById('interStaffSelected');
            
            // Referencias a campos de la solicitud
            const deliveryPlaceInput = document.getElementById('deliveryPlace');
            const deliveryDateTimeInput = document.getElementById('deliveryDateTime');
            const unitCostInput = document.getElementById('unitCost');
            const deliveryCostInput = document.getElementById('deliveryCost');
            const deliveryCostOption = document.getElementById('deliveryCostOption');
            const deliveryFree = document.getElementById('deliveryFree');
            const costInput = document.getElementById('cost');
            const providerNameSelect = document.getElementById('providerName');
            const reasonTextarea = document.getElementById('reason');
            const formActionsContainer = document.getElementById('formActions');

            // Referencias de la tabla e interfaz
            const tableBody = document.getElementById('foodTableBody');
            const noRequestsMessage = document.getElementById('noRequestsMessage');
            const messageBox = document.getElementById('messageBox');
            const tableView = document.getElementById('tableView');
            
            // Referencias para el filtro avanzado
            const filterInput = document.getElementById('filterInput');
            const addFilterBtn = document.getElementById('addFilterBtn');
            const activeFiltersContainer = document.getElementById('activeFilters');
            const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const selectAllCheckboxes = document.getElementById('selectAllCheckboxes');
            const submitButton = form.querySelector('button[type="submit"]');

            // Referencias para los modales
            const deleteModal = document.getElementById('deleteModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const modalText = document.getElementById('modalText');
            
            // Elementos para el resumen de gastos
            const dailyTotalEl = document.getElementById('dailyTotal');
            const weeklyTotalEl = document.getElementById('weeklyTotal');
            const monthlyTotalEl = document.getElementById('monthlyTotal');

            // Gráficos
            let monthlyProvidersChart = null;
            let annualProvidersChart = null;
            let departmentExpensesChart = null;
            let departmentRequestsChart = null;
            let staffRequestsChart = null;

            // Constantes y Variables Globales
            const CHART_COLORS = { 
                'Monteluso': '#5CE1E6',
                'Susi fresh': '#00B8D9',
                'Cumbes Barlovento': '#FF9800',
                'Al momento': '#005BAA',
                'otros': '#667EEA',
                'fondo': '#E2E8F0' 
            };
            
            let foodRequests = [];
            let selectedInterStaff = [];
            let editingRequestId = null;
            let activeFilters = [];
            
            // LISTA DE PERSONAL INTER
            const staffList = [
                { id: 1, name: "GALEA CESAR" },
                { id: 2, name: "CASTILLO TIBET" },
                { id: 3, name: "QUINTERO ROSANA" },
                { id: 4, name: "GONZALEZ LINO" },
                { id: 5, name: "MORILLO ANA" },
                { id: 6, name: "LEAL GREGORYS" },
                { id: 7, name: "DELGADO JONATHAN" },
                { id: 8, name: "VILLAMIZAR NANCY" },
                { id: 9, name: "BRITO RONEY" },
                { id: 10, name: "MUÑOZ KELVIN" },
                { id: 11, name: "CARTAYA LENNYIS" },
                { id: 12, name: "MORENO GEINES" },
                { id: 13, name: "SUAREZ KIR" },
                { id: 14, name: "MACHADO JOSE" },
                { id: 15, name: "GARCIA ANGELICA" },
                { id: 16, name: "VEGAS ENYMAR" },
                { id: 17, name: "CONTRERAS NOELIA" },
                { id: 18, name: "ARRAEZ JOSE" },
                { id: 19, name: "JIMENEZ DAIRELI" },
                { id: 20, name: "GOMEZ SAMUEL" },
                { id: 21, name: "LONGA JESUS" },
                { id: 22, name: "QUIJADA WILFREDO" },
                { id: 23, name: "PINO ALEJANDRO" },
                { id: 24, name: "TERAN CASTO" },
                { id: 25, name: "CHINCHILLA OSMEL" },
                { id: 26, name: "AMORUZO ANGELO" },
                { id: 27, name: "CARRERO JOSHUA" },
                { id: 28, name: "TOVAR JAIRO" },
                { id: 29, name: "PEREZ LUIS" },
                { id: 30, name: "BRITO JOSE" },
                { id: 31, name: "ASCANIO FELIX" },
                { id: 32, name: "HELLO ALBANY" },
                { id: 33, name: "CASTILLO JHOAN" },
                { id: 34, name: "RODRIGUEZ MISAEL" },
                { id: 35, name: "TORRES KEIVER" },
                { id: 36, name: "ORTA WILNER" },
                { id: 37, name: "TOVAR LUIS" },
                { id: 38, name: "FERRER GABRIEL" },
                { id: 39, name: "HOLGUIN DEYKER" },
                { id: 40, name: "CORONADO MIGUEL" },
                { id: 41, name: "PIRELA WILMER" },
                { id: 42, name: "CASTELLANOS FRANKLIN" },
                { id: 43, name: "GONZALEZ JUAN" },
                { id: 44, name: "JIMENEZ RONMEL" },
                { id: 45, name: "PRIETO JAVIER" },
                { id: 46, name: "LARA EDUARDO" },
                { id: 47, name: "CASTILLO ORIANA" },
                { id: 48, name: "GARRIDO ADOLFO" },
                { id: 49, name: "MORENO JOELIMAR" },
                { id: 50, name: "CENTENO LUIS" },
                { id: 51, name: "NEGRIN CARLOS" },
                { id: 52, name: "LADERA DAYANA" },
                { id: 53, name: "PEREZ NELSON" },
                { id: 54, name: "CHACON EDUARDO" },
                { id: 55, name: "UZCATEGUI DARWIN" },
                { id: 56, name: "VALENZUELA CARLOS" },
                { id: 57, name: "DIAZ ENNIO" },
                { id: 58, name: "MANRIQUE LUIS" },
                { id: 59, name: "TORRES CARLOS" },
                { id: 60, name: "LOPEZ JIM" },
                { id: 61, name: "RAMOS LISMAR" },
                { id: 62, name: "CHIRINOS RHONY" },
                { id: 63, name: "MORALES JOSUE" },
                { id: 64, name: "CASTILLO JUNIOR" },
                { id: 65, name: "VERGARA JORGE" },
                { id: 66, name: "DELGADO BRAYAN" },
                { id: 67, name: "REVERON ROGELIO" },
                { id: 68, name: "HERNANDEZ SERGIO" },
                { id: 69, name: "CEDEÑO LEONEL" },
                { id: 70, name: "UZCATEGUI BREINER" },
                { id: 71, name: "MALDONADO DYLAN" },
                { id: 72, name: "HERNANDEZ LUIS" },
                { id: 73, name: "MENESES KELVIS" },
                { id: 74, name: "HERNANDEZ RAFAEL" },
                { id: 75, name: "VILLAMIZAR YOHAN" },
                { id: 76, name: "CASTRO MANUEL" },
                { id: 77, name: "BRICEÑO ALEXY" },
                { id: 78, name: "ROCA YUNIOR" },
                { id: 79, name: "DIAZ MANUEL" },
                { id: 80, name: "ZERPA ODREIMY" },
                { id: 81, name: "RODRIGUEZ FELIX" },
                { id: 82, name: "GARCIA ANGEL" },
                { id: 83, name: "TONITO JULIO" },
                { id: 84, name: "GARCIA EDNEY" },
                { id: 85, name: "CASTRILLO MANUEL" },
                { id: 86, name: "GUERRERO GABRIEL" },
                { id: 87, name: "MATHEUS FERNANDO" },
                { id: 88, name: "GARCIA LUIS" },
                { id: 89, name: "VELASQUEZ JOSE" },
                { id: 90, name: "PERNETT CESAR" },
                { id: 91, name: "RODRIGUEZ OMAR" },
                { id: 92, name: "RAMIREZ DARWIN" },
                { id: 93, name: "YEMES GUILLERMO" },
                { id: 94, name: "BAZAN WILLIAMS" },
                { id: 95, name: "RAMIREZ FRANKLIN" },
                { id: 96, name: "LOPEZ JORGE" },
                { id: 97, name: "RAMOS ROBERT" },
                { id: 98, name: "GARCIA CARLOS" },
                { id: 99, name: "PALACIOS LUIS" },
                { id: 100, name: "MACHADO DANNY" },
                { id: 101, name: "ROMERO LUIS" },
                { id: 102, name: "RAMIREZ JOHN" },
                { id: 103, name: "MORA DYLAN" },
                { id: 104, name: "JULIO DANIEL" },
                { id: 105, name: "BARRETO ANDRES" },
                { id: 106, name: "CARVAJAL JOSE" },
                { id: 107, name: "PEREZ KEINER" },
                { id: 108, name: "GARCIA MENRY" },
                { id: 109, name: "MEJIA LUIS" },
                { id: 110, name: "CARRASCO HAROLD" },
                { id: 111, name: "MENDOZA ENDERSON" },
                { id: 112, name: "PINEDA BRAYAN" },
                { id: 113, name: "GONZALEZ ALVARO" },
                { id: 114, name: "MOSQUERA ARQUIMIDES" },
                { id: 115, name: "GONZALEZ SAMUEL" },
                { id: 116, name: "GARCIA YORMAN" },
                { id: 117, name: "BLANCO EDWAR" },
                { id: 118, name: "POSADA RAMON" },
                { id: 119, name: "GUZMAN CESAR" },
                { id: 120, name: "CAMPOS ARQUIMEDES" },
                { id: 121, name: "ROJAS RONALD" },
                { id: 122, name: "MOSQUERA JAVIER" },
                { id: 123, name: "ESCORCIA ELITH" },
                { id: 124, name: "VASQUEZ VICTOR" },
                { id: 125, name: "ESCALONA WUILMER" },
                { id: 126, name: "YEPEZ CESAR" },
                { id: 127, name: "AYALA JOSE" },
                { id: 128, name: "MACHADO CARLOS" },
                { id: 129, name: "ANGARITA ANGEL" },
                { id: 130, name: "BRITO HARRISON" },
                { id: 131, name: "APONTE YOSKARLA" },
                { id: 132, name: "AZUAJE YAMILETH" },
                { id: 133, name: "VALERO VANESA" },
                { id: 134, name: "GIL DEMIAN" },
                { id: 135, name: "MALVACEA ALANY" },
                { id: 136, name: "FIGUERA REBECA" },
                { id: 137, name: "VIVENES YETZIBEL" },
                { id: 138, name: "RUIZ JONATHAN" },
                { id: 139, name: "DUMONT ANGEL" },
                { id: 140, name: "BERROTERAN LUIS" },
                { id: 141, name: "URBAEZ HEISHMAR" },
                { id: 142, name: "SANCHEZ SARAI" },
                { id: 143, name: "GALVAN RICARDO" },
                { id: 144, name: "SIERRA DAVID" },
                { id: 145, name: "SERRANO WILLIANA" },
                { id: 146, name: "ESCORCHE VICTORIA" },
                { id: 147, name: "LEDEZMA RALTH" },
                { id: 148, name: "ORTIZ KATHERINE" },
                { id: 149, name: "SANCHEZ ADRIANA" },
                { id: 150, name: "RODRIGUEZ MERLIN" },
                { id: 151, name: "VAMONDE JOSE" },
                { id: 152, name: "MARTINEZ MARINA" },
                { id: 153, name: "MARQUEZ ACXEL" },
                { id: 154, name: "BARON YOSMAR" },
                { id: 155, name: "CALDERON LUISANA" },
                { id: 156, name: "BASUALDO JORGE" },
                { id: 157, name: "PEREZ JENNYFER" },
                { id: 158, name: "URBINA GENESIS" },
                { id: 159, name: "MAGALLANES LUIS" },
                { id: 160, name: "ESCALONA KARLA" },
                { id: 161, name: "BRICEÑO ALEXA" },
                { id: 162, name: "RUIZ EDGAR" },
                { id: 163, name: "CEBALLOS LEONID" }
            ];

            // --- Elementos del Reporte Mensual ---
            const reportMonthInput = document.getElementById('reportMonth');
            const periodMonthly = document.getElementById('periodMonthly');
            const periodBiweekly = document.getElementById('periodBiweekly');
            const monthlyFilter = document.getElementById('monthlyFilter');
            const biweeklyFilter = document.getElementById('biweeklyFilter');
            const biweekStartDate = document.getElementById('biweekStartDate');
            const biweekEndDate = document.getElementById('biweekEndDate');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const exportReportBtn = document.getElementById('exportReportBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const departmentReportBody = document.getElementById('departmentReportBody');
            const providerReportBody = document.getElementById('providerReportBody');
            const totalDepartmentMeals = document.getElementById('totalDepartmentMeals');
            const totalDepartmentAmount = document.getElementById('totalDepartmentAmount');
            const totalProviderMeals = document.getElementById('totalProviderMeals');
            const totalProviderAmount = document.getElementById('totalProviderAmount');
            const ccsTotalMeals = document.getElementById('ccsTotalMeals');
            const ccsTotalAmount = document.getElementById('ccsTotalAmount');
            const msoTotalMeals = document.getElementById('msoTotalMeals');
            const msoTotalAmount = document.getElementById('msoTotalAmount');
            const grandTotalAmount = document.getElementById('grandTotalAmount');
            const pdfContent = document.getElementById('pdfContent');
            const unitProviderReportBody = document.getElementById('unitProviderReportBody');
            const totalUnitProviderMeals = document.getElementById('totalUnitProviderMeals');
            const totalUnitProviderAmount = document.getElementById('totalUnitProviderAmount');

            // --- FUNCIONES DE FORMATO PARA DEPARTAMENTOS ---
            function formatDepartmentName(deptKey) {
                if (!deptKey) return '';
                
                if (deptKey.includes('C.O')) {
                    const parts = deptKey.split(' ');
                    if (parts.length >= 3) {
                        const co = 'C.O';
                        const rest = parts.slice(2).join(' ').toLowerCase();
                        const formattedRest = rest.split(' ').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1)
                        ).join(' ');
                        return `${co} ${formattedRest}`;
                    }
                    return deptKey;
                }
                
                const specialCaps = ['MSO', 'CCS', 'DPTO', 'G', 'RRHH'];
                const words = deptKey.split(' ');
                const formatted = words.map(word => {
                    if (specialCaps.includes(word.toUpperCase())) {
                        return word.toUpperCase();
                    }
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }).join(' ');
                
                return formatted;
            }

            // Función para determinar quién aprueba la solicitud
            function getApprover(department, msoDepartment) {
                if (department === 'MSO' || (msoDepartment && msoDepartment !== '')) {
                    return 'Mario Fernández';
                }
                return 'Jorge Basualdo';
            }

            // Lista completa de todos los departamentos posibles
            const ALL_DEPARTMENTS = [
                'Administración',
                'Área Comercial',
                'C.O El Rosal',
                'C.O La Naya',
                'C.O Los Ruices',
                'C.O Paraiso-Catia',
                'Gerencia Senior',
                'Head End',
                'MSO',
                'Ocad',
                'Obras'
            ].map(formatDepartmentName).sort((a, b) => a.localeCompare(b, 'es'));

            // --- Funciones de Firebase ---

            async function addRequestToFirestore(request) {
                try {
                    const requestsRef = firebaseFunctions.collection(db, 'foodRequests');
                    const docRef = await firebaseFunctions.addDoc(requestsRef, request);
                    console.log("Solicitud agregada con ID: ", docRef.id);
                    return { ...request, firestoreId: docRef.id };
                } catch (error) {
                    console.error("Error agregando solicitud:", error);
                    throw error;
                }
            }

            async function updateRequestInFirestore(requestId, updatedData) {
                try {
                    const requestsRef = firebaseFunctions.collection(db, 'foodRequests');
                    const q = firebaseFunctions.query(requestsRef, firebaseFunctions.where('id', '==', requestId));
                    const querySnapshot = await firebaseFunctions.getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const docRef = firebaseFunctions.doc(db, 'foodRequests', querySnapshot.docs[0].id);
                        await firebaseFunctions.updateDoc(docRef, updatedData);
                        console.log("Solicitud actualizada correctamente");
                    }
                } catch (error) {
                    console.error("Error actualizando solicitud:", error);
                    throw error;
                }
            }

            async function deleteRequestsFromFirestore(requestIds) {
                try {
                    const requestsRef = firebaseFunctions.collection(db, 'foodRequests');
                    
                    const deletePromises = requestIds.map(async (requestId) => {
                        const q = firebaseFunctions.query(requestsRef, firebaseFunctions.where('id', '==', requestId));
                        const querySnapshot = await firebaseFunctions.getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            const docRef = firebaseFunctions.doc(db, 'foodRequests', querySnapshot.docs[0].id);
                            await firebaseFunctions.deleteDoc(docRef);
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    console.log("Solicitudes eliminadas correctamente");
                } catch (error) {
                    console.error("Error eliminando solicitudes:", error);
                    throw error;
                }
            }

            async function loadRequests() {
                try {
                    const requestsRef = firebaseFunctions.collection(db, 'foodRequests');
                    const q = firebaseFunctions.query(requestsRef, firebaseFunctions.orderBy('deliveryDate', 'desc'));
                    const querySnapshot = await firebaseFunctions.getDocs(q);
                    
                    const requests = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        requests.push({
                            ...data,
                            firestoreId: doc.id
                        });
                    });
                    
                    console.log("Datos cargados desde Firestore:", requests.length, "solicitudes");
                    return requests;
                } catch (error) {
                    console.error("Error cargando desde Firestore:", error);
                    displayMessage('Error al cargar desde la base de datos', 'error');
                    return [];
                }
            }

            // --- Funciones de Utilidad ---

            function getCurrentDate() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function normalizeDate(dateString) {
                if (!dateString) return null;
                
                if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    return dateString;
                }
                
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return null;
                    }
                    
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    
                    return `${year}-${month}-${day}`;
                } catch (error) {
                    console.error('Error normalizando fecha:', dateString, error);
                    return null;
                }
            }

            function formatDateForDisplay(dateString) {
                const normalizedDate = normalizeDate(dateString);
                if (!normalizedDate) return '';
                
                const date = new Date(normalizedDate + 'T12:00:00');
                return date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }

            function formatDateForFilename(dateString) {
                const normalizedDate = normalizeDate(dateString);
                if (!normalizedDate) return '';
                
                return normalizedDate.replace(/-/g, '');
            }

            departmentSelect.addEventListener('change', function() {
                if (this.value === 'MSO') {
                    msoObservationsContainer.classList.remove('hidden');
                } else {
                    msoObservationsContainer.classList.add('hidden');
                    msoObservationsSelect.value = '';
                }
            });

            function initializeForm() {
                deliveryDateTimeInput.value = getCurrentDate();
                unitCostInput.value = '0.00';
                deliveryCostInput.value = '0.00';
                costInput.value = '0.00';
                totalQuantityInput.value = '0';
                
                editingRequestId = null;
                submitButton.textContent = 'Registrar Solicitud';
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitButton.classList.add('bg-inter-primary', 'hover:bg-blue-700');
                removeCancelEditButton();

                // Solo limpiar campos de personal externo si existen (para admin)
                document.querySelectorAll('input[name="externalStaff"]').forEach(checkbox => {
                    if (checkbox) {
                        checkbox.checked = false;
                        const quantityInput = document.getElementById(`quantity${checkbox.value}`);
                        if (quantityInput) {
                            quantityInput.value = '0';
                            quantityInput.classList.add('hidden-quantity');
                        }
                    }
                });
                
                selectedInterStaff = [];
                renderSelectedStaff();
                
                if (departmentSelect.value !== 'MSO') {
                    msoObservationsContainer.classList.add('hidden');
                    msoObservationsSelect.value = '';
                }
            }

            // Mover renderSelectedStaff FUERA del bloque condicional para que esté disponible para todos los perfiles
            function renderSelectedStaff() {
                if (!interStaffSelectedList) return;
                
                interStaffSelectedList.innerHTML = '';
                selectedInterStaff.forEach((staffName, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between text-sm bg-blue-50 p-2 rounded';
                    li.innerHTML = `
                        <span class="text-gray-700 truncate" style="max-width: 80%;">${staffName}</span>
                        <button type="button" data-name="${staffName}"
                                class="remove-staff-btn text-red-500 hover:text-red-700 ml-2 font-bold transition duration-150">
                            &times;
                        </button>
                    `;
                    interStaffSelectedList.appendChild(li);
                });
                calculateTotalCost();
            }

            function formatDateForInput(dateString) {
                const normalizedDate = normalizeDate(dateString);
                return normalizedDate || '';
            }
            
            function displayMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                } else {
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            }

            // --- FUNCIÓN CORREGIDA ---
            function calculateTotalQuantity() {
                // Si el perfil es 'presidencia', simplemente devolvemos el valor del campo totalQuantity
                if (currentProfile === 'presidencia') {
                    return parseInt(totalQuantityInput.value) || 0;
                }

                // Si es admin, hacemos el cálculo normal
                let externalQuantity = 0;
                document.querySelectorAll('input[type="number"][id^="quantity"]').forEach(input => {
                    if (input) {
                        externalQuantity += parseInt(input.value) || 0;
                    }
                });

                const interQuantity = selectedInterStaff.length;
                const total = externalQuantity + interQuantity;
                totalQuantityInput.value = total;
                return total;
            }

            function calculateTotalCost() {
                const totalQuantity = parseFloat(totalQuantityInput.value) || 0;
                const unitCost = parseFloat(unitCostInput.value) || 0;
                const deliveryCost = deliveryFree.checked ? 0 : (parseFloat(deliveryCostInput.value) || 0);

                const totalCost = (totalQuantity * unitCost) + deliveryCost;
                costInput.value = totalCost.toFixed(2);
            }

            // Solo configurar eventos de personal externo si es admin
            if (currentProfile === 'admin') {
                document.querySelectorAll('input[name="externalStaff"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const quantityInput = document.getElementById(`quantity${e.target.value}`);
                        if (quantityInput) {
                            if (e.target.checked) {
                                quantityInput.classList.remove('hidden-quantity');
                                quantityInput.value = 1;
                            } else {
                                quantityInput.classList.add('hidden-quantity');
                                quantityInput.value = 0;
                            }
                        }
                        calculateTotalCost();
                    });
                });

                document.querySelectorAll('input[type="number"][id^="quantity"]').forEach(input => {
                    input.addEventListener('input', () => {
                        if (parseInt(input.value) < 0 || input.value === '') {
                            input.value = '0';
                        }
                        const checkboxId = input.id.replace('quantity', 'check');
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.checked = parseInt(input.value) > 0;
                            if (parseInt(input.value) === 0) {
                                 input.classList.add('hidden-quantity');
                            } else {
                                input.classList.remove('hidden-quantity');
                            }
                        }
                        calculateTotalCost();
                    });
                });

                interStaffSearchInput.addEventListener('input', () => {
                    const query = interStaffSearchInput.value.trim().toUpperCase();
                    interStaffSearchResults.innerHTML = '';

                    if (query.length < 2) {
                        interStaffSearchResults.classList.add('hidden');
                        return;
                    }

                    const filteredStaff = staffList.filter(staff => 
                        staff.name.includes(query) && !selectedInterStaff.includes(staff.name)
                    ).slice(0, 10);

                    if (filteredStaff.length > 0) {
                        filteredStaff.forEach(staff => {
                            const li = document.createElement('li');
                            li.className = 'p-2 hover:bg-inter-accent-light hover:text-white cursor-pointer transition duration-150 text-sm md:text-base';
                            li.textContent = staff.name;
                            li.setAttribute('data-name', staff.name);
                            li.addEventListener('click', (e) => {
                                selectedInterStaff.push(e.target.getAttribute('data-name'));
                                interStaffSearchInput.value = '';
                                interStaffSearchResults.classList.add('hidden');
                                renderSelectedStaff();
                            });
                            interStaffSearchResults.appendChild(li);
                        });
                        interStaffSearchResults.classList.remove('hidden');
                    } else {
                        interStaffSearchResults.classList.add('hidden');
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!interStaffSearchInput.contains(e.target) && !interStaffSearchResults.contains(e.target)) {
                        interStaffSearchResults.classList.add('hidden');
                    }
                });

                interStaffSelectedList.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-staff-btn')) {
                        const staffName = e.target.getAttribute('data-name');
                        selectedInterStaff = selectedInterStaff.filter(name => name !== staffName);
                        renderSelectedStaff();
                    }
                });
            }

            // Evento para el campo totalQuantity (para presidencia)
            totalQuantityInput.addEventListener('input', calculateTotalCost);

            document.querySelectorAll('input[name="deliveryOption"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (deliveryCostOption.checked) {
                        deliveryCostInput.classList.remove('hidden');
                    } else {
                        deliveryCostInput.classList.add('hidden');
                        deliveryCostInput.value = '0.00';
                    }
                    calculateTotalCost();
                });
            });

            unitCostInput.addEventListener('input', calculateTotalCost);
            deliveryCostInput.addEventListener('input', calculateTotalCost);

            function addCancelEditButton() {
                let cancelBtn = document.getElementById('cancelEditBtn');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancelEditBtn';
                    cancelBtn.type = 'button';
                    cancelBtn.textContent = 'Cancelar Edición';
                    cancelBtn.className = 'bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto mt-2 sm:mt-0';
                    cancelBtn.addEventListener('click', resetFormAndEditing);
                    formActionsContainer.insertBefore(cancelBtn, submitButton);
                }
            }

            function removeCancelEditButton() {
                const cancelBtn = document.getElementById('cancelEditBtn');
                if (cancelBtn) {
                    cancelBtn.remove();
                }
            }

            function resetFormAndEditing() {
                form.reset();
                initializeForm();
                submitButton.textContent = 'Registrar Solicitud';
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitButton.classList.add('bg-inter-primary', 'hover:bg-blue-700');
                removeCancelEditButton();
                deliveryCostInput.classList.add('hidden');
            }

            window.editRequest = (id) => {
                const requestToEdit = foodRequests.find(req => req.id === id);
                if (!requestToEdit) return;

                editingRequestId = id;
                
                departmentSelect.value = requestToEdit.department;
                mealTypeSelect.value = requestToEdit.mealType;
                eventSelect.value = requestToEdit.event || '';
                deliveryPlaceInput.value = requestToEdit.deliveryPlace;
                deliveryDateTimeInput.value = formatDateForInput(requestToEdit.deliveryDate);
                unitCostInput.value = parseFloat(requestToEdit.unitCost).toFixed(2);
                providerNameSelect.value = requestToEdit.providerName;
                reasonTextarea.value = requestToEdit.reason;

                if (requestToEdit.department === 'MSO' && requestToEdit.msoDepartment) {
                    msoObservationsContainer.classList.remove('hidden');
                    msoObservationsSelect.value = requestToEdit.msoDepartment;
                } else {
                    msoObservationsContainer.classList.add('hidden');
                    msoObservationsSelect.value = '';
                }

                if (currentProfile === 'admin') {
                    document.querySelectorAll('input[name="externalStaff"]').forEach(checkbox => {
                        checkbox.checked = false;
                        const quantityInput = document.getElementById(`quantity${checkbox.value}`);
                        if (quantityInput) {
                            quantityInput.value = '0';
                            quantityInput.classList.add('hidden-quantity');
                        }
                    });

                    if (requestToEdit.externalStaff) {
                        Object.keys(requestToEdit.externalStaff).forEach(key => {
                            const quantity = requestToEdit.externalStaff[key];
                            if (quantity > 0) {
                                const checkbox = document.getElementById(`check${key}`);
                                const quantityInput = document.getElementById(`quantity${key}`);
                                if (checkbox && quantityInput) {
                                    checkbox.checked = true;
                                    quantityInput.value = quantity;
                                    quantityInput.classList.remove('hidden-quantity');
                                }
                            }
                        });
                    }

                    selectedInterStaff = requestToEdit.interStaff ? requestToEdit.interStaff.slice() : [];
                    renderSelectedStaff();
                } else {
                    totalQuantityInput.value = requestToEdit.totalQuantity;
                }

                const deliveryCostValue = parseFloat(requestToEdit.deliveryCost);
                if (deliveryCostValue > 0) {
                    deliveryCostOption.checked = true;
                    deliveryFree.checked = false;
                    deliveryCostInput.value = deliveryCostValue.toFixed(2);
                    deliveryCostInput.classList.remove('hidden');
                } else {
                    deliveryFree.checked = true;
                    deliveryCostOption.checked = false;
                    deliveryCostInput.value = '0.00';
                    deliveryCostInput.classList.add('hidden');
                }
                
                calculateTotalCost();

                submitButton.textContent = 'Guardar Cambios';
                submitButton.classList.remove('bg-inter-primary', 'hover:bg-blue-700');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
                addCancelEditButton();

                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                let externalStaffData = {};
                if (currentProfile === 'admin') {
                    document.querySelectorAll('input[name="externalStaff"]:checked').forEach(checkbox => {
                        const quantityInput = document.getElementById(`quantity${checkbox.value}`);
                        const quantity = parseInt(quantityInput ? quantityInput.value : 0) || 0;
                        if (quantity > 0) {
                            externalStaffData[checkbox.value] = quantity;
                        }
                    });
                }

                const totalQuantity = calculateTotalQuantity(); // Usamos la función corregida
                const totalCost = parseFloat(costInput.value);
                const deliveryCostValue = deliveryFree.checked ? 0 : (parseFloat(deliveryCostInput.value) || 0);

                if (totalQuantity === 0) {
                    displayMessage('El total de comidas debe ser mayor a 0.', 'error');
                    return;
                }
                
                if (departmentSelect.value === '') {
                    displayMessage('Debe seleccionar un Departamento/Área.', 'error');
                    return;
                }

                if (providerNameSelect.value === '') {
                    displayMessage('Debe seleccionar un Proveedor.', 'error');
                    return;
                }

                // Validar que el evento esté seleccionado
                if (!eventSelect.value) {
                    displayMessage('Debe seleccionar un Evento.', 'error');
                    return;
                }

                // Validar que el motivo esté lleno
                if (!reasonTextarea.value.trim()) {
                    displayMessage('Debe completar el Motivo de la Solicitud.', 'error');
                    return;
                }

                // Determinar quién aprueba la solicitud
                const approver = getApprover(departmentSelect.value, msoObservationsSelect.value);

                const newRequest = {
                    id: editingRequestId || Date.now(),
                    department: departmentSelect.value,
                    mealType: mealTypeSelect.value,
                    event: eventSelect.value,
                    externalStaff: externalStaffData,
                    interStaff: currentProfile === 'admin' ? selectedInterStaff.slice() : [],
                    totalQuantity: totalQuantity,
                    deliveryPlace: deliveryPlaceInput.value,
                    deliveryDate: deliveryDateTimeInput.value,
                    unitCost: parseFloat(unitCostInput.value),
                    deliveryCost: deliveryCostValue,
                    totalCost: totalCost,
                    providerName: providerNameSelect.value,
                    reason: reasonTextarea.value,
                    registrationDate: new Date().toISOString(),
                    approvedBy: approver
                };

                if (departmentSelect.value === 'MSO' && msoObservationsSelect.value) {
                    newRequest.msoDepartment = msoObservationsSelect.value;
                }

                try {
                    if (editingRequestId) {
                        await updateRequestInFirestore(editingRequestId, newRequest);
                        
                        const index = foodRequests.findIndex(req => req.id === editingRequestId);
                        if (index !== -1) {
                            foodRequests[index] = newRequest;
                        }
                        
                        displayMessage('Solicitud actualizada con éxito.', 'success');
                        resetFormAndEditing();
                    } else {
                        const requestWithFirestoreId = await addRequestToFirestore(newRequest);
                        foodRequests.push(requestWithFirestoreId);
                        displayMessage('Solicitud registrada con éxito.', 'success');
                        form.reset();
                        initializeForm();
                    }
                    
                    // Filtrar para Presidencia si es necesario
                    let displayRequests = foodRequests.slice();
                    if (currentProfile === 'presidencia') {
                        // CORRECCIÓN: Mostrar todas las solicitudes de MSO que sean de Presidencia O Personal Visitante
                        displayRequests = foodRequests.filter(req => 
                            req.department === 'MSO' && 
                            (req.msoDepartment === 'Presidencia' || req.msoDepartment === 'Personal Visitante')
                        );
                    }
                    
                    renderTable(displayRequests);
                    updateSummaryTotals(displayRequests);
                    
                    if (currentProfile === 'admin') {
                        updateCharts();
                        if (reportMonthInput && reportMonthInput.value) {
                            generateReport();
                        }
                    }
                    
                } catch (error) {
                    displayMessage('Error al guardar la solicitud: ' + error.message, 'error');
                }
            });

            function formatCost(cost) {
                return `$${parseFloat(cost || 0).toFixed(2)}`;
            }
            
            function renderTable(requests = foodRequests) {
                let filteredRequests = requests.slice();
                
                if (activeFilters.length > 0) {
                    filteredRequests = filteredRequests.filter(request => {
                        return activeFilters.every(filter => {
                            const searchTerm = filter.term.toLowerCase();
                            
                            if (filter.field === 'all') {
                                return (
                                    request.department.toLowerCase().includes(searchTerm) ||
                                    request.mealType.toLowerCase().includes(searchTerm) ||
                                    request.deliveryPlace.toLowerCase().includes(searchTerm) ||
                                    request.providerName.toLowerCase().includes(searchTerm) ||
                                    request.reason.toLowerCase().includes(searchTerm) ||
                                    (request.interStaff && request.interStaff.some(staff => staff.toLowerCase().includes(searchTerm))) ||
                                    (request.msoDepartment && request.msoDepartment.toLowerCase().includes(searchTerm))
                                );
                            } else if (filter.field === 'department') {
                                return request.department.toLowerCase().includes(searchTerm);
                            } else if (filter.field === 'mealType') {
                                return request.mealType.toLowerCase().includes(searchTerm);
                            } else if (filter.field === 'provider') {
                                return request.providerName.toLowerCase().includes(searchTerm);
                            } else if (filter.field === 'staff') {
                                return request.interStaff && request.interStaff.some(staff => staff.toLowerCase().includes(searchTerm));
                            }
                            return true;
                        });
                    });
                }
                
                filteredRequests.sort((a, b) => {
                    const dateA = new Date(a.deliveryDate + 'T12:00:00');
                    const dateB = new Date(b.deliveryDate + 'T12:00:00');
                    return dateB - dateA;
                });

                tableBody.innerHTML = '';
                
                if (filteredRequests.length === 0) {
                    noRequestsMessage.classList.remove('hidden');
                    tableView.classList.add('hidden');
                    return;
                }
                
                noRequestsMessage.classList.add('hidden');
                tableView.classList.remove('hidden');

                filteredRequests.forEach(request => {
                    const externalStaffText = request.externalStaff ? Object.keys(request.externalStaff)
                        .map(key => `${key} (${request.externalStaff[key]})`)
                        .join(', ') : 'N/A';

                    const interStaffText = request.interStaff ? request.interStaff.join(', ') : 'N/A';
                    
                    const displayDate = new Date(request.deliveryDate + 'T12:00:00').toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                    });

                    const displayDepartment = request.department === 'MSO' && request.msoDepartment 
                        ? `${request.department} (${request.msoDepartment})`
                        : request.department;

                    const approver = request.approvedBy || getApprover(request.department, request.msoDepartment);

                    const row = tableBody.insertRow();
                    row.className = 'hover:bg-gray-50 transition duration-150';
                    
                    // Construir HTML de la fila según el perfil
                    let rowHTML = '';
                    
                    if (currentProfile === 'admin') {
                        rowHTML = `
                            <td class="px-4 py-3 whitespace-nowrap">
                                <input type="checkbox" data-id="${request.id}" class="row-checkbox form-checkbox h-4 w-4 text-inter-primary rounded">
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900" title="${displayDate}">
                                ${displayDate}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 truncate-cell" title="${displayDepartment}">
                                ${displayDepartment}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" title="${request.mealType}">
                                ${request.mealType}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 truncate-cell" title="${externalStaffText}">
                                ${externalStaffText || 'N/A'}
                            </td>
                            <td class="px-4 py-3 max-w-xs overflow-hidden truncate-cell text-sm text-gray-500" title="${interStaffText}">
                                ${interStaffText || 'N/A'}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-medium text-inter-primary">
                                ${request.totalQuantity}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-inter-primary">
                                ${formatCost(request.totalCost)}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                <div class="action-cell">
                                    <button onclick="editRequest(${request.id})" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded-md text-xs transition duration-150 transform hover:scale-105">
                                        Editar
                                    </button>
                                    <button onclick="deleteSingleRequest(${request.id})" class="bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded-md text-xs transition duration-150 transform hover:scale-105">
                                        Eliminar
                                    </button>
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-600">
                                ${approver}
                            </td>
                        `;
                    } else {
                        // Para Presidencia - con botones de editar y eliminar
                        rowHTML = `
                            <td class="px-4 py-3 whitespace-nowrap">
                                <input type="checkbox" data-id="${request.id}" class="row-checkbox form-checkbox h-4 w-4 text-inter-primary rounded">
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900" title="${displayDate}">
                                ${displayDate}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 truncate-cell" title="${displayDepartment}">
                                ${displayDepartment}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" title="${request.mealType}">
                                ${request.mealType}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-medium text-inter-primary">
                                ${request.totalQuantity}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-inter-primary">
                                ${formatCost(request.totalCost)}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                <div class="action-cell">
                                    <button onclick="editRequest(${request.id})" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded-md text-xs transition duration-150 transform hover:scale-105">
                                        Editar
                                    </button>
                                    <button onclick="deleteSingleRequest(${request.id})" class="bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded-md text-xs transition duration-150 transform hover:scale-105">
                                        Eliminar
                                    </button>
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-600">
                                ${approver}
                            </td>
                        `;
                    }
                    
                    row.innerHTML = rowHTML;
                });

                if (selectAllCheckboxes) selectAllCheckboxes.checked = false;
            }

            // Función para eliminar una sola solicitud
            window.deleteSingleRequest = (id) => {
                const selectedIds = [id];
                modalText.textContent = `¿Estás seguro de que quieres eliminar esta solicitud? Esta acción no se puede deshacer.`;
                deleteModal.classList.remove('hidden');

                confirmDeleteBtn.onclick = async () => {
                    try {
                        await deleteRequestsFromFirestore(selectedIds);
                        
                        foodRequests = foodRequests.filter(req => !selectedIds.includes(req.id));
                        
                        let displayRequests = foodRequests.slice();
                        if (currentProfile === 'presidencia') {
                            // CORRECCIÓN: Mostrar todas las solicitudes de MSO que sean de Presidencia O Personal Visitante
                            displayRequests = foodRequests.filter(req => 
                                req.department === 'MSO' && 
                                (req.msoDepartment === 'Presidencia' || req.msoDepartment === 'Personal Visitante')
                            );
                        }
                        
                        renderTable(displayRequests);
                        updateSummaryTotals(displayRequests);
                        
                        if (currentProfile === 'admin') {
                            updateCharts();
                            if (reportMonthInput && reportMonthInput.value) {
                                generateReport();
                            }
                        }
                        
                        deleteModal.classList.add('hidden');
                        displayMessage('Solicitud eliminada con éxito.', 'success');
                    } catch (error) {
                        displayMessage('Error al eliminar la solicitud: ' + error.message, 'error');
                        deleteModal.classList.add('hidden');
                    }
                };

                cancelDeleteBtn.onclick = () => {
                    deleteModal.classList.add('hidden');
                };
            };

            function renderActiveFilters() {
                activeFiltersContainer.innerHTML = '';
                
                if (activeFilters.length === 0) {
                    return;
                }
                
                activeFilters.forEach((filter, index) => {
                    const filterTag = document.createElement('div');
                    filterTag.className = 'filter-tag';
                    filterTag.innerHTML = `
                        <span>${filter.field === 'all' ? 'Todos:' : filter.field === 'department' ? 'Depto:' : filter.field === 'mealType' ? 'Tipo:' : filter.field === 'provider' ? 'Prov:' : 'Personal:'} ${filter.term}</span>
                        <span class="filter-tag-remove" data-index="${index}">×</span>
                    `;
                    activeFiltersContainer.appendChild(filterTag);
                });
                
                document.querySelectorAll('.filter-tag-remove').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        removeFilter(index);
                    });
                });
                
                renderTable();
            }

            function addFilter() {
                const searchTerm = filterInput.value.trim();
                if (!searchTerm) {
                    displayMessage('Por favor ingrese un término de búsqueda', 'error');
                    return;
                }
                
                let field = 'all';
                const termLower = searchTerm.toLowerCase();
                
                const mealTypes = ['desayuno', 'almuerzo', 'cena', 'refrigerios'];
                if (mealTypes.some(type => termLower.includes(type))) {
                    field = 'mealType';
                }
                else if (termLower.includes('monteluso') || termLower.includes('susi') || termLower.includes('cumbes') || termLower.includes('al momento')) {
                    field = 'provider';
                }
                else if (termLower.split(' ').length >= 2) {
                    field = 'staff';
                }
                else if (termLower.includes('admin') || termLower.includes('comercial') || termLower.includes('gerencia') || 
                         termLower.includes('head') || termLower.includes('mso') || termLower.includes('ocad') || 
                         termLower.includes('obras') || termLower.includes('rosal') || termLower.includes('naya') || 
                         termLower.includes('ruices')) {
                    field = 'department';
                }
                
                activeFilters.push({
                    field: field,
                    term: searchTerm
                });
                
                filterInput.value = '';
                renderActiveFilters();
            }

            function removeFilter(index) {
                activeFilters.splice(index, 1);
                renderActiveFilters();
            }

            function clearAllFilters() {
                activeFilters = [];
                filterInput.value = '';
                renderActiveFilters();
            }

            addFilterBtn.addEventListener('click', addFilter);
            
            filterInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addFilter();
                }
            });
            
            clearAllFiltersBtn.addEventListener('click', clearAllFilters);
            
            if (selectAllCheckboxes) {
                selectAllCheckboxes.addEventListener('change', (e) => {
                    document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                        if (checkbox) {
                            checkbox.checked = e.target.checked;
                        }
                    });
                });
            }

            if (deleteSelectedBtn) {
                deleteSelectedBtn.addEventListener('click', async () => {
                    const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                        .map(cb => parseInt(cb.getAttribute('data-id')));

                    if (selectedIds.length === 0) {
                        displayMessage('Debe seleccionar al menos una solicitud para eliminar.', 'error');
                        return;
                    }

                    modalText.textContent = `¿Estás seguro de que quieres eliminar ${selectedIds.length} solicitud(es)? Esta acción no se puede deshacer.`;
                    deleteModal.classList.remove('hidden');

                    confirmDeleteBtn.onclick = async () => {
                        try {
                            await deleteRequestsFromFirestore(selectedIds);
                            
                            foodRequests = foodRequests.filter(req => !selectedIds.includes(req.id));
                            
                            let displayRequests = foodRequests.slice();
                            if (currentProfile === 'presidencia') {
                                // CORRECCIÓN: Mostrar todas las solicitudes de MSO que sean de Presidencia O Personal Visitante
                                displayRequests = foodRequests.filter(req => 
                                    req.department === 'MSO' && 
                                    (req.msoDepartment === 'Presidencia' || req.msoDepartment === 'Personal Visitante')
                                );
                            }
                            
                            renderTable(displayRequests);
                            updateSummaryTotals(displayRequests);
                            
                            if (currentProfile === 'admin') {
                                updateCharts();
                                if (reportMonthInput && reportMonthInput.value) {
                                    generateReport();
                                }
                            }
                            
                            deleteModal.classList.add('hidden');
                            displayMessage('Solicitud(es) eliminada(s) con éxito.', 'success');
                        } catch (error) {
                            displayMessage('Error al eliminar las solicitudes: ' + error.message, 'error');
                            deleteModal.classList.add('hidden');
                        }
                    };

                    cancelDeleteBtn.onclick = () => {
                        deleteModal.classList.add('hidden');
                    };
                });
            }

            exportCsvBtn.addEventListener('click', () => {
                const requestsToExport = currentProfile === 'presidencia' 
                    ? foodRequests.filter(req => req.department === 'MSO' && (req.msoDepartment === 'Presidencia' || req.msoDepartment === 'Personal Visitante'))
                    : foodRequests;
                    
                if (requestsToExport.length === 0) {
                    displayMessage('No hay datos para exportar.', 'error');
                    return;
                }
                
                const csvQuote = (str) => {
                    return `"${String(str || '').replace(/"/g, '""')}"`;
                };

                let headers = [
                    "Fecha de Entrega", 
                    "Departamento", 
                    "Departamento MSO (si aplica)",
                    "Tipo de Comida", 
                    "Evento", 
                    "Personal Externo (Detalle)", 
                    "Personal Inter (Detalle)", 
                    "Total Comidas", 
                    "Lugar de Entrega", 
                    "Motivo", 
                    "Proveedor", 
                    "Costo Comida Unitario ($)", 
                    "Costo Total Comida ($)", 
                    "Costo Delivery ($)", 
                    "Costo Total Final ($)",
                    "Aprobado por"
                ];
            
                let csv = headers.join(";") + "\n";

                requestsToExport.forEach(req => {
                    const externalStaffText = req.externalStaff ? Object.keys(req.externalStaff)
                        .map(key => `${key} (${req.externalStaff[key]})`)
                        .join(' | ') : '';

                    const interStaffText = req.interStaff ? req.interStaff.join(' | ') : '';
                    const totalCostComida = req.totalQuantity * req.unitCost;
                    
                    const row = [
                        csvQuote(req.deliveryDate),
                        csvQuote(req.department),
                        csvQuote(req.msoDepartment || ''),
                        csvQuote(req.mealType),
                        csvQuote(req.event || ''),
                        csvQuote(externalStaffText),
                        csvQuote(interStaffText),
                        req.totalQuantity,
                        csvQuote(req.deliveryPlace),
                        csvQuote(req.reason),
                        csvQuote(req.providerName),
                        parseFloat(req.unitCost).toFixed(2).replace('.', ','),
                        totalCostComida.toFixed(2).replace('.', ','),
                        parseFloat(req.deliveryCost).toFixed(2).replace('.', ','),
                        parseFloat(req.totalCost).toFixed(2).replace('.', ','),
                        csvQuote(req.approvedBy || '')
                    ];
                    csv += row.join(";") + "\n";
                });

                const blob = new Blob(["\uFEFF", csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'solicitudes_comidas.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                displayMessage('Datos exportados a CSV con éxito.', 'success');
            });

            function updateSummaryTotals(requests = foodRequests) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

                let dailyTotal = 0;
                let weeklyTotal = 0;
                let monthlyTotal = 0;

                requests.forEach(req => {
                    const reqDateForComparison = new Date(req.deliveryDate + 'T12:00:00');
                    const cost = parseFloat(req.totalCost) || 0;

                    if (reqDateForComparison >= monthStart) {
                        monthlyTotal += cost;
                    }

                    if (reqDateForComparison >= weekStart) {
                        weeklyTotal += cost;
                    }
                    
                    const todayStr = today.toISOString().split('T')[0];
                    if (req.deliveryDate === todayStr) {
                        dailyTotal += cost;
                    }
                });

                dailyTotalEl.textContent = formatCost(dailyTotal);
                weeklyTotalEl.textContent = formatCost(weeklyTotal);
                monthlyTotalEl.textContent = formatCost(monthlyTotal);
            }
            
            function getChartColor(index) {
                const colors = ['#005BAA', '#5CE1E6', '#00B8D9', '#FF9800', '#667EEA', '#F6AD55', '#E53E3E', '#38B2AC'];
                return colors[index % colors.length];
            }

            function updateCharts() {
                // Solo actualizar gráficos si es admin
                if (currentProfile !== 'admin') return;
                
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const currentMonthRequests = foodRequests.filter(req => {
                    const reqDate = new Date(req.deliveryDate + 'T12:00:00');
                    return reqDate.getMonth() === currentMonth && reqDate.getFullYear() === currentYear;
                });
                
                const currentYearRequests = foodRequests.filter(req => {
                    const reqDate = new Date(req.deliveryDate + 'T12:00:00');
                    return reqDate.getFullYear() === currentYear;
                });

                const monthlyProviderData = currentMonthRequests.reduce((acc, req) => {
                    const provider = req.providerName;
                    const cost = parseFloat(req.totalCost) || 0;

                    if (!acc[provider]) acc[provider] = 0;
                    acc[provider] += cost;
                    return acc;
                }, {});

                const monthlyProviders = Object.keys(monthlyProviderData);
                const monthlyCosts = monthlyProviders.map(provider => monthlyProviderData[provider]);
                const monthlyColors = monthlyProviders.map((provider, index) => 
                    CHART_COLORS[provider] || getChartColor(index)
                );

                if (monthlyProvidersChart) {
                    monthlyProvidersChart.destroy();
                }
                const monthlyCtx = document.getElementById('monthlyProvidersChart').getContext('2d');
                monthlyProvidersChart = new Chart(monthlyCtx, {
                    type: 'doughnut',
                    data: {
                        labels: monthlyProviders,
                        datasets: [{
                            data: monthlyCosts,
                            backgroundColor: monthlyColors,
                            borderColor: monthlyColors.map(color => color.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: window.innerWidth <= 768 ? 'bottom' : 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                const annualProviderData = currentYearRequests.reduce((acc, req) => {
                    const date = new Date(req.deliveryDate + 'T12:00:00');
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const provider = req.providerName;
                    const cost = parseFloat(req.totalCost) || 0;

                    if (!acc[monthKey]) acc[monthKey] = {};
                    if (!acc[monthKey][provider]) acc[monthKey][provider] = 0;
                    acc[monthKey][provider] += cost;
                    return acc;
                }, {});

                const allMonths = Object.keys(annualProviderData).sort();
                const allProviders = [...new Set(currentYearRequests.map(r => r.providerName))];

                const providerDatasets = allProviders.map((provider, index) => {
                    const data = allMonths.map(month => annualProviderData[month][provider] || 0);
                    return {
                        label: provider,
                        data: data,
                        backgroundColor: CHART_COLORS[provider] || getChartColor(index),
                        borderColor: CHART_COLORS[provider] || getChartColor(index),
                        fill: false,
                        tension: 0.1
                    };
                });

                if (annualProvidersChart) {
                    annualProvidersChart.destroy();
                }
                const annualCtx = document.getElementById('annualProvidersChart').getContext('2d');
                annualProvidersChart = new Chart(annualCtx, {
                    type: 'line',
                    data: {
                        labels: allMonths,
                        datasets: providerDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Gasto Total (USD $)',
                                    color: CHART_COLORS['Monteluso']
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: window.innerWidth <= 768 ? 'bottom' : 'top',
                            }
                        }
                    }
                });

                const departmentMonthlyData = currentYearRequests.reduce((acc, req) => {
                    const date = new Date(req.deliveryDate + 'T12:00:00');
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const department = req.department;
                    const cost = parseFloat(req.totalCost) || 0;

                    if (!acc[monthKey]) acc[monthKey] = {};
                    if (!acc[monthKey][department]) acc[monthKey][department] = 0;
                    acc[monthKey][department] += cost;
                    return acc;
                }, {});

                const departmentMonths = Object.keys(departmentMonthlyData).sort();
                const allDepartments = [...new Set(currentYearRequests.map(r => r.department))];
                
                const departmentDatasets = allDepartments.map((department, index) => {
                    const data = departmentMonths.map(month => departmentMonthlyData[month][department] || 0);
                    return {
                        label: department,
                        data: data,
                        backgroundColor: getChartColor(index),
                        borderColor: getChartColor(index),
                        fill: false,
                        tension: 0.1
                    };
                });

                if (departmentExpensesChart) {
                    departmentExpensesChart.destroy();
                }
                const deptExpensesCtx = document.getElementById('departmentExpensesChart').getContext('2d');
                departmentExpensesChart = new Chart(deptExpensesCtx, {
                    type: 'line',
                    data: {
                        labels: departmentMonths,
                        datasets: departmentDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Gasto Total (USD $)',
                                    color: CHART_COLORS['Monteluso']
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: window.innerWidth <= 768 ? 'bottom' : 'top',
                            }
                        }
                    }
                });

                const staffRequests = currentYearRequests.reduce((acc, req) => {
                    if (req.interStaff) {
                        req.interStaff.forEach(staff => {
                            acc[staff] = (acc[staff] || 0) + 1;
                        });
                    }
                    return acc;
                }, {});

                const topStaff = Object.entries(staffRequests)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 10);

                const staffLabels = topStaff.map(([name]) => name);
                const staffData = topStaff.map(([, count]) => count);
                const staffColors = staffData.map((_, index) => getChartColor(index));

                if (staffRequestsChart) {
                    staffRequestsChart.destroy();
                }
                const staffCtx = document.getElementById('staffRequestsChart').getContext('2d');
                staffRequestsChart = new Chart(staffCtx, {
                    type: 'bar',
                    data: {
                        labels: staffLabels,
                        datasets: [{
                            label: 'Número de Solicitudes',
                            data: staffData,
                            backgroundColor: staffColors,
                            borderColor: staffColors.map(color => color.replace('0.2', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad de Solicitudes',
                                },
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (value % 1 === 0) {
                                            return value;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                const departmentCounts = currentYearRequests.reduce((acc, req) => {
                    acc[req.department] = (acc[req.department] || 0) + 1;
                    return acc;
                }, {});

                const departmentLabels = Object.keys(departmentCounts).sort();
                const departmentData = departmentLabels.map(dept => departmentCounts[dept]);
                const departmentColors = departmentData.map((_, index) => getChartColor(index + 3));

                if (departmentRequestsChart) {
                    departmentRequestsChart.destroy();
                }
                const departmentCtx = document.getElementById('departmentRequestsChart').getContext('2d');
                departmentRequestsChart = new Chart(departmentCtx, {
                    type: 'bar',
                    data: {
                        labels: departmentLabels,
                        datasets: [{
                            label: 'Número de Solicitudes',
                            data: departmentData,
                            backgroundColor: departmentColors,
                            borderColor: departmentColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad de Solicitudes',
                                },
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (value % 1 === 0) {
                                            return value;
                                        }
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Departamento',
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            function updateUIForProfile() {
                const departmentField = document.getElementById('departmentField');
                const msoObservationsContainer = document.getElementById('msoObservationsContainer');
                const departmentSelect = document.getElementById('department');
                const msoObservations = document.getElementById('msoObservations');
                const eventSelect = document.getElementById('event');
                
                if (currentProfile === 'presidencia') {
                    // Configurar para Presidencia
                    departmentSelect.innerHTML = `
                        <option value="" disabled selected>Selecciona un Departamento</option>
                        <option value="MSO">MSO</option>
                    `;
                    
                    // Configurar MSO específico - INCLUYE PERSONAL VISITANTE
                    msoObservations.innerHTML = `
                        <option value="" selected>Selecciona departamento MSO</option>
                        <option value="Presidencia">Presidencia</option>
                        <option value="Personal Visitante">Personal Visitante</option>
                    `;
                    
                    // Configurar eventos solo para Presidencia
                    eventSelect.innerHTML = `
                        <option value="" disabled selected>Selecciona un Evento</option>
                        <option value="Evento extraordinario">Evento extraordinario</option>
                        <option value="Otros">Otros</option>
                    `;
                    
                    // Forzar selección de MSO
                    departmentSelect.value = 'MSO';
                    msoObservationsContainer.classList.remove('hidden');
                    msoObservations.value = 'Presidencia';
                } else {
                    // Restaurar configuración normal para admin - INCLUYE PERSONAL VISITANTE
                    departmentSelect.innerHTML = `
                        <option value="" disabled selected>Selecciona un Departamento</option>
                        <option value="Administracion">Administración</option>
                        <option value="Area Comercial">Área Comercial</option>
                        <option value="C.O El Rosal">C.O El Rosal</option>
                        <option value="C.O La Naya">C.O La Naya</option>
                        <option value="C.O Los Ruices">C.O Los Ruices</option>
                        <option value="C.O Paraiso-Catia">C.O Paraiso-Catia</option>
                        <option value="Gerencia Senior">Gerencia Senior</option>
                        <option value="Head End">Head End</option>
                        <option value="MSO">MSO</option>
                        <option value="Ocad">Ocad</option>
                        <option value="Obras">Obras</option>
                    `;
                    
                    msoObservations.innerHTML = `
                        <option value="" selected>Selecciona departamento MSO</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Presidencia">Presidencia</option>
                        <option value="Interconexiones">Interconexiones</option>
                        <option value="Importaciones">Importaciones</option>
                        <option value="RRHH MSO">RRHH MSO</option>
                        <option value="Documentacion de obras">Documentación de obras</option>
                        <option value="Logistica">Logística</option>
                        <option value="Personal Visitante">Personal Visitante</option>
                    `;
                    
                    eventSelect.innerHTML = `
                        <option value="" disabled selected>Selecciona un Evento</option>
                        <option value="Evento extraordinario">Evento extraordinario</option>
                        <option value="Corte de fibra">Corte de fibra</option>
                        <option value="Mantenimiento de red">Mantenimiento de red</option>
                        <option value="Feeder y obras">Feeder y obras</option>
                        <option value="Ventas en calle">Ventas en calle</option>
                        <option value="Ventana de mantenimiento">Ventana de mantenimiento</option>
                        <option value="Transporte y flota">Transporte y flota</option>
                        <option value="Otros">Otros</option>
                    `;
                }
            }

            async function reloadData() {
                try {
                    foodRequests = await loadRequests();
                    
                    // Filtrar solicitudes para Presidencia
                    let displayRequests = foodRequests.slice();
                    if (currentProfile === 'presidencia') {
                        // CORRECCIÓN: Mostrar todas las solicitudes de MSO que sean de Presidencia O Personal Visitante
                        displayRequests = foodRequests.filter(req => 
                            req.department === 'MSO' && 
                            (req.msoDepartment === 'Presidencia' || req.msoDepartment === 'Personal Visitante')
                        );
                    }
                    
                    renderTable(displayRequests);
                    updateSummaryTotals(displayRequests);
                    
                    if (currentProfile === 'admin') {
                        updateCharts();
                        if (reportMonthInput && reportMonthInput.value) {
                            generateReport();
                        }
                    }
                    
                    console.log("Datos recargados para perfil:", currentProfile);
                } catch (error) {
                    console.error("Error al recargar datos:", error);
                }
            }

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            if (reportMonthInput) {
                reportMonthInput.value = `${year}-${month}`;
            }
            
            const startDate = `${year}-${month}-01`;
            const endDate = new Date(year, parseInt(month), 15).toISOString().split('T')[0];
            if (biweekStartDate && biweekEndDate) {
                biweekStartDate.value = startDate;
                biweekEndDate.value = endDate;
            }

            if (periodMonthly) {
                periodMonthly.addEventListener('change', function() {
                    if (this.checked) {
                        monthlyFilter.classList.remove('hidden');
                        biweeklyFilter.classList.add('hidden');
                    }
                });
            }
            
            if (periodBiweekly) {
                periodBiweekly.addEventListener('change', function() {
                    if (this.checked) {
                        monthlyFilter.classList.add('hidden');
                        biweeklyFilter.classList.remove('hidden');
                    }
                });
            }

            function mapDepartment(department, msoDepartment) {
                if (!department) return 'NO ESPECIFICADO';
                
                const dept = department.toString().trim().toUpperCase();
                
                if (dept.includes('EL ROSAL') || dept === 'C.O EL ROSAL') return 'C.O El Rosal';
                if (dept.includes('LOS RUICES') || dept === 'C.O LOS RUICES') return 'C.O Los Ruices';
                if (dept.includes('LA NAYA') || dept === 'C.O LA NAYA') return 'C.O La Naya';
                if (dept.includes('PARAISO') || dept === 'C.O PARAISO-CATIA') return 'C.O Paraiso-Catia';
                if (dept.includes('OBRAS') || dept === 'DPTO DE OBRAS' || dept === 'OBRAS') return 'Obras';
                if (dept.includes('COMERCIAL') || dept === 'AREA COMERCIAL' || dept === 'ÁREA COMERCIAL') return 'Área Comercial';
                if (dept.includes('GERENCIA SENIOR') || dept === 'G. SENIOR' || dept === 'GERENCIA SENIOR') return 'Gerencia Senior';
                if (dept.includes('MSO') || dept === 'MSO') return 'MSO';
                if (dept.includes('HEAD END')) return 'Head End';
                if (dept.includes('ADMINISTRACION') || dept === 'ADMINISTRACIÓN') return 'Administración';
                if (dept.includes('OCAD')) return 'Ocad';
                
                return formatDepartmentName(department);
            }

            function classifyUnit(department, msoDepartment) {
                const dept = department.toString().trim().toUpperCase();
                
                if (dept === 'MSO' || 
                    dept.includes('PRESIDENCIA') || 
                    dept.includes('MARKETING') || 
                    dept.includes('INTERCONEXIONES') ||
                    dept.includes('IMPORTACIONES') ||
                    dept.includes('RRHH MSO') ||
                    dept.includes('DOCUMENTACION DE OBRAS') ||
                    dept.includes('LOGISTICA') ||
                    dept.includes('PERSONAL VISITANTE')) {
                    return 'MSO';
                }
                
                return 'CCS';
            }

            function getMonthName(monthNumber) {
                const months = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];
                return months[parseInt(monthNumber) - 1];
            }

            function generateReport() {
                if (currentProfile !== 'admin') return;
                
                const isMonthly = periodMonthly.checked;
                let filteredRequests = [];
                let reportTitle = '';
                
                if (isMonthly) {
                    const selectedMonth = reportMonthInput.value;
                    if (!selectedMonth) {
                        displayMessage('Por favor seleccione un mes para el reporte', 'error');
                        return;
                    }
                    
                    const [year, month] = selectedMonth.split('-');
                    reportTitle = `Reporte Mensual - ${getMonthName(month)} ${year}`;
                    
                    filteredRequests = foodRequests.filter(request => {
                        if (!request.deliveryDate) return false;
                        
                        try {
                            const requestDate = new Date(request.deliveryDate + 'T12:00:00');
                            if (isNaN(requestDate.getTime())) return false;
                            
                            const requestYear = requestDate.getFullYear();
                            const requestMonth = requestDate.getMonth() + 1;
                            
                            return requestYear === parseInt(year) && requestMonth === parseInt(month);
                        } catch (error) {
                            console.error('Error procesando fecha:', request.deliveryDate, error);
                            return false;
                        }
                    });
                    
                    console.log(`=== GENERANDO REPORTE MENSUAL PARA ${month}/${year} ===`);
                } else {
                    const startDate = biweekStartDate.value;
                    const endDate = biweekEndDate.value;
                    
                    if (!startDate || !endDate) {
                        displayMessage('Por favor seleccione ambas fechas para el periodo quincenal', 'error');
                        return;
                    }
                    
                    if (new Date(endDate) < new Date(startDate)) {
                        displayMessage('La fecha de fin debe ser mayor o igual a la fecha de inicio', 'error');
                        return;
                    }
                    
                    const diffTime = Math.abs(new Date(endDate) - new Date(startDate));
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 31) {
                        displayMessage('El periodo quincenal no debe exceder los 31 días', 'error');
                        return;
                    }
                    
                    reportTitle = `Reporte Quincenal - ${formatDateForDisplay(startDate)} a ${formatDateForDisplay(endDate)}`;
                    
                    filteredRequests = foodRequests.filter(request => {
                        if (!request.deliveryDate) return false;
                        
                        try {
                            const requestDateStr = request.deliveryDate;
                            const requestDate = new Date(requestDateStr + 'T00:00:00');
                            
                            const start = new Date(startDate + 'T00:00:00');
                            const end = new Date(endDate + 'T23:59:59.999');
                            
                            return requestDate >= start && requestDate <= end;
                        } catch (error) {
                            console.error('Error procesando fecha:', request.deliveryDate, error);
                            return false;
                        }
                    });
                    
                    console.log(`=== GENERANDO REPORTE QUINCENAL DEL ${startDate} AL ${endDate} ===`);
                }
                
                console.log(`Solicitudes filtradas: ${filteredRequests.length} de ${foodRequests.length} totales`);
                
                const departmentData = {};
                ALL_DEPARTMENTS.forEach(dept => {
                    departmentData[dept] = { meals: 0, amount: 0 };
                });
                
                const providerData = {};
                const unitProviderData = { 
                    CCS: {}, 
                    MSO: {} 
                };
                
                const msoDepartmentData = {};
                
                filteredRequests.forEach(request => {
                    const departmentKey = formatDepartmentName(mapDepartment(request.department, request.msoDepartment));
                    const providerKey = request.providerName || 'No especificado';
                    const unit = classifyUnit(request.department, request.msoDepartment);
                    const meals = parseInt(request.totalQuantity) || 0;
                    const amount = parseFloat(request.totalCost) || 0;
                    
                    if (departmentData[departmentKey]) {
                        departmentData[departmentKey].meals += meals;
                        departmentData[departmentKey].amount += amount;
                    }
                    
                    if (!providerData[providerKey]) {
                        providerData[providerKey] = { meals: 0, amount: 0 };
                    }
                    providerData[providerKey].meals += meals;
                    providerData[providerKey].amount += amount;
                    
                    if (unit === 'MSO') {
                        let msoSpecificKey = 'MSO';
                        if (request.msoDepartment) {
                            msoSpecificKey = `MSO (${request.msoDepartment})`;
                        }
                        
                        if (!unitProviderData['MSO'][msoSpecificKey]) {
                            unitProviderData['MSO'][msoSpecificKey] = { meals: 0, amount: 0 };
                        }
                        unitProviderData['MSO'][msoSpecificKey].meals += meals;
                        unitProviderData['MSO'][msoSpecificKey].amount += amount;
                    } else {
                        if (!unitProviderData['CCS'][providerKey]) {
                            unitProviderData['CCS'][providerKey] = { meals: 0, amount: 0 };
                        }
                        unitProviderData['CCS'][providerKey].meals += meals;
                        unitProviderData['CCS'][providerKey].amount += amount;
                    }
                });
                
                let totalMealsAll = 0;
                let totalAmountAll = 0;
                
                Object.values(departmentData).forEach(data => {
                    totalMealsAll += data.meals;
                    totalAmountAll += data.amount;
                });
                
                renderDepartmentReport(departmentData);
                renderProviderReport(providerData);
                calculateTotals(departmentData);
                renderUnitProviderReport(unitProviderData);
                
                verifyConsistency(totalMealsAll, totalAmountAll);
                
                exportReportBtn.classList.remove('hidden');
                exportPdfBtn.classList.remove('hidden');
                
                displayMessage(`Reporte generado: ${filteredRequests.length} solicitudes procesadas`, 'success');
            }

            function renderDepartmentReport(departmentData) {
                if (!departmentReportBody) return;
                departmentReportBody.innerHTML = '';
                
                let totalMeals = 0;
                let totalAmount = 0;
                
                Object.keys(departmentData)
                    .sort((a, b) => a.localeCompare(b, 'es'))
                    .forEach(deptKey => {
                        const data = departmentData[deptKey];
                        totalMeals += data.meals;
                        totalAmount += data.amount;
                        
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 border border-gray-300">
                                ${deptKey}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 text-center border border-gray-300">
                                ${data.meals}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 text-right border border-gray-300">
                                $${data.amount.toFixed(2)}
                            </td>
                        `;
                        departmentReportBody.appendChild(row);
                    });
                
                if (totalDepartmentMeals) totalDepartmentMeals.textContent = totalMeals;
                if (totalDepartmentAmount) totalDepartmentAmount.textContent = `$${totalAmount.toFixed(2)}`;
            }

            function renderProviderReport(providerData) {
                if (!providerReportBody) return;
                providerReportBody.innerHTML = '';
                
                let totalMeals = 0;
                let totalAmount = 0;
                
                Object.keys(providerData)
                    .sort((a, b) => providerData[b].meals - providerData[a].meals)
                    .forEach(providerKey => {
                        const data = providerData[providerKey];
                        totalMeals += data.meals;
                        totalAmount += data.amount;
                        
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 border border-gray-300">
                                ${providerKey}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 text-center border border-gray-300">
                                ${data.meals}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 text-right border border-gray-300">
                                $${data.amount.toFixed(2)}
                            </td>
                        `;
                        providerReportBody.appendChild(row);
                    });
                
                if (totalProviderMeals) totalProviderMeals.textContent = totalMeals;
                if (totalProviderAmount) totalProviderAmount.textContent = `$${totalAmount.toFixed(2)}`;
            }

            function calculateTotals(departmentData) {
                let ccsMeals = 0;
                let ccsAmount = 0;
                let msoMeals = 0;
                let msoAmount = 0;
                
                Object.keys(departmentData).forEach(deptKey => {
                    const data = departmentData[deptKey];
                    
                    if (deptKey.includes('MSO')) {
                        msoMeals += data.meals;
                        msoAmount += data.amount;
                    } else {
                        ccsMeals += data.meals;
                        ccsAmount += data.amount;
                    }
                });
                
                if (ccsTotalMeals) ccsTotalMeals.textContent = ccsMeals;
                if (ccsTotalAmount) ccsTotalAmount.textContent = `$${ccsAmount.toFixed(2)}`;
                if (msoTotalMeals) msoTotalMeals.textContent = msoMeals;
                if (msoTotalAmount) msoTotalAmount.textContent = `$${msoAmount.toFixed(2)}`;
                
                const grandTotalAmountValue = ccsAmount + msoAmount;
                if (grandTotalAmount) grandTotalAmount.textContent = `$${grandTotalAmountValue.toFixed(2)}`;
            }

            function renderUnitProviderReport(unitProviderData) {
                if (!unitProviderReportBody) return;
                unitProviderReportBody.innerHTML = '';
                
                let totalMeals = 0;
                let totalAmount = 0;
                
                const units = ['CCS', 'MSO'];
                
                units.forEach(unit => {
                    const unitData = unitProviderData[unit];
                    if (unitData && Object.keys(unitData).length > 0) {
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'bg-blue-50 font-bold';
                        headerRow.innerHTML = `
                            <td colspan="4" class="px-3 md:px-6 py-2 md:py-3 text-sm md:text-lg text-inter-primary border border-gray-300">
                                UNIDAD ${unit}
                            </td>
                        `;
                        unitProviderReportBody.appendChild(headerRow);
                        
                        Object.keys(unitData)
                            .filter(provider => unitData[provider].meals > 0)
                            .sort((a, b) => unitData[b].meals - unitData[a].meals)
                            .forEach(provider => {
                                const data = unitData[provider];
                                totalMeals += data.meals;
                                totalAmount += data.amount;
                                
                                const row = document.createElement('tr');
                                row.className = 'hover:bg-gray-50';
                                row.innerHTML = `
                                    <td class="px-3 md:px-6 py-2 md:py-4 text-xs md:text-sm text-gray-900 border border-gray-300"></td>
                                    <td class="px-3 md:px-6 py-2 md:py-4 text-xs md:text-sm text-gray-900 border border-gray-300">
                                        ${provider}
                                    </td>
                                    <td class="px-3 md:px-6 py-2 md:py-4 text-xs md:text-sm text-gray-900 text-center border border-gray-300">
                                        ${data.meals}
                                    </td>
                                    <td class="px-3 md:px-6 py-2 md:py-4 text-xs md:text-sm text-gray-900 text-right border border-gray-300">
                                        $${data.amount.toFixed(2)}
                                    </td>
                                `;
                                unitProviderReportBody.appendChild(row);
                            });
                        
                        const unitMeals = Object.keys(unitData)
                            .reduce((sum, provider) => sum + unitData[provider].meals, 0);
                        const unitAmount = Object.keys(unitData)
                            .reduce((sum, provider) => sum + unitData[provider].amount, 0);
                        
                        const subtotalRow = document.createElement('tr');
                        subtotalRow.className = 'bg-gray-100 font-bold';
                        subtotalRow.innerHTML = `
                            <td colspan="2" class="px-3 md:px-6 py-2 md:py-3 text-xs md:text-sm text-gray-900 border border-gray-300 text-right">
                                Subtotal ${unit}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-3 text-xs md:text-sm text-inter-primary text-center border border-gray-300">
                                ${unitMeals}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-3 text-xs md:text-sm text-inter-primary text-right border border-gray-300">
                                $${unitAmount.toFixed(2)}
                            </td>
                        `;
                        unitProviderReportBody.appendChild(subtotalRow);
                        
                        const spacerRow = document.createElement('tr');
                        spacerRow.innerHTML = '<td colspan="4" class="py-2"></td>';
                        unitProviderReportBody.appendChild(spacerRow);
                    }
                });
                
                if (totalUnitProviderMeals) totalUnitProviderMeals.textContent = totalMeals;
                if (totalUnitProviderAmount) totalUnitProviderAmount.textContent = `$${totalAmount.toFixed(2)}`;
            }

            function verifyConsistency(expectedMeals, expectedAmount) {
                const deptMeals = parseInt(totalDepartmentMeals ? totalDepartmentMeals.textContent : '0') || 0;
                const deptAmount = parseFloat(totalDepartmentAmount ? totalDepartmentAmount.textContent.replace('$', '') : '0') || 0;
                const provMeals = parseInt(totalProviderMeals ? totalProviderMeals.textContent : '0') || 0;
                const provAmount = parseFloat(totalProviderAmount ? totalProviderAmount.textContent.replace('$', '') : '0') || 0;
                const unitProvMeals = parseInt(totalUnitProviderMeals ? totalUnitProviderMeals.textContent : '0') || 0;
                const unitProvAmount = parseFloat(totalUnitProviderAmount ? totalUnitProviderAmount.textContent.replace('$', '') : '0') || 0;
                
                console.log('=== VERIFICACIÓN DE CONSISTENCIA ===');
                console.log(`Departamento: ${deptMeals} comidas, $${deptAmount.toFixed(2)}`);
                console.log(`Proveedor: ${provMeals} comidas, $${provAmount.toFixed(2)}`);
                console.log(`Unidad/Proveedor: ${unitProvMeals} comidas, $${unitProvAmount.toFixed(2)}`);
                console.log(`Esperado: ${expectedMeals} comidas, $${expectedAmount.toFixed(2)}`);
            }

            function exportReportToExcel() {
                if (currentProfile !== 'admin') return;
                
                const isMonthly = periodMonthly.checked;
                let fileName = '';
                
                if (isMonthly) {
                    const selectedMonth = reportMonthInput.value;
                    if (!selectedMonth) return;
                    
                    const [year, month] = selectedMonth.split('-');
                    const monthName = getMonthName(month);
                    fileName = `Reporte_Mensual_Comidas_${monthName}_${year}.csv`;
                } else {
                    const startDate = biweekStartDate.value;
                    const endDate = biweekEndDate.value;
                    
                    if (!startDate || !endDate) return;
                    
                    const startFormatted = formatDateForFilename(startDate);
                    const endFormatted = formatDateForFilename(endDate);
                    fileName = `Reporte_Quincenal_Comidas_${startFormatted}_${endFormatted}.csv`;
                }
                
                let csv = `Reporte de Gastos de Comida\n\n`;
                
                csv += "SOLICITUD DE COMIDAS POR UNIDAD DE OPERACIONES\n";
                csv += "UNIDAD DE OPERACION;CANTIDAD DE COMIDAS SOLICITADAS;IMPORTE\n";
                
                const departmentRows = Array.from(departmentReportBody.querySelectorAll('tr'));
                departmentRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        const dept = cells[0].textContent.replace(';', ',');
                        const meals = cells[1].textContent;
                        const amount = cells[2].textContent.replace('$', '').replace('.', ',');
                        csv += `${dept};${meals};${amount}\n`;
                    }
                });
                
                csv += `TOTAL;${totalDepartmentMeals.textContent};${totalDepartmentAmount.textContent.replace('$', '').replace('.', ',')}\n\n`;
                
                csv += "SOLICITUD DE COMIDAS POR PROVEEDOR\n";
                csv += "PROVEEDOR;CANTIDAD DE COMIDAS;IMPORTE\n";
                
                const providerRows = Array.from(providerReportBody.querySelectorAll('tr'));
                providerRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        const provider = cells[0].textContent.replace(';', ',');
                        const meals = cells[1].textContent;
                        const amount = cells[2].textContent.replace('$', '').replace('.', ',');
                        csv += `${provider};${meals};${amount}\n`;
                    }
                });
                
                csv += `TOTAL;${totalProviderMeals.textContent};${totalProviderAmount.textContent.replace('$', '').replace('.', ',')}\n\n`;
                
                csv += "SERVICIOS POR UNIDAD Y PROVEEDOR\n";
                csv += "UNIDAD;PROVEEDOR;CANTIDAD DE COMIDAS;IMPORTE\n";
                
                const unitProviderRows = Array.from(unitProviderReportBody.querySelectorAll('tr'));
                unitProviderRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 4) {
                        const unit = cells[0].textContent || '';
                        const provider = cells[1].textContent.replace(';', ',');
                        const meals = cells[2].textContent;
                        const amount = cells[3].textContent.replace('$', '').replace('.', ',');
                        
                        if (unit.trim() || provider.trim()) {
                            csv += `${unit};${provider};${meals};${amount}\n`;
                        }
                    } else if (cells.length === 1 && cells[0].colSpan === 4) {
                        const unit = cells[0].textContent.replace(';', ',');
                        csv += `${unit};;;;\n`;
                    }
                });
                
                csv += `TOTAL GENERAL;;${totalUnitProviderMeals.textContent};${totalUnitProviderAmount.textContent.replace('$', '').replace('.', ',')}\n\n`;
                
                csv += "RESUMEN POR TIPO DE UNIDAD\n";
                csv += `UNIDAD CCS Total Comidas;${ccsTotalMeals.textContent}\n`;
                csv += `UNIDAD CCS Importe Total;${ccsTotalAmount.textContent.replace('$', '').replace('.', ',')}\n`;
                csv += `UNIDAD MSO Total Comidas;${msoTotalMeals.textContent}\n`;
                csv += `UNIDAD MSO Importe Total;${msoTotalAmount.textContent.replace('$', '').replace('.', ',')}\n`;
                csv += `Total;${grandTotalAmount.textContent.replace('$', '').replace('.', ',')}\n`;
                
                const blob = new Blob(["\uFEFF", csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                displayMessage('Reporte exportado exitosamente', 'success');
            }

            async function exportReportToPDF() {
                if (currentProfile !== 'admin') return;
                
                const isMonthly = periodMonthly.checked;
                let periodText = '';
                
                if (isMonthly) {
                    const selectedMonth = reportMonthInput.value;
                    if (!selectedMonth) {
                        displayMessage('Por favor genere primero un reporte', 'error');
                        return;
                    }
                    
                    const [year, month] = selectedMonth.split('-');
                    const monthName = getMonthName(month);
                    periodText = `${monthName} ${year}`;
                } else {
                    const startDate = biweekStartDate.value;
                    const endDate = biweekEndDate.value;
                    
                    if (!startDate || !endDate) {
                        displayMessage('Por favor genere primero un reporte', 'error');
                        return;
                    }
                    
                    periodText = `${formatDateForDisplay(startDate)} a ${formatDateForDisplay(endDate)}`;
                }
                
                const today = new Date();
                const todayStr = today.toLocaleDateString('es-ES');
                
                displayMessage('Generando PDF...', 'success');
                
                try {
                    const departmentData = {};
                    ALL_DEPARTMENTS.forEach(dept => {
                        departmentData[dept] = { meals: 0, amount: 0 };
                    });
                    
                    let filteredRequests = [];
                    
                    if (isMonthly) {
                        const selectedMonth = reportMonthInput.value;
                        const [year, month] = selectedMonth.split('-');
                        
                        filteredRequests = foodRequests.filter(request => {
                            if (!request.deliveryDate) return false;
                            const requestDate = new Date(request.deliveryDate + 'T12:00:00');
                            if (isNaN(requestDate.getTime())) return false;
                            const requestYear = requestDate.getFullYear();
                            const requestMonth = requestDate.getMonth() + 1;
                            return requestYear === parseInt(year) && requestMonth === parseInt(month);
                        });
                    } else {
                        const startDate = biweekStartDate.value;
                        const endDate = biweekEndDate.value;
                        
                        filteredRequests = foodRequests.filter(request => {
                            if (!request.deliveryDate) return false;
                            const requestDate = new Date(request.deliveryDate + 'T00:00:00');
                            const start = new Date(startDate + 'T00:00:00');
                            const end = new Date(endDate + 'T23:59:59.999');
                            return requestDate >= start && requestDate <= end;
                        });
                    }
                    
                    filteredRequests.forEach(request => {
                        const departmentKey = formatDepartmentName(mapDepartment(request.department, request.msoDepartment));
                        const meals = parseInt(request.totalQuantity) || 0;
                        const amount = parseFloat(request.totalCost) || 0;
                        
                        if (departmentData[departmentKey]) {
                            departmentData[departmentKey].meals += meals;
                            departmentData[departmentKey].amount += amount;
                        }
                    });
                    
                    let totalMeals = 0;
                    let totalAmount = 0;
                    
                    let departmentRows = '';
                    Object.keys(departmentData)
                        .sort((a, b) => a.localeCompare(b, 'es'))
                        .forEach(dept => {
                            const data = departmentData[dept];
                            totalMeals += data.meals;
                            totalAmount += data.amount;
                            
                            departmentRows += `
                                <tr>
                                    <td style="padding: 3px; border: 1px solid #ddd; font-size: 6px;">${dept}</td>
                                    <td style="padding: 3px; border: 1px solid #ddd; text-align: center; font-size: 6px;">${data.meals}</td>
                                    <td style="padding: 3px; border: 1px solid #ddd; text-align: right; font-size: 6px;">$${data.amount.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                    
                    let providerRows = '';
                    const providerRowsElements = Array.from(providerReportBody.querySelectorAll('tr'));
                    providerRowsElements.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3) {
                            const provider = cells[0].textContent;
                            const meals = cells[1].textContent;
                            const amount = cells[2].textContent;
                            
                            providerRows += `
                                <tr>
                                    <td style="padding: 3px; border: 1px solid #ddd; font-size: 6px;">${provider}</td>
                                    <td style="padding: 3px; border: 1px solid #ddd; text-align: center; font-size: 6px;">${meals}</td>
                                    <td style="padding: 3px; border: 1px solid #ddd; text-align: right; font-size: 6px;">${amount}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    let unitProviderRows = '';
                    const unitProviderRowsElements = Array.from(unitProviderReportBody.querySelectorAll('tr'));
                    unitProviderRowsElements.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        
                        if (cells.length === 1 && cells[0].colSpan === 4) {
                            const unit = cells[0].textContent;
                            unitProviderRows += `
                                <tr style="background-color: #f0f7ff; font-weight: bold;">
                                    <td colspan="4" style="color: #005BAA; font-size: 8px; padding: 4px; border: 1px solid #ddd;">
                                        ${unit}
                                    </td>
                                </tr>
                            `;
                        } else if (cells.length === 4) {
                            const unit = cells[0].textContent || '';
                            const provider = cells[1].textContent;
                            const meals = cells[2].textContent;
                            const amount = cells[3].textContent;
                            
                            if (provider.trim()) {
                                unitProviderRows += `
                                    <tr>
                                        <td style="padding: 3px; border: 1px solid #ddd; font-size: 6px;">${unit}</td>
                                        <td style="padding: 3px; border: 1px solid #ddd; font-size: 6px;">${provider}</td>
                                        <td style="padding: 3px; border: 1px solid #ddd; text-align: center; font-size: 6px;">${meals}</td>
                                        <td style="padding: 3px; border: 1px solid #ddd; text-align: right; font-size: 6px;">${amount}</td>
                                    </tr>
                                `;
                            }
                        } else if (cells.length === 4 && cells[0].colSpan === 2) {
                            const label = cells[0].textContent;
                            const meals = cells[1].textContent;
                            const amount = cells[2].textContent;
                            
                            unitProviderRows += `
                                <tr style="background-color: #f9f9f9; font-weight: bold;">
                                    <td colspan="2" style="padding: 3px; border: 1px solid #ddd; font-size: 6px; text-align: right;">${label}</td>
                                    <td style="padding: 3px; border: 1px solid #ddd; text-align: center; color: #005BAA; font-size: 6px;">${meals}</td>
                                    <td style="padding: 3px; border: 1px solid #ddd; text-align: right; color: #005BAA; font-size: 6px;">${amount}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    let pdfHTML = `
                        <div class="report-pdf" style="font-family: 'Inter', sans-serif; max-width: 600px; margin: 0 auto;">
                            <div class="pdf-header" style="text-align: center; margin-bottom: 10px; border-bottom: 2px solid #005BAA; padding-bottom: 8px;">
                                <h1 class="pdf-title" style="color: #005BAA; font-size: 14px; font-weight: bold; margin-bottom: 3px;">
                                    Gastos de comida
                                </h1>
                                <div class="pdf-subtitle" style="color: #666; font-size: 10px; margin-bottom: 2px;">
                                    ${periodText}
                                </div>
                                <div class="pdf-subtitle" style="color: #666; font-size: 9px;">
                                    Fecha de generación: ${todayStr}
                                </div>
                            </div>
                            
                            <!-- Sección 1: Solicitud de Comidas por Unidad de Operación -->
                            <div class="pdf-section" style="margin-bottom: 12px;">
                                <h2 style="color: #005BAA; font-size: 11px; margin-bottom: 5px; border-bottom: 1px solid #005BAA; padding-bottom: 3px;">
                                    SOLICITUD DE COMIDAS POR UNIDAD DE OPERACIONES
                                </h2>
                                <table class="pdf-table" style="width: 100%; border-collapse: collapse; font-size: 7px;">
                                    <thead>
                                        <tr>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: left;">
                                                UNIDAD DE OPERACION
                                            </th>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: center;">
                                                CANTIDAD
                                            </th>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: right;">
                                                IMPORTE
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${departmentRows}
                                        <tr class="total-row" style="font-weight: bold; background-color: #f9f9f9;">
                                            <td style="padding: 4px; border: 1px solid #ddd; font-size: 7px;">TOTAL</td>
                                            <td style="padding: 4px; border: 1px solid #ddd; text-align: center; font-size: 7px;">${totalMeals}</td>
                                            <td style="padding: 4px; border: 1px solid #ddd; text-align: right; font-size: 7px;">$${totalAmount.toFixed(2)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Sección 2: Solicitud de Comidas por Proveedor -->
                            <div class="pdf-section" style="margin-bottom: 12px;">
                                <h2 style="color: #005BAA; font-size: 11px; margin-bottom: 5px; border-bottom: 1px solid #005BAA; padding-bottom: 3px;">
                                    SOLICITUD DE COMIDAS POR PROVEEDOR
                                </h2>
                                <table class="pdf-table" style="width: 100%; border-collapse: collapse; font-size: 7px;">
                                    <thead>
                                        <tr>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: left;">
                                                PROVEEDOR
                                            </th>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: center;">
                                                CANTIDAD
                                            </th>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: right;">
                                                IMPORTE
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${providerRows}
                                        <tr class="total-row" style="font-weight: bold; background-color: #f9f9f9;">
                                            <td style="padding: 4px; border: 1px solid #ddd; font-size: 7px;">TOTAL</td>
                                            <td style="padding: 4px; border: 1px solid #ddd; text-align: center; font-size: 7px;">${totalProviderMeals ? totalProviderMeals.textContent : '0'}</td>
                                            <td style="padding: 4px; border: 1px solid #ddd; text-align: right; font-size: 7px;">${totalProviderAmount ? totalProviderAmount.textContent : '$0.00'}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Sección 3: Resumen por Tipo de Unidad -->
                            <div class="pdf-section" style="margin-bottom: 12px;">
                                <h2 style="color: #005BAA; font-size: 11px; margin-bottom: 5px; border-bottom: 1px solid #005BAA; padding-bottom: 3px;">
                                    RESUMEN POR TIPO DE UNIDAD
                                </h2>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; gap: 10px;">
                                    <div class="pdf-summary-box" style="flex: 1; border: 1px solid #ddd; padding: 6px; border-radius: 3px; background-color: #f9f9f9;">
                                        <h3 style="color: #005BAA; font-size: 10px; margin-bottom: 5px; text-align: center;">UNIDAD CCS</h3>
                                        <div style="margin-bottom: 3px; display: flex; justify-content: space-between;">
                                            <span style="color: #666; font-size: 8px;">Total Comidas:</span>
                                            <span style="font-weight: bold; color: #005BAA; font-size: 8px;">${ccsTotalMeals ? ccsTotalMeals.textContent : '0'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #666; font-size: 8px;">Importe Total:</span>
                                            <span style="font-weight: bold; color: #005BAA; font-size: 8px;">${ccsTotalAmount ? ccsTotalAmount.textContent : '$0.00'}</span>
                                        </div>
                                    </div>
                                    <div class="pdf-summary-box" style="flex: 1; border: 1px solid #ddd; padding: 6px; border-radius: 3px; background-color: #f9f9f9;">
                                        <h3 style="color: #005BAA; font-size: 10px; margin-bottom: 5px; text-align: center;">UNIDAD MSO</h3>
                                        <div style="margin-bottom: 3px; display: flex; justify-content: space-between;">
                                            <span style="color: #666; font-size: 8px;">Total Comidas:</span>
                                            <span style="font-weight: bold; color: #005BAA; font-size: 8px;">${msoTotalMeals ? msoTotalMeals.textContent : '0'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #666; font-size: 8px;">Importe Total:</span>
                                            <span style="font-weight: bold; color: #005BAA; font-size: 8px;">${msoTotalAmount ? msoTotalAmount.textContent : '$0.00'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="text-align: center; padding: 8px; background-color: #f0f7ff; border-radius: 3px; border: 1px solid #005BAA; margin-top: 8px;">
                                    <div style="font-size: 10px; font-weight: bold; color: #005BAA; margin-bottom: 3px;">
                                        Total
                                    </div>
                                    <div style="font-size: 16px; font-weight: bold; color: #005BAA;">
                                        ${grandTotalAmount ? grandTotalAmount.textContent : '$0.00'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección 4: Servicios por Unidad y Proveedor -->
                            <div class="pdf-section" style="margin-bottom: 15px;">
                                <h2 style="color: #005BAA; font-size: 11px; margin-bottom: 5px; border-bottom: 1px solid #005BAA; padding-bottom: 3px;">
                                    SERVICIOS POR UNIDAD Y PROVEEDOR
                                </h2>
                                <table class="pdf-table" style="width: 100%; border-collapse: collapse; font-size: 6px;">
                                    <thead>
                                        <tr>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: left;">
                                                UNIDAD
                                            </th>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: left;">
                                                PROVEEDOR
                                            </th>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: center;">
                                                CANTIDAD
                                            </th>
                                            <th style="background-color: #f0f7ff; color: #005BAA; font-weight: bold; padding: 4px; border: 1px solid #ddd; text-align: right;">
                                                IMPORTE
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${unitProviderRows}
                                        <tr class="total-row" style="font-weight: bold; background-color: #f9f9f9;">
                                            <td colspan="2" style="padding: 4px; border: 1px solid #ddd; font-size: 7px;">TOTAL GENERAL</td>
                                            <td style="padding: 4px; border: 1px solid #ddd; text-align: center; color: #005BAA; font-size: 7px;">${totalUnitProviderMeals ? totalUnitProviderMeals.textContent : '0'}</td>
                                            <td style="padding: 4px; border: 1px solid #ddd; text-align: right; color: #005BAA; font-size: 7px;">${totalUnitProviderAmount ? totalUnitProviderAmount.textContent : '$0.00'}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pdf-footer" style="text-align: center; margin-top: 15px; padding-top: 8px; border-top: 1px solid #ddd; color: #666; font-size: 7px;">
                                <div style="margin-bottom: 2px;">Reporte generado el ${todayStr}</div>
                                <div>Control de Solicitud de Comidas - Inter</div>
                            </div>
                        </div>
                    `;
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = pdfHTML;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    tempDiv.style.top = '0';
                    tempDiv.style.width = '600px';
                    tempDiv.style.backgroundColor = 'white';
                    tempDiv.style.padding = '15px';
                    document.body.appendChild(tempDiv);
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const canvas = await html2canvas(tempDiv, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: 600,
                        height: tempDiv.scrollHeight,
                        windowWidth: 600
                    });
                    
                    document.body.removeChild(tempDiv);
                    
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    
                    if (imgHeight < pageHeight - 20) {
                        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    } else {
                        const scaleFactor = (pageHeight - 20) / imgHeight;
                        const scaledHeight = imgHeight * scaleFactor;
                        const scaledWidth = imgWidth * scaleFactor;
                        pdf.addImage(imgData, 'PNG', 10, 10, scaledWidth, scaledHeight);
                    }
                    
                    let pdfFileName = '';
                    if (isMonthly) {
                        const [year, month] = reportMonthInput.value.split('-');
                        const monthName = getMonthName(month);
                        pdfFileName = `Gastos_Comida_${monthName}_${year}.pdf`;
                    } else {
                        const startFormatted = formatDateForFilename(biweekStartDate.value);
                        const endFormatted = formatDateForFilename(biweekEndDate.value);
                        pdfFileName = `Gastos_Comida_${startFormatted}_${endFormatted}.pdf`;
                    }
                    
                    pdf.save(pdfFileName);
                    
                    displayMessage('PDF generado exitosamente', 'success');
                    
                } catch (error) {
                    console.error('Error generando PDF:', error);
                    displayMessage('Error al generar el PDF: ' + error.message, 'error');
                }
            }

            if (generateReportBtn) generateReportBtn.addEventListener('click', generateReport);
            if (exportReportBtn) exportReportBtn.addEventListener('click', exportReportToExcel);
            if (exportPdfBtn) exportPdfBtn.addEventListener('click', exportReportToPDF);

            // Actualizar UI según perfil
            updateUIForProfile();

            initializeForm();

            try {
                foodRequests = await loadRequests();
                
                // Aplicar filtro inicial según perfil
                let displayRequests = foodRequests.slice();
                if (currentProfile === 'presidencia') {
                    // CORRECCIÓN: Mostrar todas las solicitudes de MSO que sean de Presidencia O Personal Visitante
                    displayRequests = foodRequests.filter(req => 
                        req.department === 'MSO' && 
                        (req.msoDepartment === 'Presidencia' || req.msoDepartment === 'Personal Visitante')
                    );
                }
                
                renderTable(displayRequests);
                updateSummaryTotals(displayRequests);
                
                if (currentProfile === 'admin') {
                    updateCharts();
                    if (reportMonthInput && reportMonthInput.value) {
                        generateReport();
                    }
                }
                
                console.log("Página cargada y datos iniciales renderizados.");
            } catch (error) {
                console.error("Error al renderizar la página inicial:", error);
            }
        }
    </script>
</body>
</html>
