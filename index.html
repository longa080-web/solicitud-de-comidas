<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Solicitud de Comidas - Inter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Librerías para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Aplicar la fuente 'Inter' a todo el cuerpo del documento */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Definir colores personalizados basados en la marca Inter */
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .text-inter-primary { color: #005BAA; }
        .text-inter-accent-light { color: #5CE1E6; }
        .border-inter-primary { border-color: #005BAA; }
        .border-inter-accent-light { border-color: #5CE1E6; }
        .focus\:ring-inter-primary:focus { --tw-ring-color: #005BAA; }

        /* Ocultar el input de cantidad por defecto */
        .hidden-quantity {
            display: none;
        }
        
        /* Estilos para filtros avanzados */
        .filter-tag {
            background-color: #E3F2FD;
            color: #005BAA;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-flex;
            align-items: center;
        }
        
        .filter-tag-remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .filter-tag-remove:hover {
            color: #FF5252;
        }

        /* Estilos para el reporte en PDF */
        .report-pdf {
            background-color: white;
            padding: 20px;
            font-family: 'Inter', sans-serif;
        }
        
        .pdf-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #005BAA;
            padding-bottom: 15px;
        }
        
        .pdf-title {
            color: #005BAA;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .pdf-subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .pdf-section {
            margin-bottom: 20px;
            page-break-inside: avoid;
        }
        
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 11px;
        }
        
        .pdf-table th {
            background-color: #f0f7ff;
            color: #005BAA;
            font-weight: bold;
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .pdf-table td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        
        .pdf-table .total-row {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        
        .pdf-summary-box {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .pdf-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 10px;
        }
        
        /* ========== ESTILOS RESPONSIVOS AGREGADOS ========== */
        
        /* Ajustes generales para dispositivos móviles */
        @media (max-width: 768px) {
            .container-responsive {
                padding: 8px !important;
            }
            
            /* Ajuste del header */
            header h1 {
                font-size: 1.5rem !important;
                line-height: 1.3 !important;
            }
            
            header p.absolute {
                font-size: 1rem !important;
            }
            
            /* Formulario responsive */
            #foodRequestForm {
                display: flex !important;
                flex-direction: column !important;
                gap: 16px !important;
            }
            
            #foodRequestForm > div {
                width: 100% !important;
            }
            
            /* Campos del formulario */
            input, select, textarea {
                font-size: 16px !important; /* Previene zoom en iOS */
                min-height: 44px !important; /* Tamaño táctil mínimo */
            }
            
            /* Personal externo e Inter en columnas en móvil */
            .col-span-1 {
                grid-column: 1 / -1 !important;
            }
            
            /* Botones del formulario */
            #formActions {
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            #formActions button {
                width: 100% !important;
                margin-bottom: 8px !important;
            }
            
            /* Resumen de gastos */
            .grid-cols-1 {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            .text-3xl {
                font-size: 1.75rem !important;
            }
            
            /* NUEVO DISEÑO DE TABLA - SIN SCROLL HORIZONTAL */
            .table-responsive-cards {
                display: block !important;
            }
            
            .table-responsive-cards table {
                display: none !important;
            }
            
            .table-card {
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .table-card-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                padding-bottom: 8px;
                border-bottom: 1px solid #f3f4f6;
            }
            
            .table-card-row:last-child {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }
            
            .table-card-label {
                font-weight: 600;
                color: #374151;
                font-size: 0.875rem;
                min-width: 120px;
            }
            
            .table-card-value {
                color: #6b7280;
                font-size: 0.875rem;
                text-align: right;
                flex: 1;
                word-break: break-word;
            }
            
            .table-card-actions {
                display: flex;
                justify-content: flex-end;
                gap: 8px;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid #f3f4f6;
            }
            
            /* Texto más pequeño en móvil */
            .text-xs {
                font-size: 0.7rem !important;
            }
            
            .text-sm {
                font-size: 0.8rem !important;
            }
            
            /* Botones en sección de filtros */
            .flex-wrap {
                gap: 8px !important;
            }
            
            .flex-wrap button {
                flex: 1 1 calc(50% - 8px) !important;
                min-width: 0 !important;
                padding-left: 12px !important;
                padding-right: 12px !important;
                font-size: 0.8rem !important;
            }
            
            /* Reporte mensual */
            #reportContent table {
                font-size: 0.7rem !important;
            }
            
            #reportContent th, #reportContent td {
                padding: 4px 6px !important;
            }
            
            .grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
            
            /* Gráficos */
            .h-64, .h-96 {
                height: 300px !important;
            }
            
            .max-w-xl {
                max-width: 100% !important;
            }
            
            /* Modal de confirmación */
            .max-w-md {
                max-width: 90% !important;
                margin: 0 16px !important;
            }
            
            /* Scroll suave */
            html {
                scroll-behavior: smooth;
            }
        }
        
        /* Tablets */
        @media (min-width: 769px) and (max-width: 1024px) {
            .w-full.max-w-5xl {
                max-width: 95% !important;
            }
            
            /* Formulario en 2 columnas */
            #foodRequestForm {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            #foodRequestForm .col-span-1.md\:col-span-2,
            #foodRequestForm .col-span-1.md\:col-span-3 {
                grid-column: 1 / -1 !important;
            }
            
            /* NUEVO: Tabla compacta para tablets */
            table {
                font-size: 0.75rem !important;
            }
            
            .px-6 {
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
            
            .py-3, .py-4 {
                padding-top: 6px !important;
                padding-bottom: 6px !important;
            }
            
            /* Reducir ancho de columnas menos importantes */
            .compact-column {
                max-width: 80px !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Gráficos más compactos */
            .h-64 {
                height: 250px !important;
            }
            
            .h-96 {
                height: 350px !important;
            }
        }
        
        /* Pantallas grandes - mostrar tabla normal */
        @media (min-width: 1025px) {
            .table-responsive-cards {
                display: none !important;
            }
            
            .table-responsive-cards table {
                display: table !important;
            }
        }
        
        /* Pantallas pequeñas (móviles muy pequeños) */
        @media (max-width: 480px) {
            /* Header más compacto */
            header.py-6 {
                padding-top: 20px !important;
                padding-bottom: 20px !important;
            }
            
            header h1 {
                font-size: 1.25rem !important;
            }
            
            /* Botones full width */
            button {
                width: 100% !important;
                justify-content: center !important;
            }
            
            /* Input de búsqueda full width */
            #filterInput {
                width: 100% !important;
                margin-bottom: 8px !important;
            }
            
            /* Personal Inter - lista seleccionada */
            #interStaffSelected li {
                font-size: 0.8rem !important;
                padding: 6px !important;
            }
            
            /* Tabla en cards más compacta */
            .table-card {
                padding: 12px !important;
            }
            
            .table-card-label {
                min-width: 100px !important;
                font-size: 0.75rem !important;
            }
            
            .table-card-value {
                font-size: 0.75rem !important;
            }
            
            /* Modal más pequeño */
            .max-w-md {
                max-width: 95% !important;
                margin: 0 8px !important;
            }
        }
        
        /* Orientación landscape en móviles */
        @media (max-height: 600px) and (orientation: landscape) {
            /* Header más pequeño */
            header.py-6 {
                padding-top: 12px !important;
                padding-bottom: 12px !important;
            }
            
            /* Secciones con menos margen */
            section.mb-8 {
                margin-bottom: 16px !important;
            }
            
            /* Menor altura en gráficos */
            .h-64 {
                height: 200px !important;
            }
            
            .h-96 {
                height: 250px !important;
            }
        }
        
        /* Mejoras de accesibilidad táctil */
        @media (hover: none) and (pointer: coarse) {
            /* Elementos interactivos más grandes */
            button, 
            input[type="checkbox"], 
            input[type="radio"] {
                min-height: 44px !important;
                min-width: 44px !important;
            }
            
            /* Aumentar área táctil */
            .form-checkbox {
                transform: scale(1.3);
                margin-right: 8px;
            }
            
            /* Links y botones más espaciados */
            a, button {
                margin: 4px 0;
            }
            
            /* Prevenir zoom en inputs */
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* Dark mode opcional (si se implementa) */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a202c;
                color: #e2e8f0;
            }
            
            .bg-white {
                background-color: #2d3748 !important;
            }
            
            .bg-gray-100 {
                background-color: #4a5568 !important;
            }
            
            .text-gray-700 {
                color: #e2e8f0 !important;
            }
            
            .text-gray-500 {
                color: #a0aec0 !important;
            }
            
            .border-gray-300 {
                border-color: #4a5568 !important;
            }
            
            .bg-blue-50 {
                background-color: #2c5282 !important;
            }
            
            .table-card {
                background-color: #2d3748 !important;
                border-color: #4a5568 !important;
            }
            
            .table-card-row {
                border-color: #4a5568 !important;
            }
            
            .table-card-label {
                color: #e2e8f0 !important;
            }
            
            .table-card-value {
                color: #a0aec0 !important;
            }
        }
        
        /* Mejora para selects personalizados en móvil */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23005BAA'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.5rem;
            padding-right: 2.5rem !important;
        }
        
        /* NUEVO: Estilos para la tabla compacta en desktop */
        .compact-view {
            font-size: 0.75rem;
        }
        
        .compact-view th,
        .compact-view td {
            padding: 4px 6px;
        }
        
        .truncate-cell {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .expandable-cell {
            position: relative;
            cursor: pointer;
        }
        
        .expandable-cell:hover::after {
            content: attr(title);
            position: absolute;
            left: 0;
            top: 100%;
            background: #005BAA;
            color: white;
            padding: 8px;
            border-radius: 4px;
            white-space: normal;
            width: 300px;
            z-index: 1000;
            font-size: 0.875rem;
        }
        
        /* Alternar entre vista compacta y normal */
        .toggle-view-btn {
            background: #005BAA;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        
        .toggle-view-btn:hover {
            background: #004488;
        }
        
        /* NUEVO: Contenedor para botones de vista */
        .view-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
            gap: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-4 md:p-8 mb-8 container-responsive">
        <header class="text-center mb-4 md:mb-6 bg-inter-primary rounded-t-xl py-4 md:py-6 relative overflow-hidden">
            <h1 class="text-2xl md:text-4xl font-extrabold text-white mb-1 md:mb-2 relative z-10 px-2">
                Control de Solicitud de Comidas
            </h1>
            <p class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-lg md:text-2xl font-extrabold text-white opacity-10 whitespace-nowrap select-none pointer-events-none z-0 hidden md:block">
                Inter Tu mundo, nuestro compromiso.
            </p>
            <p class="text-sm md:text-md text-white mt-1 md:mt-2 relative z-10 px-2">Registro y gestión de solicitudes de comidas para el personal</p>
        </header>

        <section class="mb-6 md:mb-8 p-4 md:p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-3 md:mb-4">Registrar Nueva Solicitud de Comida</h2>
            <form id="foodRequestForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                        Departamento/Área
                    </label>
                    <select id="department" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" disabled selected>Selecciona un Departamento</option>
                        <option value="Administracion">Administración</option>
                        <option value="Area Comercial">Área Comercial</option>
                        <option value="C.O El Rosal">C.O El Rosal</option>
                        <option value="C.O La Naya">C.O La Naya</option>
                        <option value="C.O Los Ruices">C.O Los Ruices</option>
                        <option value="Gerencia Senior">Gerencia Senior</option>
                        <option value="Head End">Head End</option>
                        <option value="MSO">MSO</option>
                        <option value="Ocad">Ocad</option>
                        <option value="Obras">Obras</option>
                    </select>
                </div>
                
                <!-- Campo de observaciones para MSO -->
                <div id="msoObservationsContainer" class="hidden">
                    <label for="msoObservations" class="block text-sm font-medium text-gray-700 mb-1">
                        Departamento MSO específico
                    </label>
                    <select id="msoObservations"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" selected>Selecciona departamento MSO</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Presidencia">Presidencia</option>
                        <option value="Interconexiones">Interconexiones</option>
                        <option value="Importaciones">Importaciones</option>
                        <option value="RRHH MSO">RRHH MSO</option>
                        <option value="Documentacion de obras">Documentación de obras</option>
                    </select>
                </div>
                
                <div>
                    <label for="mealType" class="block text-sm font-medium text-gray-700 mb-1">
                        Tipo de Comida
                    </label>
                    <select id="mealType" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" disabled selected>Selecciona el Tipo</option>
                        <option value="Desayuno">Desayuno</option>
                        <option value="Almuerzo">Almuerzo</option>
                        <option value="Cena">Cena</option>
                        <option value="Refrigerios">Refrigerios</option>
                    </select>
                </div>
                <div>
                    <label for="event" class="block text-sm font-medium text-gray-700 mb-1">
                        Evento
                    </label>
                    <select id="event"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" disabled selected>Selecciona un Evento</option>
                        <option value="Evento extraordinario">Evento extraordinario</option>
                        <option value="Corte de fibra">Corte de fibra</option>
                        <option value="Mantenimiento de red">Mantenimiento de red</option>
                        <option value="Feeder y obras">Feeder y obras</option>
                        <option value="Ventas en calle">Ventas en calle</option>
                        <option value="Ventana de mantenimiento">Ventana de mantenimiento</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Personal Externo</label>
                    <div class="space-y-1 md:space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="checkCANTV" name="externalStaff" value="CANTV" class="form-checkbox h-5 w-5 md:h-4 md:w-4 text-inter-primary rounded">
                                <label for="checkCANTV" class="text-gray-700 text-sm md:text-base">CANTV</label>
                            </div>
                            <input type="number" id="quantityCANTV" min="0" value="0"
                                   class="w-16 md:w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                   placeholder="Cant">
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="checkEDC" name="externalStaff" value="EDC" class="form-checkbox h-5 w-5 md:h-4 md:w-4 text-inter-primary rounded">
                                <label for="checkEDC" class="text-gray-700 text-sm md:text-base">EDC</label>
                            </div>
                            <input type="number" id="quantityEDC" min="0" value="0"
                                   class="w-16 md:w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                   placeholder="Cant">
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="checkExternalOthers" name="externalStaff" value="ExternalOthers" class="form-checkbox h-5 w-5 md:h-4 md:w-4 text-inter-primary rounded">
                                <label for="checkExternalOthers" class="text-gray-700 text-sm md:text-base">Otros</label>
                            </div>
                            <input type="number" id="quantityExternalOthers" min="0" value="0"
                                   class="w-16 md:w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                   placeholder="Cant">
                        </div>
                    </div>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Personal Inter</label>
                    <div class="relative">
                        <input type="text" id="interStaffSearch" placeholder="Buscar personal de Inter..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                        <ul id="interStaffSearchResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                    </div>
                    <ul id="interStaffSelected" class="mt-2 space-y-1 md:space-y-2 max-h-32 overflow-y-auto">
                        </ul>
                </div>

                <div class="col-span-1">
                    <label for="totalQuantity" class="block text-sm font-medium text-gray-700 mb-1">
                        Total de Comidas
                    </label>
                    <input type="number" id="totalQuantity" min="0" value="0" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed text-sm md:text-base">
                </div>
                
                <div class="col-span-1 md:col-span-2">
                    <label for="deliveryPlace" class="block text-sm font-medium text-gray-700 mb-1">
                        Lugar de Entrega
                    </label>
                    <input type="text" id="deliveryPlace" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                           placeholder="Ej. Administración, Sede Principal, Campo (con dirección)">
                </div>
                <div>
                    <label for="deliveryDateTime" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha de Entrega
                    </label>
                    <input type="date" id="deliveryDateTime" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                </div>
                <div>
                    <label for="unitCost" class="block text-sm font-medium text-gray-700 mb-1">
                        Costo Unitario Comida (USD $)
                    </label>
                    <input type="number" id="unitCost" step="0.01" min="0" value="0.00" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Costo de Delivery
                    </label>
                    <div class="flex items-center space-x-3 md:space-x-4 mb-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="deliveryOption" value="free" checked
                                   class="form-radio text-inter-primary h-4 w-4 md:h-4 md:w-4" id="deliveryFree">
                            <span class="ml-2 text-gray-700 text-sm md:text-base">Gratuito</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="deliveryOption" value="cost"
                                   class="form-radio text-inter-primary h-4 w-4 md:h-4 md:w-4" id="deliveryCostOption">
                            <span class="ml-2 text-gray-700 text-sm md:text-base">Con costo</span>
                        </label>
                    </div>
                    <input type="number" id="deliveryCost" step="0.01" min="0" value="0.00"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary hidden text-sm md:text-base"
                           placeholder="Costo de Delivery ($)">
                </div>
                <div>
                    <label for="cost" class="block text-sm font-medium text-gray-700 mb-1">
                        Costo Total (USD $)
                    </label>
                    <input type="number" id="cost" step="0.01" min="0" value="0.00" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary bg-gray-100 cursor-not-allowed text-sm md:text-base">
                </div>
                <div>
                    <label for="providerName" class="block text-sm font-medium text-gray-700 mb-1">
                        Nombre del Proveedor
                    </label>
                    <select id="providerName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" disabled selected>Selecciona un Proveedor</option>
                        <option value="Al momento">Al momento</option>
                        <option value="Monteluso">Monteluso</option>
                        <option value="Susi fresh">Susi fresh</option>
                        <option value="Cumbes Barlovento">Cumbes Barlovento</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-3">
                    <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">
                        Motivo de la Solicitud (Obligatorio para justificar)
                    </label>
                    <textarea id="reason" rows="3" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                                 placeholder="Ej. Personal de Área Técnica trabajando en proyecto X fuera de horario, Área Comercial en visita a cliente en Y."></textarea>
                </div>
                <div class="col-span-1 md:col-span-3 flex flex-col sm:flex-row justify-end items-center gap-3 md:gap-4" id="formActions">
                    <button type="submit"
                            class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-4 md:py-2 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                        Registrar Solicitud
                    </button>
                    </div>
            </form>
            <div id="messageBox" class="mt-4 p-3 rounded-md text-sm hidden"></div>
        </section>

        <section class="mb-6 md:mb-8 p-4 md:p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-3 md:mb-4">Resumen de Gastos de Comidas</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 text-center">
                <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                    <h3 class="text-base md:text-lg font-semibold text-gray-700">Gastos Diarios</h3>
                    <p id="dailyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary mt-1 md:mt-2">$0.00</p>
                </div>
                <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                    <h3 class="text-base md:text-lg font-semibold text-gray-700">Gastos Semanales</h3>
                    <p id="weeklyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary mt-1 md:mt-2">$0.00</p>
                </div>
                <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                    <h3 class="text-base md:text-lg font-semibold text-gray-700">Gastos Mensuales</h3>
                    <p id="monthlyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary mt-1 md:mt-2">$0.00</p>
                </div>
            </div>
        </section>

        <section class="p-4 md:p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <div class="flex justify-between items-center mb-3 md:mb-4">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary">Historial de Solicitudes de Comida</h2>
                <div class="view-controls">
                    <button id="toggleCompactView" class="toggle-view-btn">
                        Vista Compacta
                    </button>
                </div>
            </div>

            <div class="mb-4 p-4 bg-blue-50 rounded-lg flex flex-col md:flex-row items-center gap-3 md:gap-4">
                <div class="w-full">
                    <label for="filterInput" class="block text-sm font-medium text-gray-700 mb-2">
                        Filtros de Búsqueda Avanzada
                    </label>
                    <div class="flex flex-col sm:flex-row items-center gap-2 mb-2">
                        <input type="text" id="filterInput"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                               placeholder="Buscar por nombre, departamento, tipo...">
                        <button id="addFilterBtn"
                                class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto mt-2 sm:mt-0">
                            Añadir Filtro
                        </button>
                    </div>
                    
                    <div id="activeFilters" class="flex flex-wrap gap-2 mb-2">
                        <!-- Aquí se mostrarán los filtros activos -->
                    </div>
                    
                    <div class="flex flex-col sm:flex-row flex-wrap gap-2">
                        <button id="clearAllFiltersBtn"
                                class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto">
                            Limpiar Todos los Filtros
                        </button>
                        <button id="exportCsvBtn"
                                class="bg-inter-accent-light hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto">
                            Exportar a Excel (CSV)
                        </button>
                        <button id="deleteSelectedBtn"
                                class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto">
                            Eliminar Seleccionados
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vista normal de tabla para desktop -->
            <div id="tableView" class="overflow-x-auto rounded-lg shadow-md hidden md:block">
                <table id="foodTable" class="min-w-full divide-y divide-gray-200 compact-view">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">
                                <input type="checkbox" id="selectAllCheckboxes" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Fecha</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider truncate-cell" title="Departamento">Depto</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Tipo</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider truncate-cell" title="Personal Externo">Ext.</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider truncate-cell" title="Personal Inter">Inter</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Total</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-inter-primary uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="foodTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos se llenarán dinámicamente -->
                    </tbody>
                </table>
            </div>

            <!-- Vista de tarjetas para móviles -->
            <div id="cardsView" class="table-responsive-cards md:hidden">
                <!-- Las tarjetas se generarán dinámicamente aquí -->
            </div>

            <p id="noRequestsMessage" class="text-center text-gray-500 mt-4 hidden">No hay solicitudes de comida registradas aún.</p>
        </section>

        <!-- NUEVA SECCIÓN: REPORTE MENSUAL DE GASTOS -->
        <section class="mt-6 md:mt-8 p-4 md:p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-3 md:mb-4">Reporte Mensual de Gastos</h2>
            
            <div class="mb-4 md:mb-6">
                <label for="reportMonth" class="block text-sm font-medium text-gray-700 mb-2">
                    Seleccionar Mes y Año para el Reporte
                </label>
                <div class="flex flex-col sm:flex-row flex-wrap items-center gap-3 md:gap-4">
                    <input type="month" id="reportMonth" 
                           class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary w-full sm:w-auto text-sm md:text-base"
                           value="">
                    <button id="generateReportBtn" 
                            class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out whitespace-nowrap w-full sm:w-auto">
                        Generar Reporte
                    </button>
                    <button id="exportReportBtn" 
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out hidden whitespace-nowrap w-full sm:w-auto">
                        Exportar a Excel
                    </button>
                    <button id="exportPdfBtn" 
                            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out hidden whitespace-nowrap w-full sm:w-auto">
                        Exportar a PDF
                    </button>
                </div>
            </div>

            <!-- Contenedor oculto para el PDF -->
            <div id="pdfContent" class="hidden">
                <!-- Este contenido se generará dinámicamente para el PDF -->
            </div>

            <div id="reportContent" class="space-y-6 md:space-y-8">
                <!-- Sección 1: Solicitud de Comidas por Unidad de Operación -->
                <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                    <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4">SOLICITUD DE COMIDAS POR UNIDAD DE OPERACIONES</h3>
                    <div class="responsive-table-container">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-300 text-sm">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        UNIDAD DE OPERACION
                                    </th>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        CANTIDAD
                                    </th>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        IMPORTE
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="departmentReportBody" class="bg-white divide-y divide-gray-200">
                                <!-- Los datos se llenarán dinámicamente -->
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-gray-900 border border-gray-300">
                                        TOTAL
                                    </td>
                                    <td id="totalDepartmentMeals" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                        0
                                    </td>
                                    <td id="totalDepartmentAmount" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                        $0.00
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Sección 2: Solicitud de Comidas por Proveedor -->
                <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                    <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4">SOLICITUD DE COMIDAS POR PROVEEDOR</h3>
                    <div class="responsive-table-container">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-300 text-sm">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        PROVEEDOR
                                    </th>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        CANTIDAD
                                    </th>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        IMPORTE
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="providerReportBody" class="bg-white divide-y divide-gray-200">
                                <!-- Los datos se llenarán dinámicamente -->
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-gray-900 border border-gray-300">
                                        TOTAL
                                    </td>
                                    <td id="totalProviderMeals" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                        0
                                    </td>
                                    <td id="totalProviderAmount" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                        $0.00
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Sección 3: Resumen por Tipo de Unidad -->
                <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                    <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4">RESUMEN POR TIPO DE UNIDAD</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <div class="bg-white p-3 md:p-4 rounded-lg border border-gray-300">
                            <h4 class="text-base md:text-lg font-semibold text-gray-700 mb-1 md:mb-2">UNIDAD CCS</h4>
                            <div class="space-y-1 md:space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 text-sm md:text-base">Total Comidas:</span>
                                    <span id="ccsTotalMeals" class="font-bold text-inter-primary text-sm md:text-base">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 text-sm md:text-base">Importe Total:</span>
                                    <span id="ccsTotalAmount" class="font-bold text-inter-primary text-sm md:text-base">$0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-3 md:p-4 rounded-lg border border-gray-300">
                            <h4 class="text-base md:text-lg font-semibold text-gray-700 mb-1 md:mb-2">UNIDAD MSO</h4>
                            <div class="space-y-1 md:space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 text-sm md:text-base">Total Comidas:</span>
                                    <span id="msoTotalMeals" class="font-bold text-inter-primary text-sm md:text-base">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 text-sm md:text-base">Importe Total:</span>
                                    <span id="msoTotalAmount" class="font-bold text-inter-primary text-sm md:text-base">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 md:mt-4 pt-3 md:pt-4 border-t border-gray-300">
                        <div class="flex justify-between items-center">
                            <span class="text-base md:text-lg font-bold text-gray-700">GRAN TOTAL MENSUAL:</span>
                            <span id="grandTotalAmount" class="text-xl md:text-2xl font-extrabold text-inter-primary">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- NUEVA SECCIÓN: Servicios por Unidad y Proveedor -->
                <div class="bg-gray-50 p-3 md:p-4 rounded-lg mt-4 md:mt-6">
                    <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4">
                        SERVICIOS POR UNIDAD Y PROVEEDOR
                    </h3>
                    <div class="responsive-table-container">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-300 text-sm">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        UNIDAD
                                    </th>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        PROVEEDOR
                                    </th>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        CANTIDAD
                                    </th>
                                    <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-medium text-inter-primary uppercase tracking-wider border border-gray-300">
                                        IMPORTE
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="unitProviderReportBody" class="bg-white divide-y divide-gray-200">
                                <!-- Los datos se llenarán dinámicamente -->
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td colspan="2" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-gray-900 border border-gray-300">
                                        TOTAL GENERAL
                                    </td>
                                    <td id="totalUnitProviderMeals" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                        0
                                    </td>
                                    <td id="totalUnitProviderAmount" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs md:text-sm font-bold text-inter-primary border border-gray-300">
                                        $0.00
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section class="mt-6 md:mt-8 p-4 md:p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-3 md:mb-4">Análisis de Gastos</h2>

            <div class="mb-4 md:mb-6">
                <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Gastos Mensuales (Mes Actual)</h3>
                <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                    <div class="w-full h-48 md:h-64">
                        <canvas id="monthlyProvidersChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="mb-4 md:mb-6">
                <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Gastos Anuales por Proveedor</h3>
                <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                    <div class="w-full h-48 md:h-64">
                        <canvas id="annualProvidersChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 md:mb-6">
                <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Comportamiento de Gastos Mensual por Departamento</h3>
                <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                    <div class="w-full h-64 md:h-96">
                        <canvas id="departmentExpensesChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 md:mb-6">
                <h3 id="staffRequestsChartTitle" class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Cantidad de Solicitudes por Empleado de Inter</h3>
                <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                    <div class="w-full max-w-xl h-64 md:h-96 mx-auto">
                        <canvas id="staffRequestsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="mb-4 md:mb-6">
                <h3 id="departmentRequestsChartTitle" class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Cantidad de Solicitudes por Departamento</h3>
                <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner">
                    <div class="w-full max-w-xl h-48 md:h-64 mx-auto">
                        <canvas id="departmentRequestsChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-3 md:mb-4">Confirmar Eliminación</h3>
            <p class="mb-3 md:mb-4 text-sm md:text-base" id="modalText">¿Estás seguro de que quieres eliminar la(s) solicitud(es) seleccionada(s)? Esta acción no se puede deshacer.</p>
            <div class="flex flex-col sm:flex-row justify-end gap-3 md:gap-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Cancelar</button>
                <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            deleteDoc, 
            doc, 
            query, 
            orderBy,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDwGgTGRkaEO4SzVR-5KqM3K66Istba0a4",
            authDomain: "control-solicitudes-de-comida.firebaseapp.com",
            projectId: "control-solicitudes-de-comida",
            storageBucket: "control-solicitudes-de-comida.firebasestorage.app",
            messagingSenderId: "255909685257",
            appId: "1:255909685257:web:98e9d0697b374fdf32b0d8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Hacer las funciones de Firebase disponibles globalmente
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseFunctions = {
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            query,
            orderBy,
            where
        };

        console.log("Firebase inicializado correctamente");
    </script>

    <script>
        // Variables globales para Firebase
        let db;
        let firebaseFunctions;

        // Referencias a jsPDF (disponible globalmente)
        const { jsPDF } = window.jspdf;

        // Variable para controlar la vista compacta
        let compactView = false;

        document.addEventListener('DOMContentLoaded', async () => {
            // Esperar a que Firebase esté listo
            if (!window.firebaseDb || !window.firebaseFunctions) {
                console.error("Firebase no se inicializó correctamente");
                displayMessage('Error: Firebase no se pudo inicializar', 'error');
                return;
            }

            // Asignar las referencias de Firebase
            db = window.firebaseDb;
            firebaseFunctions = window.firebaseFunctions;

            console.log("Firebase configurado correctamente en la aplicación");

            const form = document.getElementById('foodRequestForm');
            const departmentSelect = document.getElementById('department');
            const msoObservationsContainer = document.getElementById('msoObservationsContainer');
            const msoObservationsSelect = document.getElementById('msoObservations');
            const mealTypeSelect = document.getElementById('mealType');
            const eventSelect = document.getElementById('event');

            // Referencias a los campos de personal externo
            const checkCANTV = document.getElementById('checkCANTV');
            const quantityCANTV = document.getElementById('quantityCANTV');
            const checkEDC = document.getElementById('checkEDC');
            const quantityEDC = document.getElementById('quantityEDC');
            const checkExternalOthers = document.getElementById('checkExternalOthers');
            const quantityExternalOthers = document.getElementById('quantityExternalOthers');
            const totalQuantityInput = document.getElementById('totalQuantity');

            // Nuevas referencias para el buscador de personal Inter
            const interStaffSearchInput = document.getElementById('interStaffSearch');
            const interStaffSearchResults = document.getElementById('interStaffSearchResults');
            const interStaffSelectedList = document.getElementById('interStaffSelected');
            
            // Referencias a campos de la solicitud
            const deliveryPlaceInput = document.getElementById('deliveryPlace');
            const deliveryDateTimeInput = document.getElementById('deliveryDateTime');
            const unitCostInput = document.getElementById('unitCost');
            const deliveryCostInput = document.getElementById('deliveryCost');
            const deliveryCostOption = document.getElementById('deliveryCostOption');
            const deliveryFree = document.getElementById('deliveryFree');
            const costInput = document.getElementById('cost');
            const providerNameSelect = document.getElementById('providerName');
            const reasonTextarea = document.getElementById('reason');
            const formActionsContainer = document.getElementById('formActions');

            // Referencias de la tabla e interfaz
            const tableBody = document.getElementById('foodTableBody');
            const cardsView = document.getElementById('cardsView');
            const noRequestsMessage = document.getElementById('noRequestsMessage');
            const messageBox = document.getElementById('messageBox');
            const tableView = document.getElementById('tableView');
            const toggleCompactViewBtn = document.getElementById('toggleCompactView');
            
            // Referencias para el filtro avanzado
            const filterInput = document.getElementById('filterInput');
            const addFilterBtn = document.getElementById('addFilterBtn');
            const activeFiltersContainer = document.getElementById('activeFilters');
            const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const selectAllCheckboxes = document.getElementById('selectAllCheckboxes');
            const submitButton = form.querySelector('button[type="submit"]');

            // Referencias para los modales
            const deleteModal = document.getElementById('deleteModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const modalText = document.getElementById('modalText');
            
            // Elementos para el resumen de gastos
            const dailyTotalEl = document.getElementById('dailyTotal');
            const weeklyTotalEl = document.getElementById('weeklyTotal');
            const monthlyTotalEl = document.getElementById('monthlyTotal');

            // Gráficos
            let monthlyProvidersChart = null;
            let annualProvidersChart = null;
            let departmentExpensesChart = null;
            let departmentRequestsChart = null;
            let staffRequestsChart = null;

            // Constantes y Variables Globales
            const CHART_COLORS = { 
                'Al momento': '#005BAA',
                'Monteluso': '#5CE1E6',
                'Susi fresh': '#00B8D9',
                'Cumbes Barlovento': '#FF9800',
                'otros': '#667EEA',
                'fondo': '#E2E8F0' 
            };
            
            let foodRequests = [];
            let selectedInterStaff = [];
            let editingRequestId = null;
            let activeFilters = [];
            
            const staffList = [
                { id: 1, name: "BLANCO NEISABEL" },
                { id: 2, name: "VILLAMIZAR NANCY" },
                { id: 3, name: "CASTILLO TIBET" },
                { id: 4, name: "QUINTERO ROSANA" },
                { id: 5, name: "GONZALEZ LINO" },
                { id: 6, name: "MORILLO ANA" },
                { id: 7, name: "CARTAYA LENNYIS" },
                { id: 8, name: "DELGADO JONATHAN" },
                { id: 9, name: "TRONCOSO LAIS" },
                { id: 10, name: "BRITO RONEY" },
                { id: 11, name: "MUÑOZ KELVIN" },
                { id: 12, name: "GALEA CESAR" },
                { id: 13, name: "MORENO GEINES" },
                { id: 14, name: "MACHADO JOSE" },
                { id: 15, name: "SUAREZ KIR" },
                { id: 16, name: "JIMENEZ DAIRELI" },
                { id: 17, name: "GARCIA ANGELICA" },
                { id: 18, name: "CONTRERAS NOELIA" },
                { id: 19, name: "VEGAS ENYMAR" },
                { id: 20, name: "GOMEZ SAMUEL" },
                { id: 21, name: "LONGA JESUS" },
                { id: 22, name: "QUIJADA WILFREDO" },
                { id: 23, name: "PINO ALEJANDRO" },
                { id: 24, name: "AMORUZO ANGELO" },
                { id: 25, name: "CHINCHILLA OSMEL" },
                { id: 26, name: "TERAN CASTO" },
                { id: 27, name: "FERRER GABRIEL" },
                { id: 28, name: "TOVAR LUIS" },
                { id: 29, name: "ORTA WILNER" },
                { id: 30, name: "TORRES KEIVER" },
                { id: 31, name: "RODRIGUEZ MISAEL" },
                { id: 32, name: "CASTILLO JHOAN" },
                { id: 33, name: "VILLEGAS OSMER" },
                { id: 34, name: "RAMOS FREDDY" },
                { id: 35, name: "TOVAR JAIRO" },
                { id: 36, name: "PEREZ LUIS" },
                { id: 37, name: "BRITO JOSE" },
                { id: 38, name: "ASCANIO FELIX" },
                { id: 39, name: "CORONADO MIGUEL" },
                { id: 40, name: "HELLO ALBANY" },
                { id: 41, name: "PIRELA WILMER" },
                { id: 42, name: "CASTELLANOS FRANKLIN" },
                { id: 43, name: "JIMENEZ RONMEL" },
                { id: 44, name: "PRIETO JAVIER" },
                { id: 45, name: "LARA EDUARDO" },
                { id: 46, name: "CASANOVA FABIAN" },
                { id: 47, name: "CASTILLO ORIANA" },
                { id: 48, name: "GARRIDO ADOLFO" },
                { id: 49, name: "MORENO JOELIMAR" },
                { id: 50, name: "CENTENO LUIS" },
                { id: 51, name: "NEGRIN CARLOS" },
                { id: 52, name: "LADERA DAYANA" },
                { id: 53, name: "PEREZ NELSON" },
                { id: 54, name: "CHACON EDUARDO" },
                { id: 55, name: "UZCATEGUI DARWIN" },
                { id: 56, name: "VALENZUELA CARLOS" },
                { id: 57, name: "TORRES CARLOS" },
                { id: 58, name: "LOPEZ JIM" },
                { id: 59, name: "RAMOS LISMAR" },
                { id: 60, name: "CHIRINOS RHONY" },
                { id: 61, name: "MORALES JOSUE" },
                { id: 62, name: "DELGADO BRAYAN" },
                { id: 63, name: "REVERON ROGELIO" },
                { id: 64, name: "CEDEÑO LEONEL" },
                { id: 65, name: "UZCATEGUI BREINER" },
                { id: 66, name: "HERNANDEZ RAFAEL" },
                { id: 67, name: "VILLAMIZAR YOHAN" },
                { id: 68, name: "CASTRO MANUEL" },
                { id: 69, name: "BRICEÑO ALEXY" },
                { id: 70, name: "GONZALEZ JUAN" },
                { id: 71, name: "ROCA YUNIOR" },
                { id: 72, name: "DIAZ MANUEL" },
                { id: 73, name: "ZERPA ODREIMY" },
                { id: 74, name: "DIAZ ENNIO" },
                { id: 75, name: "MANRIQUE LUIS" },
                { id: 76, name: "RODRIGUEZ FELIX" },
                { id: 77, name: "GARCIA ANGEL" },
                { id: 78, name: "TONITO JULIO" },
                { id: 79, name: "GARCIA EDNEY" },
                { id: 80, name: "CASTRILLO MANUEL" },
                { id: 81, name: "GUERRERO GABRIEL" },
                { id: 82, name: "MATHEUS FERNANDO" },
                { id: 83, name: "GARCIA LUIS" },
                { id: 84, name: "VELASQUEZ JOSE" },
                { id: 85, name: "PERNETT CESAR" },
                { id: 86, name: "RODRIGUEZ OMAR" },
                { id: 87, name: "RAMIREZ DARWIN" },
                { id: 88, name: "YEMES GUILLERMO" },
                { id: 89, name: "BAZAN WILLIAMS" },
                { id: 90, name: "RAMIREZ FRANKLIN" },
                { id: 91, name: "LOPEZ JORGE" },
                { id: 92, name: "RAMOS ROBERT" },
                { id: 93, name: "SANCHEZ GONZALO" },
                { id: 94, name: "GARCIA CARLOS" },
                { id: 95, name: "MENESES KELVIS" },
                { id: 96, name: "MACHADO DANNY" },
                { id: 97, name: "ROMERO LUIS" },
                { id: 98, name: "PALACIOS LUIS" },
                { id: 99, name: "HERNANDEZ SERGIO" },
                { id: 100, name: "VERGARA JORGE" },
                { id: 101, name: "BARRETO ANDRES" },
                { id: 102, name: "HERNANDEZ LUIS" },
                { id: 103, name: "MALDONADO DYLAN" },
                { id: 104, name: "OLIVARES JOHN" },
                { id: 105, name: "CASTILLO JUNIOR" },
                { id: 106, name: "MORA DYLAN" },
                { id: 107, name: "JULIO DANIEL" },
                { id: 108, name: "CARVAJAL JOSE" },
                { id: 109, name: "BLANCO EDWAR" },
                { id: 110, name: "POSADA RAMON" },
                { id: 111, name: "GUZMAN CESAR" },
                { id: 112, name: "CAMPOS ARQUIMEDES" },
                { id: 113, name: "ROJAS RONALD" },
                { id: 114, name: "MOSQUERA JAVIER" },
                { id: 115, name: "ESCORCIA ELITH" },
                { id: 116, name: "VASQUEZ VICTOR" },
                { id: 117, name: "ESCALONA WUILMER" },
                { id: 118, name: "YEPEZ CESAR" },
                { id: 119, name: "QUINTERO OSCAR" },
                { id: 120, name: "MACHADO CARLOS" },
                { id: 121, name: "APONTE YOSKARLA" },
                { id: 122, name: "AZUAJE YAMILETH" },
                { id: 123, name: "VALERO VANESA" },
                { id: 124, name: "GIL DEMIAN" },
                { id: 125, name: "MALVACEA ALANY" },
                { id: 126, name: "FIGUERA REBECA" },
                { id: 127, name: "VIVENES YETZIBEL" },
                { id: 128, name: "BERRIOS RAIDEL" },
                { id: 129, name: "URBAEZ HEISHMAR" },
                { id: 130, name: "PEREZ JEIZER" },
                { id: 131, name: "LABRADOR DAVID" },
                { id: 132, name: "VELASQUEZ JOSE" },
                { id: 133, name: "MARQUEZ BETANIA" },
                { id: 134, name: "GASCA ALEXANDRO" },
                { id: 135, name: "RIVERO SIMON" },
                { id: 136, name: "MARRON FABRIZIO" },
                { id: 137, name: "APONTE AHIBRAN" },
                { id: 138, name: "TORRES CESAR" },
                { id: 139, name: "PACHECO ESCARLET" },
                { id: 140, name: "FERNANDEZ JORGE" },
                { id: 141, name: "MARQUEZ ACXEL" },
                { id: 142, name: "BARON YOSMAR" },
                { id: 143, name: "SANCHEZ SARAI" },
                { id: 144, name: "GALVAN RICARDO" },
                { id: 145, name: "SIERRA DAVID" },
                { id: 146, name: "SERRANO WILLIANA" },
                { id: 147, name: "ESCORCHE VICTORIA" },
                { id: 148, name: "LEDEZMA RALTH" },
                { id: 149, name: "ORTIZ KATHERINE" },
                { id: 150, name: "SANCHEZ ADRIANA" },
                { id: 151, name: "RODRIGUEZ MERLIN" },
                { id: 152, name: "VAMONDE JOSE" },
                { id: 153, name: "MARTINEZ MARINA" },
                { id: 154, name: "BORDONARO SEBASTIAN" },
                { id: 155, name: "LISCANO YAILETH" },
                { id: 156, name: "PEREZ JENNYFER" },
                { id: 157, name: "CARRERO JOSHUA" },
                { id: 158, name: "BASUALDO JORGE" },
                { id: 159, name: "URBINA GENESIS" },
                { id: 160, name: "MAGALLANES LUIS" },
                { id: 161, name: "LEAL GREGORYS" },
                { id: 162, name: "ESCALONA KARLA" },
                { id: 163, name: "BRICEÑO ALEXA" },
                { id: 164, name: "RUIZ EDGAR" },
                { id: 165, name: "CEBALLOS LEONID" },
                { id: 166, name: "RUIZ IONA" }
            ];

            // --- Elementos del Reporte Mensual ---
            const reportMonthInput = document.getElementById('reportMonth');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const exportReportBtn = document.getElementById('exportReportBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const departmentReportBody = document.getElementById('departmentReportBody');
            const providerReportBody = document.getElementById('providerReportBody');
            const totalDepartmentMeals = document.getElementById('totalDepartmentMeals');
            const totalDepartmentAmount = document.getElementById('totalDepartmentAmount');
            const totalProviderMeals = document.getElementById('totalProviderMeals');
            const totalProviderAmount = document.getElementById('totalProviderAmount');
            const ccsTotalMeals = document.getElementById('ccsTotalMeals');
            const ccsTotalAmount = document.getElementById('ccsTotalAmount');
            const msoTotalMeals = document.getElementById('msoTotalMeals');
            const msoTotalAmount = document.getElementById('msoTotalAmount');
            const grandTotalAmount = document.getElementById('grandTotalAmount');
            const pdfContent = document.getElementById('pdfContent');

            // --- NUEVAS REFERENCIAS PARA SERVICIOS POR UNIDAD Y PROVEEDOR ---
            const unitProviderReportBody = document.getElementById('unitProviderReportBody');
            const totalUnitProviderMeals = document.getElementById('totalUnitProviderMeals');
            const totalUnitProviderAmount = document.getElementById('totalUnitProviderAmount');

            // Definir las unidades de operación (departamentos)
            const departmentList = [
                'C.O EL ROSAL',
                'C.O LOS RUICES', 
                'C.O LA NAYA',
                'C.O PARAISO-CATIA',
                'DPTO DE OBRAS',
                'AREA COMERCIAL',
                'G. SENIOR',
                'MSO'
            ];

            // Definir proveedores
            const providerList = [
                'Al momento',
                'Monteluso',
                'Susi fresh',
                'Cumbes Barlovento'
            ];

            // --- Funciones de Firebase ---

            // Función para agregar una nueva solicitud a Firestore
            async function addRequestToFirestore(request) {
                try {
                    const requestsRef = firebaseFunctions.collection(db, 'foodRequests');
                    const docRef = await firebaseFunctions.addDoc(requestsRef, request);
                    console.log("Solicitud agregada con ID: ", docRef.id);
                    return { ...request, firestoreId: docRef.id };
                } catch (error) {
                    console.error("Error agregando solicitud:", error);
                    throw error;
                }
            }

            // Función para actualizar una solicitud en Firestore
            async function updateRequestInFirestore(requestId, updatedData) {
                try {
                    // Buscar el documento por el ID personalizado
                    const requestsRef = firebaseFunctions.collection(db, 'foodRequests');
                    const q = firebaseFunctions.query(requestsRef, firebaseFunctions.where('id', '==', requestId));
                    const querySnapshot = await firebaseFunctions.getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const docRef = firebaseFunctions.doc(db, 'foodRequests', querySnapshot.docs[0].id);
                        await firebaseFunctions.updateDoc(docRef, updatedData);
                        console.log("Solicitud actualizada correctamente");
                    }
                } catch (error) {
                    console.error("Error actualizando solicitud:", error);
                    throw error;
                }
            }

            // Función para eliminar solicitudes de Firestore
            async function deleteRequestsFromFirestore(requestIds) {
                try {
                    const requestsRef = firebaseFunctions.collection(db, 'foodRequests');
                    
                    // Para cada ID, buscar y eliminar el documento correspondiente
                    const deletePromises = requestIds.map(async (requestId) => {
                        const q = firebaseFunctions.query(requestsRef, firebaseFunctions.where('id', '==', requestId));
                        const querySnapshot = await firebaseFunctions.getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            const docRef = firebaseFunctions.doc(db, 'foodRequests', querySnapshot.docs[0].id);
                            await firebaseFunctions.deleteDoc(docRef);
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    console.log("Solicitudes eliminadas correctamente");
                } catch (error) {
                    console.error("Error eliminando solicitudes:", error);
                    throw error;
                }
            }

            // Función para cargar los datos de Firestore
            async function loadRequests() {
                try {
                    const requestsRef = firebaseFunctions.collection(db, 'foodRequests');
                    const q = firebaseFunctions.query(requestsRef, firebaseFunctions.orderBy('deliveryDate', 'desc'));
                    const querySnapshot = await firebaseFunctions.getDocs(q);
                    
                    const requests = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        requests.push({
                            ...data,
                            firestoreId: doc.id
                        });
                    });
                    
                    console.log("Datos cargados desde Firestore:", requests.length, "solicitudes");
                    return requests;
                } catch (error) {
                    console.error("Error cargando desde Firestore:", error);
                    displayMessage('Error al cargar desde la base de datos', 'error');
                    return [];
                }
            }

            // --- Funciones de Utilidad ---

            // Función para obtener la fecha y hora actual en formato YYYY-MM-DD
            function getCurrentDate() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Mostrar/ocultar campo de observaciones para MSO
            departmentSelect.addEventListener('change', function() {
                if (this.value === 'MSO') {
                    msoObservationsContainer.classList.remove('hidden');
                } else {
                    msoObservationsContainer.classList.add('hidden');
                    msoObservationsSelect.value = '';
                }
            });

            // Inicializar campos al cargar la página
            function initializeForm() {
                deliveryDateTimeInput.value = getCurrentDate();
                unitCostInput.value = '0.00';
                deliveryCostInput.value = '0.00';
                costInput.value = '0.00';
                totalQuantityInput.value = '0';
                
                // Reiniciar estado de edición
                editingRequestId = null;
                submitButton.textContent = 'Registrar Solicitud';
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitButton.classList.add('bg-inter-primary', 'hover:bg-blue-700');
                removeCancelEditButton();

                // Limpiar personal externo
                document.querySelectorAll('input[name="externalStaff"]').forEach(checkbox => {
                    checkbox.checked = false;
                    const quantityInput = document.getElementById(`quantity${checkbox.value}`);
                    if (quantityInput) {
                        quantityInput.value = '0';
                        quantityInput.classList.add('hidden-quantity');
                    }
                });
                
                // Limpiar personal Inter
                selectedInterStaff = [];
                renderSelectedStaff();
                
                // Ocultar campo MSO si no está seleccionado
                if (departmentSelect.value !== 'MSO') {
                    msoObservationsContainer.classList.add('hidden');
                    msoObservationsSelect.value = '';
                }
            }

            // Función para formatear fechas a YYYY-MM-DD para el input[type=date]
            function formatDateForInput(dateString) {
                if (!dateString) return '';
                return dateString.split('T')[0];
            }
            
            // Función para mostrar mensajes de estado
            function displayMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                } else {
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            }

            // --- Lógica del Calculo de Costos/Cantidad ---
            
            // Recalcula la cantidad total de comidas (Inter + Externos)
            function calculateTotalQuantity() {
                let externalQuantity = 0;
                document.querySelectorAll('input[type="number"][id^="quantity"]').forEach(input => {
                    externalQuantity += parseInt(input.value) || 0;
                });

                const interQuantity = selectedInterStaff.length;
                const total = externalQuantity + interQuantity;
                totalQuantityInput.value = total;
                return total;
            }

            // Recalcula el costo total
            function calculateTotalCost() {
                const totalQuantity = calculateTotalQuantity();
                const unitCost = parseFloat(unitCostInput.value) || 0;
                const deliveryCost = deliveryFree.checked ? 0 : (parseFloat(deliveryCostInput.value) || 0);

                const totalCost = (totalQuantity * unitCost) + deliveryCost;
                costInput.value = totalCost.toFixed(2);
            }

            // --- Lógica de Personal Externo ---

            // Manejar la visibilidad de los campos de cantidad para personal externo
            document.querySelectorAll('input[name="externalStaff"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const quantityInput = document.getElementById(`quantity${e.target.value}`);
                    if (quantityInput) {
                        if (e.target.checked) {
                            quantityInput.classList.remove('hidden-quantity');
                            quantityInput.value = 1;
                        } else {
                            quantityInput.classList.add('hidden-quantity');
                            quantityInput.value = 0;
                        }
                    }
                    calculateTotalCost();
                });
            });

            // Manejar la entrada de cantidad para personal externo
            document.querySelectorAll('input[type="number"][id^="quantity"]').forEach(input => {
                input.addEventListener('input', () => {
                    if (parseInt(input.value) < 0 || input.value === '') {
                        input.value = '0';
                    }
                    const checkboxId = input.id.replace('quantity', 'check');
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) {
                        checkbox.checked = parseInt(input.value) > 0;
                        if (parseInt(input.value) === 0) {
                             input.classList.add('hidden-quantity');
                        } else {
                            input.classList.remove('hidden-quantity');
                        }
                    }
                    calculateTotalCost();
                });
            });

            // --- Lógica de Personal Inter ---

            // Renderiza la lista de personal de Inter seleccionado
            function renderSelectedStaff() {
                interStaffSelectedList.innerHTML = '';
                selectedInterStaff.forEach((staffName, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between text-sm bg-blue-50 p-2 rounded';
                    li.innerHTML = `
                        <span class="text-gray-700 truncate" style="max-width: 80%;">${staffName}</span>
                        <button type="button" data-name="${staffName}"
                                class="remove-staff-btn text-red-500 hover:text-red-700 ml-2 font-bold transition duration-150">
                            &times;
                        </button>
                    `;
                    interStaffSelectedList.appendChild(li);
                });
                calculateTotalCost();
            }

            // Manejar la búsqueda y filtrado
            interStaffSearchInput.addEventListener('input', () => {
                const query = interStaffSearchInput.value.trim().toUpperCase();
                interStaffSearchResults.innerHTML = '';

                if (query.length < 2) {
                    interStaffSearchResults.classList.add('hidden');
                    return;
                }

                const filteredStaff = staffList.filter(staff => 
                    staff.name.includes(query) && !selectedInterStaff.includes(staff.name)
                ).slice(0, 10);

                if (filteredStaff.length > 0) {
                    filteredStaff.forEach(staff => {
                        const li = document.createElement('li');
                        li.className = 'p-2 hover:bg-inter-accent-light hover:text-white cursor-pointer transition duration-150 text-sm md:text-base';
                        li.textContent = staff.name;
                        li.setAttribute('data-name', staff.name);
                        li.addEventListener('click', (e) => {
                            selectedInterStaff.push(e.target.getAttribute('data-name'));
                            interStaffSearchInput.value = '';
                            interStaffSearchResults.classList.add('hidden');
                            renderSelectedStaff();
                        });
                        interStaffSearchResults.appendChild(li);
                    });
                    interStaffSearchResults.classList.remove('hidden');
                } else {
                    interStaffSearchResults.classList.add('hidden');
                }
            });

            // Ocultar resultados de búsqueda al perder el foco
            document.addEventListener('click', (e) => {
                if (!interStaffSearchInput.contains(e.target) && !interStaffSearchResults.contains(e.target)) {
                    interStaffSearchResults.classList.add('hidden');
                }
            });

            // Manejar la eliminación de personal Inter seleccionado
            interStaffSelectedList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-staff-btn')) {
                    const staffName = e.target.getAttribute('data-name');
                    selectedInterStaff = selectedInterStaff.filter(name => name !== staffName);
                    renderSelectedStaff();
                }
            });

            // --- Lógica del Formulario y Edición ---

            // Toggle para el costo de delivery
            document.querySelectorAll('input[name="deliveryOption"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (deliveryCostOption.checked) {
                        deliveryCostInput.classList.remove('hidden');
                    } else {
                        deliveryCostInput.classList.add('hidden');
                        deliveryCostInput.value = '0.00';
                    }
                    calculateTotalCost();
                });
            });

            // Event listeners para recalcular el costo
            unitCostInput.addEventListener('input', calculateTotalCost);
            deliveryCostInput.addEventListener('input', calculateTotalCost);

            // Función para añadir el botón de Cancelar Edición
            function addCancelEditButton() {
                let cancelBtn = document.getElementById('cancelEditBtn');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancelEditBtn';
                    cancelBtn.type = 'button';
                    cancelBtn.textContent = 'Cancelar Edición';
                    cancelBtn.className = 'bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto mt-2 sm:mt-0';
                    cancelBtn.addEventListener('click', resetFormAndEditing);
                    formActionsContainer.insertBefore(cancelBtn, submitButton);
                }
            }

            // Función para eliminar el botón de Cancelar Edición
            function removeCancelEditButton() {
                const cancelBtn = document.getElementById('cancelEditBtn');
                if (cancelBtn) {
                    cancelBtn.remove();
                }
            }

            // Función para resetear el formulario y el modo de edición
            function resetFormAndEditing() {
                form.reset();
                initializeForm();
                submitButton.textContent = 'Registrar Solicitud';
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitButton.classList.add('bg-inter-primary', 'hover:bg-blue-700');
                removeCancelEditButton();
                deliveryCostInput.classList.add('hidden');
            }

            // Función para cargar una solicitud en el formulario para edición
            window.editRequest = (id) => {
                const requestToEdit = foodRequests.find(req => req.id === id);
                if (!requestToEdit) return;

                editingRequestId = id;
                
                // 1. Cargar datos básicos y de costo
                departmentSelect.value = requestToEdit.department;
                mealTypeSelect.value = requestToEdit.mealType;
                eventSelect.value = requestToEdit.event || '';
                deliveryPlaceInput.value = requestToEdit.deliveryPlace;
                deliveryDateTimeInput.value = formatDateForInput(requestToEdit.deliveryDate);
                unitCostInput.value = parseFloat(requestToEdit.unitCost).toFixed(2);
                providerNameSelect.value = requestToEdit.providerName;
                reasonTextarea.value = requestToEdit.reason;

                // 2. Cargar campo MSO si corresponde
                if (requestToEdit.department === 'MSO' && requestToEdit.msoDepartment) {
                    msoObservationsContainer.classList.remove('hidden');
                    msoObservationsSelect.value = requestToEdit.msoDepartment;
                } else {
                    msoObservationsContainer.classList.add('hidden');
                    msoObservationsSelect.value = '';
                }

                // 3. Cargar personal externo
                document.querySelectorAll('input[name="externalStaff"]').forEach(checkbox => {
                    checkbox.checked = false;
                    const quantityInput = document.getElementById(`quantity${checkbox.value}`);
                    quantityInput.value = '0';
                    quantityInput.classList.add('hidden-quantity');
                });

                if (requestToEdit.externalStaff) {
                    Object.keys(requestToEdit.externalStaff).forEach(key => {
                        const quantity = requestToEdit.externalStaff[key];
                        if (quantity > 0) {
                            const checkbox = document.getElementById(`check${key}`);
                            const quantityInput = document.getElementById(`quantity${key}`);
                            if (checkbox && quantityInput) {
                                checkbox.checked = true;
                                quantityInput.value = quantity;
                                quantityInput.classList.remove('hidden-quantity');
                            }
                        }
                    });
                }

                // 4. Cargar personal Inter
                selectedInterStaff = requestToEdit.interStaff.slice();
                renderSelectedStaff();

                // 5. Cargar costo de delivery
                const deliveryCostValue = parseFloat(requestToEdit.deliveryCost);
                if (deliveryCostValue > 0) {
                    deliveryCostOption.checked = true;
                    deliveryFree.checked = false;
                    deliveryCostInput.value = deliveryCostValue.toFixed(2);
                    deliveryCostInput.classList.remove('hidden');
                } else {
                    deliveryFree.checked = true;
                    deliveryCostOption.checked = false;
                    deliveryCostInput.value = '0.00';
                    deliveryCostInput.classList.add('hidden');
                }
                
                calculateTotalCost();

                // 6. Ajustar interfaz a modo Edición
                submitButton.textContent = 'Guardar Cambios';
                submitButton.classList.remove('bg-inter-primary', 'hover:bg-blue-700');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
                addCancelEditButton();

                // Desplazarse al formulario
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // Manejar el envío del formulario
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Recopilar datos de personal externo
                const externalStaffData = {};
                document.querySelectorAll('input[name="externalStaff"]:checked').forEach(checkbox => {
                    const quantityInput = document.getElementById(`quantity${checkbox.value}`);
                    const quantity = parseInt(quantityInput.value) || 0;
                    if (quantity > 0) {
                        externalStaffData[checkbox.value] = quantity;
                    }
                });

                const totalQuantity = calculateTotalQuantity();
                const totalCost = parseFloat(costInput.value);
                const deliveryCostValue = deliveryFree.checked ? 0 : (parseFloat(deliveryCostInput.value) || 0);

                if (totalQuantity === 0) {
                    displayMessage('El total de comidas debe ser mayor a 0.', 'error');
                    return;
                }
                
                if (departmentSelect.value === '') {
                    displayMessage('Debe seleccionar un Departamento/Área.', 'error');
                    return;
                }

                if (providerNameSelect.value === '') {
                    displayMessage('Debe seleccionar un Proveedor.', 'error');
                    return;
                }

                const newRequest = {
                    id: editingRequestId || Date.now(),
                    department: departmentSelect.value,
                    mealType: mealTypeSelect.value,
                    event: eventSelect.value,
                    externalStaff: externalStaffData,
                    interStaff: selectedInterStaff.slice(),
                    totalQuantity: totalQuantity,
                    deliveryPlace: deliveryPlaceInput.value,
                    deliveryDate: deliveryDateTimeInput.value,
                    unitCost: parseFloat(unitCostInput.value),
                    deliveryCost: deliveryCostValue,
                    totalCost: totalCost,
                    providerName: providerNameSelect.value,
                    reason: reasonTextarea.value,
                    registrationDate: new Date().toISOString()
                };

                // Agregar observaciones MSO si corresponde
                if (departmentSelect.value === 'MSO' && msoObservationsSelect.value) {
                    newRequest.msoDepartment = msoObservationsSelect.value;
                }

                try {
                    if (editingRequestId) {
                        // Modo Edición: actualizar en Firestore
                        await updateRequestInFirestore(editingRequestId, newRequest);
                        
                        // Actualizar localmente
                        const index = foodRequests.findIndex(req => req.id === editingRequestId);
                        if (index !== -1) {
                            foodRequests[index] = newRequest;
                        }
                        
                        displayMessage('Solicitud actualizada con éxito.', 'success');
                        resetFormAndEditing();
                    } else {
                        // Modo Registro: añadir nuevo registro a Firestore
                        const requestWithFirestoreId = await addRequestToFirestore(newRequest);
                        foodRequests.push(requestWithFirestoreId);
                        displayMessage('Solicitud registrada con éxito.', 'success');
                        form.reset();
                        initializeForm();
                    }
                    
                    renderTable();
                    updateSummaryTotals();
                    updateCharts();
                    
                    // Actualizar reporte si hay un mes seleccionado
                    if (reportMonthInput.value) {
                        generateReport();
                    }
                    
                } catch (error) {
                    displayMessage('Error al guardar la solicitud: ' + error.message, 'error');
                }
            });

            // --- Lógica del Historial (Tabla) ---

            // Formatea el costo a una cadena con dos decimales y el símbolo $
            function formatCost(cost) {
                return `$${parseFloat(cost || 0).toFixed(2)}`;
            }
            
            // Función para renderizar la tabla de historial con filtros
            function renderTable() {
                let filteredRequests = foodRequests.slice();
                
                // Aplicar filtros activos
                if (activeFilters.length > 0) {
                    filteredRequests = filteredRequests.filter(request => {
                        return activeFilters.every(filter => {
                            const searchTerm = filter.term.toLowerCase();
                            
                            // Buscar en diferentes campos
                            if (filter.field === 'all') {
                                // Búsqueda en todos los campos
                                return (
                                    request.department.toLowerCase().includes(searchTerm) ||
                                    request.mealType.toLowerCase().includes(searchTerm) ||
                                    request.deliveryPlace.toLowerCase().includes(searchTerm) ||
                                    request.providerName.toLowerCase().includes(searchTerm) ||
                                    request.reason.toLowerCase().includes(searchTerm) ||
                                    request.interStaff.some(staff => staff.toLowerCase().includes(searchTerm)) ||
                                    (request.msoDepartment && request.msoDepartment.toLowerCase().includes(searchTerm))
                                );
                            } else if (filter.field === 'department') {
                                return request.department.toLowerCase().includes(searchTerm);
                            } else if (filter.field === 'mealType') {
                                return request.mealType.toLowerCase().includes(searchTerm);
                            } else if (filter.field === 'provider') {
                                return request.providerName.toLowerCase().includes(searchTerm);
                            } else if (filter.field === 'staff') {
                                return request.interStaff.some(staff => staff.toLowerCase().includes(searchTerm));
                            }
                            return true;
                        });
                    });
                }
                
                // Ordenar por fecha
                filteredRequests.sort((a, b) => {
                    const dateA = new Date(a.deliveryDate + 'T12:00:00');
                    const dateB = new Date(b.deliveryDate + 'T12:00:00');
                    return dateB - dateA;
                });

                tableBody.innerHTML = '';
                cardsView.innerHTML = '';
                
                if (filteredRequests.length === 0) {
                    noRequestsMessage.classList.remove('hidden');
                    tableView.classList.add('hidden');
                    return;
                }
                
                noRequestsMessage.classList.add('hidden');
                tableView.classList.remove('hidden');

                // Renderizar para desktop (tablet y escritorio)
                filteredRequests.forEach(request => {
                    const externalStaffText = Object.keys(request.externalStaff)
                        .map(key => `${key} (${request.externalStaff[key]})`)
                        .join(', ');

                    const interStaffText = request.interStaff.join(', ');
                    
                    const displayDate = new Date(request.deliveryDate + 'T12:00:00').toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                    });

                    // Mostrar departamento MSO específico si existe
                    const displayDepartment = request.department === 'MSO' && request.msoDepartment 
                        ? `${request.department} (${request.msoDepartment})`
                        : request.department;

                    // Vista de tabla para desktop
                    const row = tableBody.insertRow();
                    row.className = 'hover:bg-gray-50 transition duration-150';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">
                            <input type="checkbox" data-id="${request.id}" class="row-checkbox form-checkbox h-4 w-4 text-inter-primary rounded">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900" title="${displayDate}">
                            ${displayDate}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 truncate-cell expandable-cell" title="${displayDepartment}">
                            ${displayDepartment}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" title="${request.mealType}">
                            ${request.mealType}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 truncate-cell expandable-cell" title="${externalStaffText}">
                            ${externalStaffText || 'N/A'}
                        </td>
                        <td class="px-4 py-3 max-w-xs overflow-hidden truncate-cell expandable-cell text-sm text-gray-500" title="${interStaffText}">
                            ${interStaffText || 'N/A'}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-medium text-inter-primary">
                            ${request.totalQuantity}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-inter-primary">
                            ${formatCost(request.totalCost)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editRequest(${request.id})" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md text-xs transition duration-150 transform hover:scale-105">
                                Editar
                            </button>
                        </td>
                    `;

                    // Vista de tarjetas para móviles
                    const card = document.createElement('div');
                    card.className = 'table-card';
                    card.innerHTML = `
                        <div class="table-card-row">
                            <span class="table-card-label">Fecha:</span>
                            <span class="table-card-value">${displayDate}</span>
                        </div>
                        <div class="table-card-row">
                            <span class="table-card-label">Departamento:</span>
                            <span class="table-card-value">${displayDepartment}</span>
                        </div>
                        <div class="table-card-row">
                            <span class="table-card-label">Tipo:</span>
                            <span class="table-card-value">${request.mealType}</span>
                        </div>
                        <div class="table-card-row">
                            <span class="table-card-label">Personal Ext.:</span>
                            <span class="table-card-value">${externalStaffText || 'N/A'}</span>
                        </div>
                        <div class="table-card-row">
                            <span class="table-card-label">Personal Inter:</span>
                            <span class="table-card-value">${interStaffText || 'N/A'}</span>
                        </div>
                        <div class="table-card-row">
                            <span class="table-card-label">Total Comidas:</span>
                            <span class="table-card-value font-medium text-inter-primary">${request.totalQuantity}</span>
                        </div>
                        <div class="table-card-row">
                            <span class="table-card-label">Costo Total:</span>
                            <span class="table-card-value font-bold text-inter-primary">${formatCost(request.totalCost)}</span>
                        </div>
                        <div class="table-card-actions">
                            <input type="checkbox" data-id="${request.id}" class="row-checkbox form-checkbox h-4 w-4 text-inter-primary rounded mr-2">
                            <button onclick="editRequest(${request.id})" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md text-xs transition duration-150">
                                Editar
                            </button>
                        </div>
                    `;
                    cardsView.appendChild(card);
                });

                selectAllCheckboxes.checked = false;
            }

            // Función para alternar entre vista compacta y normal
            function toggleCompactView() {
                compactView = !compactView;
                const table = document.getElementById('foodTable');
                const btn = document.getElementById('toggleCompactView');
                
                if (compactView) {
                    table.classList.add('compact-view');
                    btn.textContent = 'Vista Normal';
                    // Ocultar algunas columnas adicionales si es necesario
                } else {
                    table.classList.remove('compact-view');
                    btn.textContent = 'Vista Compacta';
                }
                
                renderTable();
            }

            // Event listener para el botón de vista compacta
            toggleCompactViewBtn.addEventListener('click', toggleCompactView);

            // --- Lógica de Filtros Avanzados ---

            function renderActiveFilters() {
                activeFiltersContainer.innerHTML = '';
                
                if (activeFilters.length === 0) {
                    return;
                }
                
                activeFilters.forEach((filter, index) => {
                    const filterTag = document.createElement('div');
                    filterTag.className = 'filter-tag';
                    filterTag.innerHTML = `
                        <span>${filter.field === 'all' ? 'Todos:' : filter.field === 'department' ? 'Depto:' : filter.field === 'mealType' ? 'Tipo:' : filter.field === 'provider' ? 'Prov:' : 'Personal:'} ${filter.term}</span>
                        <span class="filter-tag-remove" data-index="${index}">×</span>
                    `;
                    activeFiltersContainer.appendChild(filterTag);
                });
                
                // Agregar evento para eliminar filtros
                document.querySelectorAll('.filter-tag-remove').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        removeFilter(index);
                    });
                });
                
                renderTable();
            }

            function addFilter() {
                const searchTerm = filterInput.value.trim();
                if (!searchTerm) {
                    displayMessage('Por favor ingrese un término de búsqueda', 'error');
                    return;
                }
                
                // Intentar detectar el tipo de búsqueda
                let field = 'all';
                const termLower = searchTerm.toLowerCase();
                
                // Verificar si es un tipo de comida específico
                const mealTypes = ['desayuno', 'almuerzo', 'cena', 'refrigerios'];
                if (mealTypes.some(type => termLower.includes(type))) {
                    field = 'mealType';
                }
                // Verificar si es un proveedor específico
                else if (termLower.includes('monteluso') || termLower.includes('susi') || termLower.includes('cumbes') || termLower.includes('al momento')) {
                    field = 'provider';
                }
                // Verificar si parece ser un nombre de personal
                else if (termLower.split(' ').length >= 2) {
                    field = 'staff';
                }
                // Verificar si parece ser un departamento
                else if (termLower.includes('admin') || termLower.includes('comercial') || termLower.includes('gerencia') || 
                         termLower.includes('head') || termLower.includes('mso') || termLower.includes('ocad') || 
                         termLower.includes('obras') || termLower.includes('rosal') || termLower.includes('naya') || 
                         termLower.includes('ruices')) {
                    field = 'department';
                }
                
                activeFilters.push({
                    field: field,
                    term: searchTerm
                });
                
                filterInput.value = '';
                renderActiveFilters();
            }

            function removeFilter(index) {
                activeFilters.splice(index, 1);
                renderActiveFilters();
            }

            function clearAllFilters() {
                activeFilters = [];
                filterInput.value = '';
                renderActiveFilters();
            }

            // Event listeners para filtros
            addFilterBtn.addEventListener('click', addFilter);
            
            filterInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addFilter();
                }
            });
            
            clearAllFiltersBtn.addEventListener('click', clearAllFilters);
            
            // Seleccionar/Deseleccionar todos los checkboxes
            selectAllCheckboxes.addEventListener('change', (e) => {
                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            // Botón Eliminar Seleccionados
            deleteSelectedBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                    .map(cb => parseInt(cb.getAttribute('data-id')));

                if (selectedIds.length === 0) {
                    displayMessage('Debe seleccionar al menos una solicitud para eliminar.', 'error');
                    return;
                }

                modalText.textContent = `¿Estás seguro de que quieres eliminar ${selectedIds.length} solicitud(es)? Esta acción no se puede deshacer.`;
                deleteModal.classList.remove('hidden');

                confirmDeleteBtn.onclick = async () => {
                    try {
                        await deleteRequestsFromFirestore(selectedIds);
                        
                        foodRequests = foodRequests.filter(req => !selectedIds.includes(req.id));
                        
                        renderTable();
                        updateSummaryTotals();
                        updateCharts();
                        
                        // Actualizar reporte si hay un mes seleccionado
                        if (reportMonthInput.value) {
                            generateReport();
                        }
                        
                        deleteModal.classList.add('hidden');
                        displayMessage('Solicitud(es) eliminada(s) con éxito.', 'success');
                    } catch (error) {
                        displayMessage('Error al eliminar las solicitudes: ' + error.message, 'error');
                        deleteModal.classList.add('hidden');
                    }
                };

                cancelDeleteBtn.onclick = () => {
                    deleteModal.classList.add('hidden');
                };
            });

            // Exportar a CSV
            exportCsvBtn.addEventListener('click', () => {
                if (foodRequests.length === 0) {
                    displayMessage('No hay datos para exportar.', 'error');
                    return;
                }
                
                const csvQuote = (str) => {
                    return `"${String(str || '').replace(/"/g, '""')}"`;
                };

                let headers = [
                    "Fecha de Entrega", 
                    "Departamento", 
                    "Departamento MSO (si aplica)",
                    "Tipo de Comida", 
                    "Evento", 
                    "Personal Externo (Detalle)", 
                    "Personal Inter (Detalle)", 
                    "Total Comidas", 
                    "Lugar de Entrega", 
                    "Motivo", 
                    "Proveedor", 
                    "Costo Comida Unitario ($)", 
                    "Costo Total Comida ($)", 
                    "Costo Delivery ($)", 
                    "Costo Total Final ($)"
                ];
                
                let csv = headers.join(";") + "\n";

                foodRequests.forEach(req => {
                    const externalStaffText = Object.keys(req.externalStaff)
                        .map(key => `${key} (${req.externalStaff[key]})`)
                        .join(' | ');

                    const interStaffText = req.interStaff.join(' | ');
                    const totalCostComida = req.totalQuantity * req.unitCost;
                    
                    const row = [
                        csvQuote(req.deliveryDate),
                        csvQuote(req.department),
                        csvQuote(req.msoDepartment || ''),
                        csvQuote(req.mealType),
                        csvQuote(req.event || ''),
                        csvQuote(externalStaffText),
                        csvQuote(interStaffText),
                        req.totalQuantity,
                        csvQuote(req.deliveryPlace),
                        csvQuote(req.reason),
                        csvQuote(req.providerName),
                        parseFloat(req.unitCost).toFixed(2).replace('.', ','),
                        totalCostComida.toFixed(2).replace('.', ','),
                        parseFloat(req.deliveryCost).toFixed(2).replace('.', ','),
                        parseFloat(req.totalCost).toFixed(2).replace('.', ',')
                    ];
                    csv += row.join(";") + "\n";
                });

                const blob = new Blob(["\uFEFF", csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'solicitudes_comidas.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                displayMessage('Datos exportados a CSV con éxito.', 'success');
            });

            // --- Lógica del Resumen de Gastos ---

            function updateSummaryTotals() {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

                let dailyTotal = 0;
                let weeklyTotal = 0;
                let monthlyTotal = 0;

                foodRequests.forEach(req => {
                    const reqDateForComparison = new Date(req.deliveryDate + 'T12:00:00');
                    const cost = parseFloat(req.totalCost) || 0;

                    if (reqDateForComparison >= monthStart) {
                        monthlyTotal += cost;
                    }

                    if (reqDateForComparison >= weekStart) {
                        weeklyTotal += cost;
                    }
                    
                    const todayStr = today.toISOString().split('T')[0];
                    if (req.deliveryDate === todayStr) {
                        dailyTotal += cost;
                    }
                });

                dailyTotalEl.textContent = formatCost(dailyTotal);
                weeklyTotalEl.textContent = formatCost(weeklyTotal);
                monthlyTotalEl.textContent = formatCost(monthlyTotal);
            }
            
            // --- Lógica de Gráficos ---

            function getChartColor(index) {
                const colors = ['#005BAA', '#5CE1E6', '#00B8D9', '#FF9800', '#667EEA', '#F6AD55', '#E53E3E', '#38B2AC'];
                return colors[index % colors.length];
            }

            function updateCharts() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Filtrar solicitudes del mes actual para gráfica mensual
                const currentMonthRequests = foodRequests.filter(req => {
                    const reqDate = new Date(req.deliveryDate + 'T12:00:00');
                    return reqDate.getMonth() === currentMonth && reqDate.getFullYear() === currentYear;
                });
                
                // Filtrar solicitudes del año actual para gráfica anual
                const currentYearRequests = foodRequests.filter(req => {
                    const reqDate = new Date(req.deliveryDate + 'T12:00:00');
                    return reqDate.getFullYear() === currentYear;
                });

                // 1. Gráfica de Gastos Mensuales por Proveedor (mes actual)
                const monthlyProviderData = currentMonthRequests.reduce((acc, req) => {
                    const provider = req.providerName;
                    const cost = parseFloat(req.totalCost) || 0;

                    if (!acc[provider]) acc[provider] = 0;
                    acc[provider] += cost;
                    return acc;
                }, {});

                const monthlyProviders = Object.keys(monthlyProviderData);
                const monthlyCosts = monthlyProviders.map(provider => monthlyProviderData[provider]);
                const monthlyColors = monthlyProviders.map((provider, index) => 
                    CHART_COLORS[provider] || getChartColor(index)
                );

                if (monthlyProvidersChart) {
                    monthlyProvidersChart.destroy();
                }
                const monthlyCtx = document.getElementById('monthlyProvidersChart').getContext('2d');
                monthlyProvidersChart = new Chart(monthlyCtx, {
                    type: 'doughnut',
                    data: {
                        labels: monthlyProviders,
                        datasets: [{
                            data: monthlyCosts,
                            backgroundColor: monthlyColors,
                            borderColor: monthlyColors.map(color => color.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: window.innerWidth <= 768 ? 'bottom' : 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 2. Gráfica de Gastos Anuales por Proveedor
                const annualProviderData = currentYearRequests.reduce((acc, req) => {
                    const date = new Date(req.deliveryDate + 'T12:00:00');
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const provider = req.providerName;
                    const cost = parseFloat(req.totalCost) || 0;

                    if (!acc[monthKey]) acc[monthKey] = {};
                    if (!acc[monthKey][provider]) acc[monthKey][provider] = 0;
                    acc[monthKey][provider] += cost;
                    return acc;
                }, {});

                const allMonths = Object.keys(annualProviderData).sort();
                const allProviders = [...new Set(currentYearRequests.map(r => r.providerName))];

                const providerDatasets = allProviders.map((provider, index) => {
                    const data = allMonths.map(month => annualProviderData[month][provider] || 0);
                    return {
                        label: provider,
                        data: data,
                        backgroundColor: CHART_COLORS[provider] || getChartColor(index),
                        borderColor: CHART_COLORS[provider] || getChartColor(index),
                        fill: false,
                        tension: 0.1
                    };
                });

                if (annualProvidersChart) {
                    annualProvidersChart.destroy();
                }
                const annualCtx = document.getElementById('annualProvidersChart').getContext('2d');
                annualProvidersChart = new Chart(annualCtx, {
                    type: 'line',
                    data: {
                        labels: allMonths,
                        datasets: providerDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Gasto Total (USD $)',
                                    color: CHART_COLORS['Al momento']
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: window.innerWidth <= 768 ? 'bottom' : 'top',
                            }
                        }
                    }
                });

                // 3. Gráfica de Comportamiento Mensual por Departamento
                const departmentMonthlyData = currentYearRequests.reduce((acc, req) => {
                    const date = new Date(req.deliveryDate + 'T12:00:00');
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const department = req.department;
                    const cost = parseFloat(req.totalCost) || 0;

                    if (!acc[monthKey]) acc[monthKey] = {};
                    if (!acc[monthKey][department]) acc[monthKey][department] = 0;
                    acc[monthKey][department] += cost;
                    return acc;
                }, {});

                const departmentMonths = Object.keys(departmentMonthlyData).sort();
                const allDepartments = [...new Set(currentYearRequests.map(r => r.department))];
                
                const departmentDatasets = allDepartments.map((department, index) => {
                    const data = departmentMonths.map(month => departmentMonthlyData[month][department] || 0);
                    return {
                        label: department,
                        data: data,
                        backgroundColor: getChartColor(index),
                        borderColor: getChartColor(index),
                        fill: false,
                        tension: 0.1
                    };
                });

                if (departmentExpensesChart) {
                    departmentExpensesChart.destroy();
                }
                const deptExpensesCtx = document.getElementById('departmentExpensesChart').getContext('2d');
                departmentExpensesChart = new Chart(deptExpensesCtx, {
                    type: 'line',
                    data: {
                        labels: departmentMonths,
                        datasets: departmentDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Gasto Total (USD $)',
                                    color: CHART_COLORS['Al momento']
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: window.innerWidth <= 768 ? 'bottom' : 'top',
                            }
                        }
                    }
                });

                // 4. Preparar datos de Solicitudes por Empleado de Inter
                const staffRequests = currentYearRequests.reduce((acc, req) => {
                    req.interStaff.forEach(staff => {
                        acc[staff] = (acc[staff] || 0) + 1;
                    });
                    return acc;
                }, {});

                const topStaff = Object.entries(staffRequests)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 10);

                const staffLabels = topStaff.map(([name]) => name);
                const staffData = topStaff.map(([, count]) => count);
                const staffColors = staffData.map((_, index) => getChartColor(index));

                if (staffRequestsChart) {
                    staffRequestsChart.destroy();
                }
                const staffCtx = document.getElementById('staffRequestsChart').getContext('2d');
                staffRequestsChart = new Chart(staffCtx, {
                    type: 'bar',
                    data: {
                        labels: staffLabels,
                        datasets: [{
                            label: 'Número de Solicitudes',
                            data: staffData,
                            backgroundColor: staffColors,
                            borderColor: staffColors.map(color => color.replace('0.2', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad de Solicitudes',
                                },
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (value % 1 === 0) {
                                            return value;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                // 5. Preparar datos de Solicitudes por Departamento
                const departmentCounts = currentYearRequests.reduce((acc, req) => {
                    acc[req.department] = (acc[req.department] || 0) + 1;
                    return acc;
                }, {});

                const departmentLabels = Object.keys(departmentCounts).sort();
                const departmentData = departmentLabels.map(dept => departmentCounts[dept]);
                const departmentColors = departmentData.map((_, index) => getChartColor(index + 3));

                if (departmentRequestsChart) {
                    departmentRequestsChart.destroy();
                }
                const departmentCtx = document.getElementById('departmentRequestsChart').getContext('2d');
                departmentRequestsChart = new Chart(departmentCtx, {
                    type: 'bar',
                    data: {
                        labels: departmentLabels,
                        datasets: [{
                            label: 'Número de Solicitudes',
                            data: departmentData,
                            backgroundColor: departmentColors,
                            borderColor: departmentColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad de Solicitudes',
                                },
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (value % 1 === 0) {
                                            return value;
                                        }
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Departamento',
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // --- Lógica del Reporte Mensual ---

            // Establecer mes actual por defecto
            window.addEventListener('DOMContentLoaded', () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                reportMonthInput.value = `${year}-${month}`;
            });

            // Función para mapear departamentos (versión mejorada)
            function mapDepartment(department, msoDepartment) {
                if (!department) return 'NO ESPECIFICADO';
                
                const dept = department.toString().trim().toUpperCase();
                
                // Mapeos específicos
                if (dept.includes('EL ROSAL') || dept === 'C.O EL ROSAL') return 'C.O EL ROSAL';
                if (dept.includes('LOS RUICES') || dept === 'C.O LOS RUICES') return 'C.O LOS RUICES';
                if (dept.includes('LA NAYA') || dept === 'C.O LA NAYA') return 'C.O LA NAYA';
                if (dept.includes('PARAISO') || dept === 'C.O PARAISO-CATIA') return 'C.O PARAISO-CATIA';
                if (dept.includes('OBRAS') || dept === 'DPTO DE OBRAS') return 'DPTO DE OBRAS';
                if (dept.includes('COMERCIAL') || dept === 'AREA COMERCIAL' || dept === 'ÁREA COMERCIAL') return 'AREA COMERCIAL';
                if (dept.includes('GERENCIA SENIOR') || dept === 'G. SENIOR') return 'G. SENIOR';
                if (dept.includes('MSO') || dept === 'MSO') return 'MSO';
                
                // Si no coincide, devolver el original normalizado
                return dept;
            }

            // Función para clasificar si es CCS o MSO
            function classifyUnit(department, msoDepartment) {
                const dept = department.toString().trim().toUpperCase();
                
                // Si es MSO o contiene "PRESIDENCIA", "MARKETING", etc., es MSO
                if (dept === 'MSO' || 
                    dept.includes('PRESIDENCIA') || 
                    dept.includes('MARKETING') || 
                    dept.includes('INTERCONEXIONES') ||
                    dept.includes('IMPORTACIONES') ||
                    dept.includes('RRHH MSO') ||
                    dept.includes('DOCUMENTACION DE OBRAS')) {
                    return 'MSO';
                }
                
                // Si es cualquier otro departamento, es CCS
                return 'CCS';
            }

            // Función para generar el reporte
            function generateReport() {
                const selectedMonth = reportMonthInput.value;
                if (!selectedMonth) {
                    displayMessage('Por favor seleccione un mes para el reporte', 'error');
                    return;
                }
                
                const [year, month] = selectedMonth.split('-');
                
                // Filtrar solicitudes del mes seleccionado
                const filteredRequests = foodRequests.filter(request => {
                    const requestDate = new Date(request.deliveryDate + 'T12:00:00');
                    return requestDate.getFullYear() === parseInt(year) && 
                           (requestDate.getMonth() + 1) === parseInt(month);
                });
                
                if (filteredRequests.length === 0) {
                    displayMessage('No hay datos para el mes seleccionado', 'error');
                    return;
                }
                
                console.log(`=== GENERANDO REPORTE PARA ${month}/${year} ===`);
                console.log(`Total solicitudes: ${filteredRequests.length}`);
                
                // Inicializar estructuras de datos
                const departmentData = {};
                const providerData = {};
                
                // Inicializar departamentos con 0
                departmentList.forEach(dept => {
                    departmentData[dept] = {
                        meals: 0,
                        amount: 0
                    };
                });
                
                // Inicializar proveedores con 0
                providerList.forEach(provider => {
                    providerData[provider] = {
                        meals: 0,
                        amount: 0
                    };
                });
                
                // Contador para depuración
                let totalComidasCalculadas = 0;
                let areaComercialComidas = 0;
                
                // Procesar datos de las solicitudes
                filteredRequests.forEach((request, index) => {
                    const departmentKey = mapDepartment(request.department, request.msoDepartment);
                    const providerKey = request.providerName;
                    
                    // Asegurar que totalQuantity sea un número entero
                    const meals = parseInt(request.totalQuantity) || 0;
                    const amount = parseFloat(request.totalCost) || 0;
                    
                    // Depuración para Área Comercial
                    if (departmentKey === 'AREA COMERCIAL') {
                        areaComercialComidas += meals;
                        console.log(`Registro ${index + 1} - Área Comercial: ${meals} comidas (ID: ${request.id})`);
                        console.log(`  - TotalQuantity: ${request.totalQuantity}`);
                        console.log(`  - Departamento original: ${request.department}`);
                    }
                    
                    totalComidasCalculadas += meals;
                    
                    // Acumular por departamento
                    if (departmentData[departmentKey]) {
                        departmentData[departmentKey].meals += meals;
                        departmentData[departmentKey].amount += amount;
                    } else {
                        console.warn(`⚠️ Departamento no encontrado en lista: ${departmentKey} (original: ${request.department})`);
                        // Si no está en la lista, crear una entrada
                        if (!departmentData[departmentKey]) {
                            departmentData[departmentKey] = { meals: 0, amount: 0 };
                        }
                        departmentData[departmentKey].meals += meals;
                        departmentData[departmentKey].amount += amount;
                    }
                    
                    // Acumular por proveedor
                    if (providerData[providerKey]) {
                        providerData[providerKey].meals += meals;
                        providerData[providerKey].amount += amount;
                    } else {
                        // Si el proveedor no está en la lista, usar "Otros"
                        const providerKeyNormalized = providerKey || 'Otros';
                        if (!providerData[providerKeyNormalized]) {
                            providerData[providerKeyNormalized] = { meals: 0, amount: 0 };
                        }
                        providerData[providerKeyNormalized].meals += meals;
                        providerData[providerKeyNormalized].amount += amount;
                    }
                });
                
                console.log(`=== RESUMEN ===`);
                console.log(`Total comidas calculadas: ${totalComidasCalculadas}`);
                console.log(`Comidas Área Comercial: ${areaComercialComidas}`);
                console.log('Datos por departamento:', JSON.stringify(departmentData, null, 2));
                
                // Verificar consistencia
                let sumaDepartamentos = 0;
                Object.values(departmentData).forEach(data => {
                    sumaDepartamentos += data.meals;
                });
                
                console.log(`Suma departamentos: ${sumaDepartamentos}`);
                
                // Renderizar reporte por departamento
                renderDepartmentReport(departmentData);
                
                // Renderizar reporte por proveedor
                renderProviderReport(providerData);
                
                // Calcular totales
                calculateTotals(departmentData);
                
                // Renderizar reporte por unidad y proveedor
                renderUnitProviderReport(filteredRequests);
                
                // Mostrar botones de exportar
                exportReportBtn.classList.remove('hidden');
                exportPdfBtn.classList.remove('hidden');
                
                // Verificación final
                const comidasAreaComercial = departmentData['AREA COMERCIAL'] ? departmentData['AREA COMERCIAL'].meals : 0;
                console.log(`✅ Comidas finales Área Comercial en reporte: ${comidasAreaComercial}`);
                
                displayMessage(`Reporte generado para ${getMonthName(month)} ${year}. Área Comercial: ${comidasAreaComercial} comidas`, 'success');
            }

            // Función para renderizar reporte por departamento
            function renderDepartmentReport(departmentData) {
                departmentReportBody.innerHTML = '';
                
                let totalMeals = 0;
                let totalAmount = 0;
                
                departmentList.forEach(dept => {
                    const data = departmentData[dept] || { meals: 0, amount: 0 };
                    totalMeals += data.meals;
                    totalAmount += data.amount;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 border border-gray-300">
                            ${dept}
                        </td>
                        <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 text-center border border-gray-300">
                            ${data.meals}
                        </td>
                        <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 text-right border border-gray-300">
                            $${data.amount.toFixed(2)}
                        </td>
                    `;
                    departmentReportBody.appendChild(row);
                });
                
                totalDepartmentMeals.textContent = totalMeals;
                totalDepartmentAmount.textContent = `$${totalAmount.toFixed(2)}`;
                
                console.log(`Total departamentos en reporte: ${totalMeals} comidas, $${totalAmount.toFixed(2)}`);
            }

            // Función para renderizar reporte por proveedor
            function renderProviderReport(providerData) {
                providerReportBody.innerHTML = '';
                
                let totalMeals = 0;
                let totalAmount = 0;
                
                // Ordenar proveedores por cantidad de comidas (descendente)
                const providersSorted = Object.keys(providerData).sort((a, b) => {
                    return providerData[b].meals - providerData[a].meals;
                });
                
                // Mostrar todos los proveedores que tengan comidas
                providersSorted.forEach(provider => {
                    const data = providerData[provider];
                    if (data.meals > 0) {
                        totalMeals += data.meals;
                        totalAmount += data.amount;
                        
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 border border-gray-300">
                                ${provider}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 text-center border border-gray-300">
                                ${data.meals}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900 text-right border border-gray-300">
                                $${data.amount.toFixed(2)}
                            </td>
                        `;
                        providerReportBody.appendChild(row);
                    }
                });
                
                totalProviderMeals.textContent = totalMeals;
                totalProviderAmount.textContent = `$${totalAmount.toFixed(2)}`;
                
                console.log(`Total proveedores en reporte: ${totalMeals} comidas, $${totalAmount.toFixed(2)}`);
            }

            // Función para calcular totales CCS vs MSO
            function calculateTotals(departmentData) {
                let ccsMeals = 0;
                let ccsAmount = 0;
                let msoMeals = 0;
                let msoAmount = 0;
                
                // Departamentos CCS (todos excepto MSO)
                const ccsDepartments = departmentList.filter(dept => dept !== 'MSO');
                ccsDepartments.forEach(dept => {
                    const data = departmentData[dept] || { meals: 0, amount: 0 };
                    ccsMeals += data.meals;
                    ccsAmount += data.amount;
                });
                
                // Departamento MSO
                const msoData = departmentData['MSO'] || { meals: 0, amount: 0 };
                msoMeals = msoData.meals;
                msoAmount = msoData.amount;
                
                // Actualizar totales
                ccsTotalMeals.textContent = ccsMeals;
                ccsTotalAmount.textContent = `$${ccsAmount.toFixed(2)}`;
                msoTotalMeals.textContent = msoMeals;
                msoTotalAmount.textContent = `$${msoAmount.toFixed(2)}`;
                grandTotalAmount.textContent = `$${(ccsAmount + msoAmount).toFixed(2)}`;
                
                console.log(`CCS: ${ccsMeals} comidas, $${ccsAmount.toFixed(2)}`);
                console.log(`MSO: ${msoMeals} comidas, $${msoAmount.toFixed(2)}`);
            }

            // Función para renderizar el reporte combinado por unidad y proveedor
            function renderUnitProviderReport(filteredRequests) {
                unitProviderReportBody.innerHTML = '';
                
                // Crear estructura de datos combinada
                const unitProviderData = {};
                
                // Inicializar estructura
                const units = ['CCS', 'MSO'];
                const allProviders = [...new Set(filteredRequests.map(r => r.providerName))];
                
                units.forEach(unit => {
                    unitProviderData[unit] = {};
                    allProviders.forEach(provider => {
                        unitProviderData[unit][provider] = {
                            meals: 0,
                            amount: 0
                        };
                    });
                });
                
                // Procesar cada solicitud
                filteredRequests.forEach(request => {
                    const unit = classifyUnit(request.department, request.msoDepartment);
                    const provider = request.providerName || 'No especificado';
                    const meals = parseInt(request.totalQuantity) || 0;
                    const amount = parseFloat(request.totalCost) || 0;
                    
                    if (!unitProviderData[unit]) {
                        unitProviderData[unit] = {};
                    }
                    
                    if (!unitProviderData[unit][provider]) {
                        unitProviderData[unit][provider] = { meals: 0, amount: 0 };
                    }
                    
                    unitProviderData[unit][provider].meals += meals;
                    unitProviderData[unit][provider].amount += amount;
                });
                
                let totalMeals = 0;
                let totalAmount = 0;
                
                // Renderizar la tabla
                units.forEach(unit => {
                    // Verificar si hay datos para esta unidad
                    const unitHasData = Object.keys(unitProviderData[unit]).some(
                        provider => unitProviderData[unit][provider].meals > 0
                    );
                    
                    if (unitHasData) {
                        // Fila de encabezado de unidad
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'bg-blue-50 font-bold';
                        headerRow.innerHTML = `
                            <td colspan="4" class="px-3 md:px-6 py-2 md:py-3 text-sm md:text-lg text-inter-primary border border-gray-300">
                                ${unit}
                            </td>
                        `;
                        unitProviderReportBody.appendChild(headerRow);
                        
                        // Filas de proveedores para esta unidad
                        Object.keys(unitProviderData[unit])
                            .filter(provider => unitProviderData[unit][provider].meals > 0)
                            .sort((a, b) => unitProviderData[unit][b].meals - unitProviderData[unit][a].meals)
                            .forEach(provider => {
                                const data = unitProviderData[unit][provider];
                                totalMeals += data.meals;
                                totalAmount += data.amount;
                                
                                const row = document.createElement('tr');
                                row.className = 'hover:bg-gray-50';
                                row.innerHTML = `
                                    <td class="px-3 md:px-6 py-2 md:py-4 text-xs md:text-sm text-gray-900 border border-gray-300"></td>
                                    <td class="px-3 md:px-6 py-2 md:py-4 text-xs md:text-sm text-gray-900 border border-gray-300">
                                        ${provider}
                                    </td>
                                    <td class="px-3 md:px-6 py-2 md:py-4 text-xs md:text-sm text-gray-900 text-center border border-gray-300">
                                        ${data.meals}
                                    </td>
                                    <td class="px-3 md:px-6 py-2 md:py-4 text-xs md:text-sm text-gray-900 text-right border border-gray-300">
                                        $${data.amount.toFixed(2)}
                                    </td>
                                `;
                                unitProviderReportBody.appendChild(row);
                            });
                        
                        // Fila de subtotal por unidad
                        const unitMeals = Object.keys(unitProviderData[unit])
                            .reduce((sum, provider) => sum + unitProviderData[unit][provider].meals, 0);
                        const unitAmount = Object.keys(unitProviderData[unit])
                            .reduce((sum, provider) => sum + unitProviderData[unit][provider].amount, 0);
                        
                        const subtotalRow = document.createElement('tr');
                        subtotalRow.className = 'bg-gray-100 font-bold';
                        subtotalRow.innerHTML = `
                            <td colspan="2" class="px-3 md:px-6 py-2 md:py-3 text-xs md:text-sm text-gray-900 border border-gray-300 text-right">
                                Subtotal ${unit}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-3 text-xs md:text-sm text-inter-primary text-center border border-gray-300">
                                ${unitMeals}
                            </td>
                            <td class="px-3 md:px-6 py-2 md:py-3 text-xs md:text-sm text-inter-primary text-right border border-gray-300">
                                $${unitAmount.toFixed(2)}
                            </td>
                        `;
                        unitProviderReportBody.appendChild(subtotalRow);
                        
                        // Fila en blanco para separación
                        const spacerRow = document.createElement('tr');
                        spacerRow.innerHTML = '<td colspan="4" class="py-2"></td>';
                        unitProviderReportBody.appendChild(spacerRow);
                    }
                });
                
                // Actualizar totales
                totalUnitProviderMeals.textContent = totalMeals;
                totalUnitProviderAmount.textContent = `$${totalAmount.toFixed(2)}`;
                
                console.log(`Total unidad/proveedor: ${totalMeals} comidas, $${totalAmount.toFixed(2)}`);
            }

            // Función para exportar a Excel
            function exportReportToExcel() {
                const selectedMonth = reportMonthInput.value;
                if (!selectedMonth) return;
                
                const [year, month] = selectedMonth.split('-');
                const monthName = getMonthName(month);
                
                // Crear datos para el reporte
                let csv = `Reporte de Gastos de Comida - ${monthName} ${year}\n\n`;
                
                // Sección 1: Por Unidad de Operación
                csv += "SOLICITUD DE COMIDAS POR UNIDAD DE OPERACIONES\n";
                csv += "UNIDAD DE OPERACION;CANTIDAD DE COMIDAS SOLICITADAS;IMPORTE\n";
                
                const departmentRows = Array.from(departmentReportBody.querySelectorAll('tr'));
                departmentRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        const dept = cells[0].textContent.replace(';', ',');
                        const meals = cells[1].textContent;
                        const amount = cells[2].textContent.replace('$', '').replace('.', ',');
                        csv += `${dept};${meals};${amount}\n`;
                    }
                });
                
                csv += `TOTAL;${totalDepartmentMeals.textContent};${totalDepartmentAmount.textContent.replace('$', '').replace('.', ',')}\n\n`;
                
                // Sección 2: Por Proveedor
                csv += "SOLICITUD DE COMIDAS POR PROVEEDOR\n";
                csv += "PROVEEDOR;CANTIDAD DE COMIDAS;IMPORTE\n";
                
                const providerRows = Array.from(providerReportBody.querySelectorAll('tr'));
                providerRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        const provider = cells[0].textContent.replace(';', ',');
                        const meals = cells[1].textContent;
                        const amount = cells[2].textContent.replace('$', '').replace('.', ',');
                        csv += `${provider};${meals};${amount}\n`;
                    }
                });
                
                csv += `TOTAL;${totalProviderMeals.textContent};${totalProviderAmount.textContent.replace('$', '').replace('.', ',')}\n\n`;
                
                // Sección 3: Servicios por Unidad y Proveedor
                csv += "SERVICIOS POR UNIDAD Y PROVEEDOR\n";
                csv += "UNIDAD;PROVEEDOR;CANTIDAD DE COMIDAS;IMPORTE\n";
                
                const unitProviderRows = Array.from(unitProviderReportBody.querySelectorAll('tr'));
                unitProviderRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 4) {
                        const unit = cells[0].textContent || '';
                        const provider = cells[1].textContent.replace(';', ',');
                        const meals = cells[2].textContent;
                        const amount = cells[3].textContent.replace('$', '').replace('.', ',');
                        
                        if (unit.trim() || provider.trim()) {
                            csv += `${unit};${provider};${meals};${amount}\n`;
                        }
                    } else if (cells.length === 1 && cells[0].colSpan === 4) {
                        // Es un encabezado de unidad
                        const unit = cells[0].textContent.replace(';', ',');
                        csv += `${unit};;;;\n`;
                    } else if (cells.length === 1 && cells[0].className.includes('py-2')) {
                        // Es un separador
                        csv += `;;;;\n`;
                    }
                });
                
                csv += `TOTAL GENERAL;;${totalUnitProviderMeals.textContent};${totalUnitProviderAmount.textContent.replace('$', '').replace('.', ',')}\n\n`;
                
                // Sección 4: Resumen
                csv += "RESUMEN POR TIPO DE UNIDAD\n";
                csv += `UNIDAD CCS Total Comidas;${ccsTotalMeals.textContent}\n`;
                csv += `UNIDAD CCS Importe Total;${ccsTotalAmount.textContent.replace('$', '').replace('.', ',')}\n`;
                csv += `UNIDAD MSO Total Comidas;${msoTotalMeals.textContent}\n`;
                csv += `UNIDAD MSO Importe Total;${msoTotalAmount.textContent.replace('$', '').replace('.', ',')}\n`;
                csv += `GRAN TOTAL MENSUAL;${grandTotalAmount.textContent.replace('$', '').replace('.', ',')}\n`;
                
                // Crear y descargar archivo
                const blob = new Blob(["\uFEFF", csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `Reporte_Comidas_${monthName}_${year}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                displayMessage('Reporte exportado exitosamente', 'success');
            }

            // Función para exportar a PDF
            async function exportReportToPDF() {
                const selectedMonth = reportMonthInput.value;
                if (!selectedMonth) {
                    displayMessage('Por favor genere primero un reporte', 'error');
                    return;
                }
                
                const [year, month] = selectedMonth.split('-');
                const monthName = getMonthName(month);
                const today = new Date();
                const todayStr = today.toLocaleDateString('es-ES');
                
                // Mostrar mensaje de procesamiento
                displayMessage('Generando PDF...', 'success');
                
                try {
                    // Obtener datos de las tablas
                    const departmentRows = Array.from(departmentReportBody.querySelectorAll('tr'));
                    const providerRows = Array.from(providerReportBody.querySelectorAll('tr'));
                    const unitProviderRows = Array.from(unitProviderReportBody.querySelectorAll('tr'));
                    
                    // Crear contenido HTML para el PDF
                    let pdfHTML = `
                        <div class="report-pdf">
                            <div class="pdf-header">
                                <h1 class="pdf-title">Reporte de Gastos de Comida</h1>
                                <div class="pdf-subtitle">${monthName} ${year}</div>
                                <div class="pdf-subtitle">Fecha de generación: ${todayStr}</div>
                            </div>
                            
                            <div class="pdf-section">
                                <h2 style="color: #005BAA; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #005BAA; padding-bottom: 5px;">
                                    SOLICITUD DE COMIDAS POR UNIDAD DE OPERACIONES
                                </h2>
                                <table class="pdf-table">
                                    <thead>
                                        <tr>
                                            <th>UNIDAD DE OPERACION</th>
                                            <th>CANTIDAD DE COMIDAS SOLICITADAS</th>
                                            <th>IMPORTE</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Agregar filas de departamentos
                    departmentRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3) {
                            const dept = cells[0].textContent;
                            const meals = cells[1].textContent;
                            const amount = cells[2].textContent;
                            
                            pdfHTML += `
                                <tr>
                                    <td>${dept}</td>
                                    <td style="text-align: center;">${meals}</td>
                                    <td style="text-align: right;">${amount}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    // Agregar total de departamentos
                    pdfHTML += `
                                <tr class="total-row">
                                    <td><strong>TOTAL</strong></td>
                                    <td style="text-align: center;"><strong>${totalDepartmentMeals.textContent}</strong></td>
                                    <td style="text-align: right;"><strong>${totalDepartmentAmount.textContent}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pdf-section">
                        <h2 style="color: #005BAA; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #005BAA; padding-bottom: 5px;">
                            SOLICITUD DE COMIDAS POR PROVEEDOR
                        </h2>
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>PROVEEDOR</th>
                                    <th>CANTIDAD DE COMIDAS</th>
                                    <th>IMPORTE</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // Agregar filas de proveedores
                    providerRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3) {
                            const provider = cells[0].textContent;
                            const meals = cells[1].textContent;
                            const amount = cells[2].textContent;
                            
                            pdfHTML += `
                                <tr>
                                    <td>${provider}</td>
                                    <td style="text-align: center;">${meals}</td>
                                    <td style="text-align: right;">${amount}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    // Agregar total de proveedores
                    pdfHTML += `
                                <tr class="total-row">
                                    <td><strong>TOTAL</strong></td>
                                    <td style="text-align: center;"><strong>${totalProviderMeals.textContent}</strong></td>
                                    <td style="text-align: right;"><strong>${totalProviderAmount.textContent}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pdf-section">
                        <h2 style="color: #005BAA; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #005BAA; padding-bottom: 5px;">
                            SERVICIOS POR UNIDAD Y PROVEEDOR
                        </h2>
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>UNIDAD</th>
                                    <th>PROVEEDOR</th>
                                    <th>CANTIDAD DE COMIDAS</th>
                                    <th>IMPORTE</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // Agregar filas de unidad/proveedor
                    let currentUnit = '';
                    unitProviderRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        
                        if (cells.length === 1 && cells[0].colSpan === 4) {
                            // Es un encabezado de unidad
                            currentUnit = cells[0].textContent;
                            pdfHTML += `
                                <tr style="background-color: #f0f7ff; font-weight: bold;">
                                    <td colspan="4" style="color: #005BAA; font-size: 16px; padding: 8px; border: 1px solid #ddd;">
                                        ${currentUnit}
                                    </td>
                                </tr>
                            `;
                        } else if (cells.length === 4) {
                            // Es una fila de proveedor
                            const unit = cells[0].textContent;
                            const provider = cells[1].textContent;
                            const meals = cells[2].textContent;
                            const amount = cells[3].textContent;
                            
                            if (provider.trim()) {
                                pdfHTML += `
                                    <tr>
                                        <td>${unit}</td>
                                        <td>${provider}</td>
                                        <td style="text-align: center;">${meals}</td>
                                        <td style="text-align: right;">${amount}</td>
                                    </tr>
                                `;
                            }
                        }
                    });
                    
                    // Agregar total de unidad/proveedor
                    pdfHTML += `
                                <tr class="total-row">
                                    <td colspan="2"><strong>TOTAL GENERAL</strong></td>
                                    <td style="text-align: center;"><strong>${totalUnitProviderMeals.textContent}</strong></td>
                                    <td style="text-align: right;"><strong>${totalUnitProviderAmount.textContent}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pdf-section">
                        <h2 style="color: #005BAA; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #005BAA; padding-bottom: 5px;">
                            RESUMEN POR TIPO DE UNIDAD
                        </h2>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div class="pdf-summary-box" style="flex: 1; margin-right: 10px;">
                                <h3 style="color: #005BAA; font-size: 16px; margin-bottom: 10px;">UNIDAD CCS</h3>
                                <div style="margin-bottom: 5px;">
                                    <span>Total Comidas: </span>
                                    <strong>${ccsTotalMeals.textContent}</strong>
                                </div>
                                <div>
                                    <span>Importe Total: </span>
                                    <strong>${ccsTotalAmount.textContent}</strong>
                                </div>
                            </div>
                            <div class="pdf-summary-box" style="flex: 1; margin-left: 10px;">
                                <h3 style="color: #005BAA; font-size: 16px; margin-bottom: 10px;">UNIDAD MSO</h3>
                                <div style="margin-bottom: 5px;">
                                    <span>Total Comidas: </span>
                                    <strong>${msoTotalMeals.textContent}</strong>
                                </div>
                                <div>
                                    <span>Importe Total: </span>
                                    <strong>${msoTotalAmount.textContent}</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; padding: 15px; background-color: #f0f7ff; border-radius: 5px; border: 1px solid #005BAA;">
                            <div style="font-size: 16px; font-weight: bold; color: #005BAA; margin-bottom: 5px;">
                                GRAN TOTAL MENSUAL
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #005BAA;">
                                ${grandTotalAmount.textContent}
                            </div>
                        </div>
                    </div>
                    
                    <div class="pdf-footer">
                        <div>Reporte generado el ${todayStr}</div>
                        <div>Control de Solicitud de Comidas - Inter</div>
                    </div>
                </div>
                    `;
                    
                    // Crear elemento temporal para el contenido del PDF
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = pdfHTML;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    tempDiv.style.top = '0';
                    tempDiv.style.width = '800px';
                    tempDiv.style.backgroundColor = 'white';
                    tempDiv.style.padding = '20px';
                    document.body.appendChild(tempDiv);
                    
                    // Usar html2canvas para capturar el contenido
                    const canvas = await html2canvas(tempDiv, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    // Remover el elemento temporal
                    document.body.removeChild(tempDiv);
                    
                    // Crear PDF
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Agregar imagen del canvas al PDF
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190; // Ancho en mm para A4
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    
                    // Guardar el PDF
                    pdf.save(`Reporte_Comidas_${monthName}_${year}.pdf`);
                    
                    displayMessage('PDF generado exitosamente', 'success');
                    
                } catch (error) {
                    console.error('Error generando PDF:', error);
                    displayMessage('Error al generar el PDF: ' + error.message, 'error');
                }
            }

            // Función auxiliar para obtener nombre del mes
            function getMonthName(monthNumber) {
                const months = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];
                return months[parseInt(monthNumber) - 1];
            }

            // Event Listeners para reporte
            generateReportBtn.addEventListener('click', generateReport);
            exportReportBtn.addEventListener('click', exportReportToExcel);
            exportPdfBtn.addEventListener('click', exportReportToPDF);

            // --- Inicio de la Aplicación ---

            initializeForm();

            // Cargar los datos y renderizar todo al inicio
            try {
                foodRequests = await loadRequests();
                renderTable();
                updateSummaryTotals();
                updateCharts();
                
                // Generar reporte inicial
                if (reportMonthInput.value) {
                    generateReport();
                }
                
                console.log("Página cargada y datos iniciales renderizados.");
            } catch (error) {
                console.error("Error al renderizar la página inicial:", error);
            }
        });
    </script>
</body>
</html>
