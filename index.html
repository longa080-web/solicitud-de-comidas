<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Solicitud de Comidas - Inter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Aplicar la fuente 'Inter' a todo el cuerpo del documento */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Definir colores personalizados basados en la marca Inter */
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .text-inter-primary { color: #005BAA; }
        .text-inter-accent-light { color: #5CE1E6; }
        .border-inter-primary { border-color: #005BAA; }
        .border-inter-accent-light { border-color: #5CE1E6; }
        .focus\:ring-inter-primary:focus { --tw-ring-color: #005BAA; }

        /* Ocultar el input de cantidad por defecto */
        .hidden-quantity {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
        <header class="text-center mb-6 bg-inter-primary rounded-t-xl py-6 relative overflow-hidden">
            <h1 class="text-4xl font-extrabold text-white mb-2 relative z-10">
                Control de Solicitud de Comidas
            </h1>
            <p class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl font-extrabold text-white opacity-10 whitespace-nowrap select-none pointer-events-none z-0">
                Inter Tu mundo, nuestro compromiso.
            </p>
            <p class="text-md text-white mt-2 relative z-10">Registro y gestión de solicitudes de comidas para el personal</p>
        </header>

        <section class="mb-8 p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Registrar Nueva Solicitud de Comida</h2>
            <form id="foodRequestForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                        Departamento/Área
                    </label>
                    <select id="department" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" disabled selected>Selecciona un Departamento</option>
                        <option value="Area Comercial">Área Comercial</option>
                        <option value="C.O El Rosal">C.O El Rosal</option>
                        <option value="C.O La Naya">C.O La Naya</option>
                        <option value="C.O Los Ruices">C.O Los Ruices</option>
                        <option value="Gerencia Senior">Gerencia Senior</option>
                        <option value="Head End">Head End</option>
                        <option value="MSO">MSO</option>
                        <option value="Ocad">Ocad</option>
                        <option value="Obras">Obras</option>
                    </select>
                </div>
                <div>
                    <label for="mealType" class="block text-sm font-medium text-gray-700 mb-1">
                        Tipo de Comida
                    </label>
                    <select id="mealType" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" disabled selected>Selecciona el Tipo</option>
                        <option value="Almuerzo">Almuerzo</option>
                        <option value="Cena">Cena</option>
                    </select>
                </div>
                <div>
                    <label for="event" class="block text-sm font-medium text-gray-700 mb-1">
                        Evento
                    </label>
                    <select id="event"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" disabled selected>Selecciona un Evento</option>
                        <option value="Evento extraordinario">Evento extraordinario</option>
                        <option value="Corte de fibra">Corte de fibra</option>
                        <option value="Mantenimiento de red">Mantenimiento de red</option>
                        <option value="Feeder y obras">Feeder y obras</option>
                        <option value="Ventas en calle">Ventas en calle</option>
                        <option value="Ventana de mantenimiento">Ventana de mantenimiento</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Personal Externo</label>
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="checkCANTV" name="externalStaff" value="CANTV" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                            <label for="checkCANTV" class="text-gray-700">CANTV</label>
                            <input type="number" id="quantityCANTV" min="0" value="0"
                                   class="w-20 ml-auto px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                   placeholder="Cantidad">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="checkEDC" name="externalStaff" value="EDC" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                            <label for="checkEDC" class="text-gray-700">EDC</label>
                            <input type="number" id="quantityEDC" min="0" value="0"
                                   class="w-20 ml-auto px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                   placeholder="Cantidad">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="checkExternalOthers" name="externalStaff" value="ExternalOthers" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                            <label for="checkExternalOthers" class="text-gray-700">Otros</label>
                            <input type="number" id="quantityExternalOthers" min="0" value="0"
                                   class="w-20 ml-auto px-2 py-1 border border-gray-300 rounded-md shadow-sm hidden-quantity"
                                   placeholder="Cantidad">
                        </div>
                    </div>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Personal Inter</label>
                    <div class="relative">
                        <input type="text" id="interStaffSearch" placeholder="Buscar personal de Inter..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                        <ul id="interStaffSearchResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                    </div>
                    <ul id="interStaffSelected" class="mt-2 space-y-2">
                        </ul>
                </div>

                <div class="col-span-1">
                    <label for="totalQuantity" class="block text-sm font-medium text-gray-700 mb-1">
                        Total de Comidas
                    </label>
                    <input type="number" id="totalQuantity" min="0" value="0" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed">
                </div>
                
                <div class="col-span-1 md:col-span-2">
                    <label for="deliveryPlace" class="block text-sm font-medium text-gray-700 mb-1">
                        Lugar de Entrega
                    </label>
                    <input type="text" id="deliveryPlace" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                           placeholder="Ej. Administración, Sede Principal, Campo (con dirección)">
                </div>
                <div>
                    <label for="deliveryDateTime" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha de Entrega
                    </label>
                    <input type="date" id="deliveryDateTime" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                </div>
                <div>
                    <label for="unitCost" class="block text-sm font-medium text-gray-700 mb-1">
                        Costo Unitario Comida (USD $)
                    </label>
                    <input type="number" id="unitCost" step="0.01" min="0" value="0.00" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Costo de Delivery
                    </label>
                    <div class="flex items-center space-x-4 mb-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="deliveryOption" value="free" checked
                                   class="form-radio text-inter-primary h-4 w-4" id="deliveryFree">
                            <span class="ml-2 text-gray-700">Gratuito</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="deliveryOption" value="cost"
                                   class="form-radio text-inter-primary h-4 w-4" id="deliveryCostOption">
                            <span class="ml-2 text-gray-700">Con costo</span>
                        </label>
                    </div>
                    <input type="number" id="deliveryCost" step="0.01" min="0" value="0.00"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary hidden"
                           placeholder="Costo de Delivery ($)">
                </div>
                <div>
                    <label for="cost" class="block text-sm font-medium text-gray-700 mb-1">
                        Costo Total (USD $)
                    </label>
                    <input type="number" id="cost" step="0.01" min="0" value="0.00" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary bg-gray-100 cursor-not-allowed">
                </div>
                <div>
                    <label for="providerName" class="block text-sm font-medium text-gray-700 mb-1">
                        Nombre del Proveedor
                    </label>
                    <select id="providerName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary custom-select">
                        <option value="" disabled selected>Selecciona un Proveedor</option>
                        <option value="Al momento">Al momento</option>
                        <option value="Monteluso">Monteluso</option>
                        <option value="Susi fresh">Susi fresh</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-3">
                    <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">
                        Motivo de la Solicitud (Obligatorio para justificar)
                    </label>
                    <textarea id="reason" rows="3" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                                 placeholder="Ej. Personal de Área Técnica trabajando en proyecto X fuera de horario, Área Comercial en visita a cliente en Y."></textarea>
                </div>
                <div class="col-span-1 md:col-span-3 flex justify-end items-center gap-4" id="formActions">
                    <button type="submit"
                            class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Registrar Solicitud
                    </button>
                    </div>
            </form>
            <div id="messageBox" class="mt-4 p-3 rounded-md text-sm hidden"></div>
        </section>

        <section class="mb-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Resumen de Gastos de Comidas</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Diarios</h3>
                    <p id="dailyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Semanales</h3>
                    <p id="weeklyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Mensuales</h3>
                    <p id="monthlyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
            </div>
        </section>

        <section class="p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Historial de Solicitudes de Comida</h2>

            <div class="mb-4 p-4 bg-blue-50 rounded-lg flex flex-col md:flex-row items-center gap-4">
                <label for="filterDepartment" class="text-sm font-medium text-gray-700 whitespace-nowrap">
                    Filtrar por Departamento:
                </label>
                <input type="text" id="filterDepartment"
                       class="w-full md:w-auto flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                       placeholder="Nombre del departamento">
                <button id="clearFilterBtn"
                        class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Limpiar Filtro
                </button>
                <button id="exportCsvBtn"
                        class="bg-inter-accent-light hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Exportar a Excel (CSV)
                </button>
                <button id="deleteSelectedBtn"
                        class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Eliminar Seleccionados
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">
                                <input type="checkbox" id="selectAllCheckboxes" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Fecha de Entrega</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Departamento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Tipo de Comida</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Evento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Personal Externo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Personal Inter</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Total Comidas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Lugar de Entrega</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Motivo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Proveedor</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo Comida ($)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo Delivery ($)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo Total ($)</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-inter-primary uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="foodTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <p id="noRequestsMessage" class="text-center text-gray-500 mt-4 hidden">No hay solicitudes de comida registradas aún.</p>
        </section>

        <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Análisis de Gastos</h2>

            <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center mb-6">
                <h3 id="annualProvidersChartTitle" class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Mensual por Proveedor</h3>
                <div class="w-full max-w-lg h-64">
                    <canvas id="annualProvidersChart"></canvas>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center mt-6">
                <h3 id="staffRequestsChartTitle" class="text-xl font-bold text-inter-primary mb-4 text-center">Cantidad de Solicitudes por Empleado de Inter</h3>
                <div class="w-full max-w-xl h-96">
                    <canvas id="staffRequestsChart"></canvas>
                </div>
            </div>

            <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center mt-6">
                <h3 id="departmentRequestsChartTitle" class="text-xl font-bold text-inter-primary mb-4 text-center">Cantidad de Solicitudes por Departamento</h3>
                <div class="w-full max-w-xl h-64">
                    <canvas id="departmentRequestsChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Confirmar Eliminación</h3>
            <p class="mb-4" id="modalText">¿Estás seguro de que quieres eliminar la(s) solicitud(es) seleccionada(s)? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Eliminar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // === 1. CONFIGURACIÓN DE FIREBASE (SDK v9 - Módulos) ===
        
        // Importar funciones de los SDKs v9
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            orderBy, 
            writeBatch,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

        // Credenciales proporcionadas por el usuario
        const firebaseConfig = {
            apiKey: "AIzaSyDwGgTGRkaEO4SzVR-5KqM3K66Istba0a4",
            authDomain: "control-solicitudes-de-comida.firebaseapp.com",
            projectId: "control-solicitudes-de-comida",
            storageBucket: "control-solicitudes-de-comida.firebasestorage.app",
            messagingSenderId: "255909685257",
            appId: "1:255909685257:web:98e9d0697b374fdf32b0d8"
        };

        // Inicializar Firebase y Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = 'comidaSolicitudes';
        const foodRequestsRef = collection(db, COLLECTION_NAME); // Referencia a la colección

        // === 2. LÓGICA DE LA APLICACIÓN ===

        // (Aquí va toda la lógica JavaScript del archivo anterior, pero con las funciones de Firebase v9 adaptadas)

        const form = document.getElementById('foodRequestForm');
        // ... (resto de referencias a elementos HTML)
        const totalQuantityInput = document.getElementById('totalQuantity');
        const deliveryPlaceInput = document.getElementById('deliveryPlace');
        const deliveryDateTimeInput = document.getElementById('deliveryDateTime');
        const unitCostInput = document.getElementById('unitCost');
        const deliveryCostInput = document.getElementById('deliveryCost');
        const deliveryCostOption = document.getElementById('deliveryCostOption');
        const deliveryFree = document.getElementById('deliveryFree');
        const costInput = document.getElementById('cost');
        const providerNameSelect = document.getElementById('providerName');
        const reasonTextarea = document.getElementById('reason');
        const formActionsContainer = document.getElementById('formActions');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const modalText = document.getElementById('modalText');
        const tableBody = document.getElementById('foodTableBody');
        const noRequestsMessage = document.getElementById('noRequestsMessage');
        const messageBox = document.getElementById('messageBox');
        
        // Variables globales
        let foodRequests = [];
        let editingRequestId = null;
        let selectedInterStaff = [];
        let currentFilter = '';
        
        // ... (Constantes y staffList - Mantener estas de tu código original)
        const staffList = [ 
            { id: 1, name: "BLANCO NEISABEL" }, { id: 2, name: "VILLAMIZAR NANCY" }, { id: 3, name: "CASTILLO TIBET" }, { id: 4, name: "QUINTERO ROSANA" }, { id: 5, name: "GONZALEZ LINO" }, { id: 6, name: "MORILLO ANA" }, { id: 7, name: "CARTAYA LENNYIS" }, { id: 8, name: "DELGADO JONATHAN" }, { id: 9, name: "TRONCOSO LAIS" }, { id: 10, name: "BRITO RONEY" }, { id: 11, name: "MUÑOZ KELVIN" }, { id: 12, name: "GALEA CESAR" }, { id: 13, name: "MORENO GEINES" }, { id: 14, name: "MACHADO JOSE" }, { id: 15, name: "SUAREZ KIR" }, { id: 16, name: "JIMENEZ DAIRELI" }, { id: 17, name: "GARCIA ANGELICA" }, { id: 18, name: "CONTRERAS NOELIA" }, { id: 19, name: "VEGAS ENYMAR" }, { id: 20, name: "GOMEZ SAMUEL" }, { id: 21, name: "LONGA JESUS" }, { id: 22, name: "QUIJADA WILFREDO" }, { id: 23, name: "PINO ALEJANDRO" }, { id: 24, name: "AMORUZO ANGELO" }, { id: 25, name: "CHINCHILLA OSMEL" }, { id: 26, name: "TERAN CASTO" }, { id: 27, name: "FERRER GABRIEL" }, { id: 28, name: "TOVAR LUIS" }, { id: 29, name: "ORTA WILNER" }, { id: 30, name: "TORRES KEIVER" }, { id: 31, name: "RODRIGUEZ MISAEL" }, { id: 32, name: "CASTILLO JHOAN" }, { id: 33, name: "VILLEGAS OSMER" }, { id: 34, name: "RAMOS FREDDY" }, { id: 35, name: "TOVAR JAIRO" }, { id: 36, name: "PEREZ LUIS" }, { id: 37, name: "BRITO JOSE" }, { id: 38, name: "ASCANIO FELIX" }, { id: 39, name: "CORONADO MIGUEL" }, { id: 40, name: "HELLO ALBANY" }, { id: 41, name: "PIRELA WILMER" }, { id: 42, name: "CASTELLANOS FRANKLIN" }, { id: 43, name: "JIMENEZ RONMEL" }, { id: 44, name: "PRIETO JAVIER" }, { id: 45, name: "LARA EDUARDO" }, { id: 46, name: "CASANOVA FABIAN" }, { id: 47, name: "CASTILLO ORIANA" }, { id: 48, name: "GARRIDO ADOLFO" }, { id: 49, name: "MORENO JOELIMAR" }, { id: 50, name: "CENTENO LUIS" }, { id: 51, name: "NEGRIN CARLOS" }, { id: 52, name: "SANCHEZ ARACELIS" }, { id: 53, name: "CASTILLO ANDRES" }, { id: 54, name: "COLMENARES MARCOS" }, { id: 55, name: "DELGADO WILMER" }, { id: 56, name: "RIVAS ISRAEL" }, { id: 57, name: "DELGADO NEIVELYS" }, { id: 58, name: "MORALES ISMAR" }, { id: 59, name: "BRICEÑO JOSE" }, { id: 60, name: "GARCIA WILMER" }, { id: 61, name: "REYES JUAN" }, { id: 62, name: "DELGADO EDGARYS" }, { id: 63, name: "PARRA MARIANGELA" }, { id: 64, name: "ORTIZ JOSE" }, { id: 65, name: "SALAS CARLOS" }, { id: 66, name: "MONTERO ERICK" }, { id: 67, name: "PALACIOS LUIS" }, { id: 68, name: "GONZALEZ LUIS" }, { id: 69, name: "DIAZ JESUS" }, { id: 70, name: "PARRA ESTEBAN" }, { id: 71, name: "GUERRERO ARGENIS" }, { id: 72, name: "GARCIA MIGUEL" }, { id: 73, name: "ROJAS CARLOS" }, { id: 74, name: "RODRIGUEZ EDUARDO" }, { id: 75, name: "ESPARZA ANGEL" }, { id: 76, name: "RODRIGUEZ RICARDO" }, { id: 77, name: "RODRIGUEZ EDGAR" }, { id: 78, name: "RODRIGUEZ JORGE" }, { id: 79, name: "LOZADA VICTOR" }, { id: 80, name: "RONDON VICTOR" }, { id: 81, name: "RAMOS JOSESIT" }, { id: 82, name: "PEREZ FRANKLIN" }, { id: 83, name: "SARRIA DANIEL" }, { id: 84, name: "PEREZ WILMER" }, { id: 85, name: "VELASQUEZ OMAR" }, { id: 86, name: "VARGAS CARLOS" }, { id: 87, name: "ESCALONA LUIS" }, { id: 88, name: "RODRIGUEZ JESUS" }, { id: 89, name: "RODRIGUEZ MARCOS" }, { id: 90, name: "ORTA GABRIEL" }
        ];

        // -------------------------------------------------------------------------
        // === FUNCIONES DE FIREBASE (ADAPTADAS A SDK v9) ===
        // -------------------------------------------------------------------------
        
        async function loadRequests() {
            try {
                // query() en SDK v9 se usa para construir la consulta
                const q = query(foodRequestsRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                
                foodRequests = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const deliveryDateTime = data.deliveryDateTime instanceof Date
                        ? data.deliveryDateTime.toISOString().slice(0, 10) 
                        : data.deliveryDateTime;
                    
                    return { 
                        id: doc.id,
                        ...data,
                        deliveryDateTime: deliveryDateTime
                    };
                });
            } catch (error) {
                showMessage(`Error al cargar los datos: ${error.message}`, 'error');
                foodRequests = [];
            }
        }

        async function saveRequest(data) {
            try {
                const cleanData = {
                    ...data,
                    timestamp: serverTimestamp(), // Función de SDK v9 para el timestamp
                    totalQuantity: parseFloat(data.totalQuantity),
                    unitCost: parseFloat(data.unitCost),
                    deliveryCost: parseFloat(data.deliveryCost),
                    cost: parseFloat(data.cost),
                    interStaffSelected: data.interStaffSelected.map(staff => staff.name)
                };

                if (data.id) {
                    // Modo edición: Referencia al documento y updateDoc()
                    const docRef = doc(db, COLLECTION_NAME, data.id);
                    await updateDoc(docRef, cleanData);
                    showMessage("Solicitud actualizada con éxito.", "success");
                } else {
                    // Modo nuevo registro: addDoc()
                    await addDoc(foodRequestsRef, cleanData);
                    showMessage("Solicitud registrada con éxito.", "success");
                }
                
                await initializeAppLogic();
                resetForm();

            } catch (error) {
                showMessage(`Error al guardar la solicitud: ${error.message}`, 'error');
            }
        }

        async function deleteSingleRequest(id) {
            try {
                const docRef = doc(db, COLLECTION_NAME, id);
                await deleteDoc(docRef);
                showMessage("Solicitud eliminada con éxito.", "success");
                await initializeAppLogic();
            } catch (error) {
                showMessage(`Error al eliminar la solicitud: ${error.message}`, 'error');
            }
        }
        
        async function deleteMultipleRequests(ids) {
            try {
                const batch = writeBatch(db); // Función de SDK v9 para batch
                ids.forEach(id => {
                    const docRef = doc(db, COLLECTION_NAME, id);
                    batch.delete(docRef);
                });
                await batch.commit();
                showMessage(`Se eliminaron ${ids.length} solicitudes con éxito.`, "success");
                await initializeAppLogic();
            } catch (error) {
                showMessage(`Error al eliminar múltiples solicitudes: ${error.message}`, 'error');
            }
        }

        // -------------------------------------------------------------------------
        // === LÓGICA DE VISTA Y EVENTOS (MANTENIDA) ===
        // -------------------------------------------------------------------------

        // Función para renderizar la tabla (La lógica interna permanece igual)
        function renderTable() {
            const dataToRender = currentFilter 
                ? foodRequests.filter(req => req.department.toLowerCase().includes(currentFilter.toLowerCase()))
                : foodRequests;

            tableBody.innerHTML = '';

            if (dataToRender.length === 0) {
                noRequestsMessage.classList.remove('hidden');
                return;
            }
            noRequestsMessage.classList.add('hidden');

            dataToRender.forEach((request) => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-blue-50 transition duration-150';

                // Checkbox con data-id
                row.insertCell().innerHTML = `
                    <input type="checkbox" class="row-checkbox h-4 w-4 text-inter-primary rounded" data-id="${request.id}">
                `;

                // ... (Resto de celdas de la tabla) ...
                // Fecha de Entrega, Departamento, Tipo de Comida, Evento, etc. (mantener la lógica de tu archivo original)

                // Ejemplo de celdas (adaptar de tu código)
                row.insertCell().textContent = request.deliveryDateTime || 'N/A';
                row.insertCell().textContent = request.department;
                row.insertCell().textContent = request.mealType;
                row.insertCell().textContent = request.event || 'N/A';

                const externalStaffText = Object.keys(request.externalStaff || {})
                    .filter(key => request.externalStaff[key] > 0)
                    .map(key => `${key} (${request.externalStaff[key]})`)
                    .join(', ');
                row.insertCell().textContent = externalStaffText || 'N/A';
                row.insertCell().textContent = (request.interStaffSelected || []).join(', ');
                row.insertCell().className = 'text-right';
                row.insertCell().textContent = parseFloat(request.totalQuantity).toFixed(0);
                row.insertCell().textContent = request.deliveryPlace;
                row.insertCell().textContent = request.reason.length > 50 ? request.reason.substring(0, 47) + '...' : request.reason;
                row.insertCell().textContent = request.providerName;
                row.insertCell().className = 'text-right';
                row.insertCell().textContent = `$${parseFloat(request.unitCost).toFixed(2)}`;
                row.insertCell().className = 'text-right';
                row.insertCell().textContent = `$${parseFloat(request.deliveryCost).toFixed(2)}`;
                row.insertCell().className = 'text-right font-bold';
                row.insertCell().textContent = `$${parseFloat(request.cost).toFixed(2)}`;
                
                // Acciones (Usamos data-id)
                row.insertCell().innerHTML = `
                    <button onclick="window.startEditRequest('${request.id}')" class="text-inter-primary hover:text-blue-700 p-1 rounded transition duration-150" title="Editar Solicitud">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-4 9l4-4" />
                        </svg>
                    </button>
                    <button onclick="window.showDeleteModal('${request.id}')" class="text-red-500 hover:text-red-700 p-1 rounded transition duration-150" title="Eliminar Solicitud">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
            });
        }


        // Adaptar las funciones globales
        window.startEditRequest = function(id) {
            // ... (Tu lógica de edición, busca el ID en `foodRequests` y llena el formulario)
            const request = foodRequests.find(req => req.id === id);
            if (!request) return;
            // ... (Resto de la lógica de llenado de formulario y cambio de botones)
        };

        window.showDeleteModal = function(id) {
            confirmDeleteBtn.dataset.deleteId = id;
            modalText.textContent = `¿Estás seguro de que quieres eliminar la solicitud con ID ${id.substring(0, 6)}...? Esta acción no se puede deshacer.`;
            deleteModal.classList.remove('hidden');
            confirmDeleteBtn.onclick = handleSingleDelete;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            // ... (Recolección de datos del formulario)
            const newRequest = {
                id: editingRequestId,
                // ... (Resto de los campos del formulario)
            };
            await saveRequest(newRequest);
        }

        async function handleSingleDelete() {
            const id = confirmDeleteBtn.dataset.deleteId;
            deleteModal.classList.add('hidden');
            await deleteSingleRequest(id);
        }

        async function handleDeleteMultiple() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            const ids = selectedCheckboxes.map(cb => cb.dataset.id);

            deleteModal.classList.add('hidden');
            await deleteMultipleRequests(ids);
        }
        
        // Event Listeners principales
        form.addEventListener('submit', handleFormSubmit);
        deleteSelectedBtn.addEventListener('click', () => {
             const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length > 0) {
                modalText.textContent = `¿Estás seguro de que quieres eliminar ${selectedIds.length} solicitudes seleccionadas? Esta acción no se puede deshacer.`;
                confirmDeleteBtn.onclick = handleDeleteMultiple;
                deleteModal.classList.remove('hidden');
            } else {
                showMessage("Por favor, selecciona al menos una solicitud para eliminar.", "info");
            }
        });
        cancelDeleteBtn.addEventListener('click', () => { deleteModal.classList.add('hidden'); });

        // --- Inicio de la Aplicación ---
        async function initializeAppLogic() {
            await loadRequests(); 
            renderTable();
            // ... (Tu función updateSummaryTotals)
            // ... (Tu función updateCharts)
        }

        document.addEventListener('DOMContentLoaded', initializeAppLogic);

        // ... (Todas las funciones auxiliares de tu código original: resetForm, calculateTotalQuantity, calculateTotalCost, updateSummaryTotals, updateCharts, showMessage, etc. Deben estar aquí, pero no necesitan ser exportadas) ...

        // Nota: Asegúrate de que todas tus funciones auxiliares (como calculateTotalCost, updateSummaryTotals, etc.) estén definidas dentro de este bloque <script type="module">.
        
    </script>
</body>
</html>
